<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎭 narrativAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e );
            min-height: 100vh;
        }
        .genre-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .genre-card.selected {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }
        .genre-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }
        .weight-slider {
            accent-color: #8b5cf6;
        }
        .loading-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .generated-text {
            animation: fadeIn 0.8s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #narrativeTextEditor {
            scrollbar-width: thin;
            scrollbar-color: #8b5cf6 #374151;
        }
        
        #narrativeTextEditor::-webkit-scrollbar {
            width: 6px;
        }
        
        #narrativeTextEditor::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 3px;
        }
        
        #narrativeTextEditor::-webkit-scrollbar-thumb {
            background: #8b5cf6;
            border-radius: 3px;
        }
        
        #narrativeTextEditor::-webkit-scrollbar-thumb:hover {
            background: #a855f7;
        }
        
        #narrativeTextEditor:focus {
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3);
            border-radius: 4px;
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 bg-clip-text text-transparent mb-4">
                🎭 narrativAI
            </h1>
            <p class="text-xl text-gray-300 mb-2">
                📚 Narrativas específicas con elementos personalizados literales
            </p>
            <p class="text-lg text-purple-300 mb-4">
                🎬 Hasta 3 géneros balanceados + Imágenes épicas cinematográficas usando IA real
            </p>
            
            <!-- Banner conceptual -->
            <div class="max-w-4xl mx-auto mb-6 p-6 bg-gradient-to-r from-purple-900/30 to-pink-900/30 rounded-xl border border-purple-500/30">
                <div class="text-center">
                    <div class="text-6xl mb-4">🎭✨📚</div>
                    <p class="text-lg text-purple-200 mb-2">
                        <strong>Transforma elementos simples en narrativas épicas</strong>
                    </p>
                    <p class="text-md text-gray-300">
                        Elementos personalizados + Géneros balanceados + IA cinematográfica
                    </p>
                    <p class="text-sm text-purple-300 mt-2">
                        ⬇️ <em>Tus elementos cobran vida en historias únicas con imágenes épicas</em> ⬇️
                    </p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Panel de configuración -->
            <div class="space-y-6">
                <!-- Selección de géneros con límite -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4 flex items-center">
                        🎭 Selecciona géneros (máximo 3)
                        <span id="genreCount" class="ml-2 text-sm bg-purple-600 px-2 py-1 rounded-full">0/3</span>
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4" id="genreGrid">
                        <!-- Géneros se generan dinámicamente -->
                    </div>

                    <!-- Controles de peso para géneros seleccionados -->
                    <div id="weightControls" class="space-y-3 hidden">
                        <h4 class="text-md font-medium text-gray-300 border-t border-gray-600 pt-3">
                            ⚖️ Ajustar influencia de géneros
                        </h4>
                        <div id="weightSliders"></div>
                    </div>
                </div>

                <!-- Elementos personalizados mejorados -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4">
                        ✨ Elementos personalizados (aparecen literalmente)
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">
                                🎯 Elemento principal (foco de la historia)
                            </label>
                            <input type="text" id="element1" placeholder="ej: pececillo de plata" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">
                                🔸 Elemento secundario (apoyo narrativo)
                            </label>
                            <input type="text" id="element2" placeholder="ej: biblioteca gigantesca" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">
                                🏛️ Elemento de contexto (puede definir escenario)
                            </label>
                            <input type="text" id="element3" placeholder="ej: voluminoso y antiguo libro" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 text-white">
                        </div>
                    </div>
                </div>

                <!-- Configuración de IA para imágenes -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center space-x-3 mb-4">
                        <input type="checkbox" id="useImageAI" class="w-5 h-5 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                        <label for="useImageAI" class="text-lg font-semibold text-purple-400">
                            🎬 Generar imagen épica cinematográfica
                        </label>
                    </div>
                    
                    <div id="imageAIInfo" class="hidden mt-2 p-3 bg-blue-900/20 border border-blue-500/30 rounded text-sm text-blue-300">
                        🎬 <strong>Imagen épica generada con IA real:</strong> Se analizará tu texto narrativo para crear una imagen única<br />
                        <small class="opacity-80">🎭 La IA interpretará tu narrativa y elementos personalizados para generar la imagen perfecta</small>
                    </div>

                    <!-- Estilos visuales predeterminados -->
                    <div id="visualStylesSection" class="hidden mt-4">
                        <label for="visualStyle" class="block text-sm font-medium text-gray-300 mb-2">
                            🎨 Estilo visual predeterminado
                        </label>
                        <select id="visualStyle" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 text-white">
                            <option value="auto">Automático (basado en géneros)</option>
                            <option value="mignola-style">🎨 Estilo Mike Mignola (sombras dramáticas)</option>
                            <option value="toth-style">🎨 Estilo Alex Toth (líneas elegantes)</option>
                            <option value="sienkiewicz-style">🎨 Estilo Bill Sienkiewicz (expresionista)</option>
                            <option value="williams-style">🎨 Estilo J H Williams III (layouts innovadores)</option>
                            <option value="schuiten-style">🎨 Estilo François Schuiten (ligne claire)</option>
                            <option value="hogarth-style">🎨 Estilo Burne Hogarth (anatomía dinámica)</option>
                            <option value="wrightson-style">🎨 Estilo Bernie Wrightson (horror gótico)</option>
                            <option value="frazetta-style">🎨 Estilo Frank Frazetta (fantasía heroica)</option>
                            <option value="graphic-novel">Novela gráfica clásica</option>
                            <option value="photorealistic">Fotorrealista</option>
                            <option value="digital-art">Arte digital</option>
                            <option value="concept-art">Arte conceptual</option>
                            <option value="cinematic">Cinematográfico</option>
                            <option value="fantasy-art">Arte fantástico</option>
                            <option value="vintage-poster">Póster vintage</option>
                        </select>
                    </div>

                    <!-- Posados y acciones de portada -->
                    <div id="poseActionsSection" class="hidden mt-4">
                        <label for="poseAction" class="block text-sm font-medium text-gray-300 mb-2">
                            🎭 Posado/Acción de portada
                        </label>
                        <select id="poseAction" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 text-white">
                            <option value="auto">Automático (basado en narrativa)</option>
                            <option value="hero-stance">Postura heroica central</option>
                            <option value="discovery-moment">Momento de descubrimiento</option>
                            <option value="action-dynamic">Acción dinámica</option>
                            <option value="contemplative-gaze">Mirada contemplativa al horizonte</option>
                            <option value="confrontation">Confrontación dramática</option>
                            <option value="group-formation">Formación de grupo</option>
                            <option value="silhouette-dramatic">Silueta dramática</option>
                            <option value="embrace-romantic">Abrazo romántico</option>
                            <option value="mystery-investigation">Investigación misteriosa</option>
                            <option value="magical-casting">Conjuro mágico</option>
                            <option value="chase-escape">Persecución/Escape</option>
                            <option value="throne-power">Posición de poder</option>
                        </select>
                    </div>

                    <!-- Engine de imagen -->
                    <div id="imageEngineSection" class="hidden mt-4">
                        <label for="imageEngine" class="block text-sm font-medium text-gray-300 mb-2">
                            🚀 Engine de generación de imagen
                        </label>
                        <select id="imageEngine" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 text-white">
                            <option value="auto">🔄 Auto (selección inteligente según el estilo)</option>
                            <option value="pollinations-ai">🎨 Pollinations.ai (generación directa por URL)</option>
                            <!-- <option value="gpt-image-1">🎬 gpt-image-1 (rápido y confiable)</option> -->
                            <!-- <option value="seedimage-3">🎨 SeedImage 3.0 (alta calidad artística)</option> -->
                        </select>
                        <div class="mt-2 text-xs text-gray-400 space-y-1">
                            <div id="engineInfo" class="p-2 bg-gray-800/50 rounded border border-gray-600">
                                <p class="font-medium text-purple-300">🔄 Selección automática:</p>
                                <p>• Estilos de cómic maestros → Pollinations.ai</p>
                                <p>• Fotorrealista/Cinematográfico → Pollinations.ai</p>
                                <p>• Genera la mejor calidad según tu elección de estilo</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botón de generación -->
                <button id="generateBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                    <span id="generateBtnText">🎭 Generar Argumento Épico</span>
                </button>
            </div>

            <!-- Panel de resultados -->
            <div class="space-y-6">
                <!-- Argumento generado -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4">📖 Argumento Generado</h3>
                    
                    <div id="narrativePlaceholder" class="text-center text-gray-400 py-12">
                        <div class="text-4xl mb-3">📚</div>
                        <p>Selecciona géneros y elementos para generar tu narrativa épica</p>
                    </div>
                    
                    <div id="narrativeContent" class="hidden">
                        <div class="bg-gray-900/50 rounded-lg border-l-4 border-purple-500">
                            <!-- Área de texto editable -->
                            <div class="relative">
                                <textarea 
                                    id="narrativeTextEditor" 
                                    class="w-full min-h-48 p-4 bg-transparent text-gray-100 leading-relaxed resize-none border-none outline-none"
                                    placeholder="Tu narrativa editada aparecerá aquí..."
                                    style="font-family: inherit; line-height: 1.6;"
                                ></textarea>
                                <div class="absolute top-2 right-2 opacity-60 hover:opacity-100 transition-opacity">
                                    <span class="text-xs text-purple-300 bg-purple-900/50 px-2 py-1 rounded">
                                        ✏️ Editable
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 mt-4">
                            <button id="copyBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                📋 Copiar texto
                            </button>
                            <button id="exportBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                💾 Exportar ZIP
                            </button>
                            <button id="generateImageBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors text-sm hidden">
                                🎬 Generar Imagen del Texto Editado
                            </button>
                            <button id="regenerateNarrativeBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                🎭 Regenerar Narrativa
                            </button>
                        </div>
                    </div>
                    
                    <div id="loadingNarrative" class="hidden text-center py-8">
                        <div class="loading-animation text-4xl mb-3">🎭</div>
                        <p class="text-purple-300">Creando tu narrativa épica...</p>
                    </div>
                </div>

                <!-- Área de imagen generada -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4">🎬 Imagen Épica Cinematográfica</h3>
                    
                    <h4 class="text-md font-medium text-purple-300 mb-3">🎭 Tu imagen épica aparecerá aquí:</h4>
                        
                        <div id="imagePlaceholder" class="text-center text-gray-400 py-8 border-2 border-dashed border-gray-600 rounded-lg">
                            <div class="text-3xl mb-2">🖼️</div>
                            <p class="text-sm">Activa la generación de imágenes para ver tu escena épica personalizada</p>
                        </div>
                        
                        <img id="narrativeImage" class="hidden w-full rounded-lg shadow-xl border border-gray-600 hover:shadow-2xl transition-shadow duration-300" alt="Imagen épica generada">
                        
                        <div id="loadingImage" class="hidden text-center py-8 border-2 border-dashed border-purple-500 rounded-lg">
                            <div class="loading-animation text-3xl mb-2">🎬</div>
                            <p class="text-purple-300 text-sm">Generando tu imagen épica cinematográfica...</p>
                        </div>
                        
                        <div id="imageStatus" class="mt-3 p-2 bg-green-900/30 rounded border border-green-500/50 text-xs text-green-300 hidden">
                            <!-- Status se actualiza dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-12 text-center text-gray-400 text-sm">
            <p>
                ✨ Generador de Argumentos Narrativos - Narrativas específicas con elementos personalizados literales
            </p>
            <p class="mt-1">
                🎬 Hasta 3 géneros balanceados + Imágenes épicas cinematográficas de tus elementos en acción
            </p>
            <p class="mt-4 text-xs">
                🙏 Agradecimientos especiales a <a href="https://perchance.org" target="_blank" rel="noopener noreferrer" class="text-purple-400 hover:text-purple-300 transition-colors underline">Perchance.org</a> por su increíble plataforma de generación AI
            </p>
        </div>
    </div>

    <script type="module">
        // Estado de la aplicación
        let appState = {
            selectedGenres: [], // Array de objetos: { id, weight }
            customElements: '',
            generatedNarrative: '',
            generatedImageUrl: '',
            useImageAI: false,
            visualStyle: 'auto',
            poseAction: 'auto',
            imageEngine: 'auto', // Cambiado a 'auto' por defecto
            isGenerating: false,
            isGeneratingImage: false
        };

        // Definición de géneros disponibles
        const genres = {
            'terror': {
                name: 'Terror',
                icon: '👻',
                color: 'from-red-600 to-red-800'
            },
            'ciencia-ficcion': {
                name: 'Ciencia Ficción',
                icon: '🚀',
                color: 'from-blue-600 to-blue-800'
            },
            'fantasia': {
                name: 'Fantasía',
                icon: '🧙‍♂️',
                color: 'from-purple-600 to-purple-800'
            },
            'romance': {
                name: 'Romance',
                icon: '💕',
                color: 'from-pink-600 to-pink-800'
            },
            'misterio': {
                name: 'Misterio',
                icon: '🔍',
                color: 'from-yellow-600 to-yellow-800'
            },
            'aventura': {
                name: 'Aventura',
                icon: '⚔️',
                color: 'from-green-600 to-green-800'
            },
            'comedia': {
                name: 'Comedia',
                icon: '😄',
                color: 'from-orange-600 to-orange-800'
            },
            'drama': {
                name: 'Drama',
                icon: '🎭',
                color: 'from-indigo-600 to-indigo-800'
            }
        };

        // Crear elementos de género en el DOM
        const createGenreElements = ( ) => {
            const genreGrid = document.getElementById('genreGrid');
            
            Object.keys(genres).forEach(genreId => {
                const genre = genres[genreId];
                const genreCard = document.createElement('div');
                genreCard.className = `genre-card bg-gradient-to-br ${genre.color} p-4 rounded-lg cursor-pointer text-center`;
                genreCard.dataset.genreId = genreId;
                
                genreCard.innerHTML = `
                    <div class="text-2xl mb-2">${genre.icon}</div>
                    <div class="text-sm font-medium">${genre.name}</div>
                `;
                
                genreCard.addEventListener('click', () => {
                    toggleGenre(genreId);
                });
                
                genreGrid.appendChild(genreCard);
            });
        };

        // Alternar selección de género
        const toggleGenre = (genreId) => {
            const genreCard = document.querySelector(`[data-genre-id="${genreId}"]`);
            const isSelected = appState.selectedGenres.some(g => g.id === genreId);
            
            if (isSelected) {
                // Remover género
                appState.selectedGenres = appState.selectedGenres.filter(g => g.id !== genreId);
                genreCard.classList.remove('selected');
            } else {
                // Añadir género (máximo 3)
                if (appState.selectedGenres.length < 3) {
                    // Calcular redistribución proporcional para el nuevo género
                    const currentGenresCount = appState.selectedGenres.length;
                    
                    if (currentGenresCount === 0) {
                        // Primer género: 100%
                        appState.selectedGenres.push({
                            id: genreId,
                            weight: 100
                        });
                    } else {
                        // Reducir proporcionalmente los géneros existentes
                        const newGenreWeight = 100 / (currentGenresCount + 1);
                        const existingTotalWeight = 100 - newGenreWeight;
                        const scaleFactor = existingTotalWeight / 100;
                        
                        // Ajustar géneros existentes
                        appState.selectedGenres.forEach(genre => {
                            genre.weight = genre.weight * scaleFactor;
                        });
                        
                        // Añadir nuevo género
                        appState.selectedGenres.push({
                            id: genreId,
                            weight: newGenreWeight
                        });
                    }
                    
                    genreCard.classList.add('selected');
                } else {
                    alert('Máximo 3 géneros permitidos. Deselecciona uno primero.');
                    return;
                }
            }
            
            updateGenreCount();
            updateWeightControls();
        };

        // Redistribuir pesos para que sumen exactamente 100
        const redistributeWeights = () => {
            if (appState.selectedGenres.length === 0) return;
            
            const totalCurrent = appState.selectedGenres.reduce((sum, g) => sum + g.weight, 0);
            
            if (Math.abs(totalCurrent - 100) > 0.1) {
                // Si no hay pesos establecidos o la suma está muy desbalanceada
                if (totalCurrent === 0 || appState.selectedGenres.every(g => g.weight === 0)) {
                    // Distribución inicial equitativa
                    const equalWeight = 100 / appState.selectedGenres.length;
                    appState.selectedGenres.forEach(genre => {
                        genre.weight = equalWeight;
                    });
                } else {
                    // Normalizar manteniendo proporciones existentes
                    const scaleFactor = 100 / totalCurrent;
                    appState.selectedGenres.forEach(genre => {
                        genre.weight = genre.weight * scaleFactor;
                    });
                }
            }
        };

        // Redistribuir pesos cuando uno cambia (método fluido y proporcional)
        const redistributeWeightsFromChange = (changedIndex, newWeight) => {
            const oldWeight = appState.selectedGenres[changedIndex].weight;
            const weightDifference = newWeight - oldWeight;
            
            // Obtener otros géneros que no cambiaron
            const otherGenres = appState.selectedGenres.filter((_, index) => index !== changedIndex);
            
            if (otherGenres.length === 0) return;
            
            // Calcular el peso total actual de los otros géneros
            const totalOtherWeights = otherGenres.reduce((sum, genre) => sum + genre.weight, 0);
            
            if (totalOtherWeights === 0) {
                // Si todos los otros están en 0, distribuir equitativamente
                const remainingWeight = 100 - newWeight;
                const equalWeight = remainingWeight / otherGenres.length;
                
                appState.selectedGenres.forEach((genre, index) => {
                    if (index !== changedIndex) {
                        genre.weight = equalWeight;
                    }
                });
            } else {
                // Redistribuir proporcionalmente basado en pesos actuales
                const targetTotalOther = 100 - newWeight;
                const scaleFactor = targetTotalOther / totalOtherWeights;
                
                // Aplicar el factor de escala manteniendo proporciones
                appState.selectedGenres.forEach((genre, index) => {
                    if (index !== changedIndex) {
                        genre.weight = Math.max(5, genre.weight * scaleFactor);
                    }
                });
                
                // Ajuste fino para asegurar que sume exactamente 100
                const currentTotal = appState.selectedGenres.reduce((sum, g) => sum + g.weight, 0);
                if (Math.abs(currentTotal - 100) > 0.1) {
                    const adjustment = (100 - currentTotal) / otherGenres.length;
                    appState.selectedGenres.forEach((genre, index) => {
                        if (index !== changedIndex) {
                            genre.weight = Math.max(5, genre.weight + adjustment);
                        }
                    });
                }
            }
        };

        // Actualizar todas las visualizaciones de peso
        const updateAllWeightDisplays = () => {
            const sliders = document.querySelectorAll('.weight-slider');
            const percentages = document.querySelectorAll('.text-xs.text-gray-400');
            
            appState.selectedGenres.forEach((genre, index) => {
                if (sliders[index]) {
                    sliders[index].value = Math.round(genre.weight);
                }
                if (percentages[index]) {
                    percentages[index].textContent = `${Math.round(genre.weight)}%`;
                }
            });
            
            // Actualizar indicador total
            const totalIndicator = document.getElementById('totalWeightIndicator');
            if (totalIndicator) {
                const total = appState.selectedGenres.reduce((sum, g) => sum + g.weight, 0);
                totalIndicator.textContent = `Total: ${Math.round(total)}%`;
                totalIndicator.className = Math.abs(total - 100) < 0.1 ? 
                    'text-sm font-medium text-green-400' : 
                    'text-sm font-medium text-yellow-400';
            }
        };

        // Actualizar contador de géneros
        const updateGenreCount = () => {
