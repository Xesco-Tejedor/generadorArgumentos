<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ narrativAI - Perchance Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            min-height: 100vh;
        }
        .genre-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .genre-card.selected {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }
        .genre-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }
        .loading-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .control-group {
            background: rgba(31, 41, 55, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.5);
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 bg-clip-text text-transparent mb-4">
                üé≠ narrativAI
            </h1>
            <p class="text-xl text-gray-300 mb-2">
                üìö Narrativas √©picas con elementos personalizados + Im√°genes IA reales
            </p>
            <p class="text-lg text-purple-300 mb-4">
                üé¨ Hasta 3 g√©neros balanceados + Generaci√≥n Perchance.org (GitHub Pages compatible)
            </p>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- Panel de elementos y g√©neros -->
            <div class="space-y-6">
                <!-- Elementos personalizados -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4">
                        ‚ú® Elementos personalizados (aparecen literalmente)
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">
                                üéØ Elemento principal
                            </label>
                            <input type="text" id="element1" placeholder="ej: pececillo de plata" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">
                                üî∏ Elemento secundario
                            </label>
                            <input type="text" id="element2" placeholder="ej: biblioteca gigantesca" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">
                                üèõÔ∏è Elemento de contexto
                            </label>
                            <input type="text" id="element3" placeholder="ej: libro voluminoso y antiguo" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 text-white">
                        </div>
                    </div>
                </div>

                <!-- Selecci√≥n de g√©neros -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4 flex items-center">
                        üé≠ Selecciona g√©neros (m√°ximo 3)
                        <span id="genreCount" class="ml-2 text-sm bg-purple-600 px-2 py-1 rounded-full">0/3</span>
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4" id="genreGrid">
                        <!-- G√©neros se generan din√°micamente -->
                    </div>

                    <!-- Controles de intensidad de g√©neros -->
                    <div id="genreIntensityControls" class="hidden mt-4 space-y-3">
                        <h4 class="text-sm font-medium text-purple-300 mb-3">‚öñÔ∏è Intensidad de g√©neros seleccionados</h4>
                        <div id="genreSliders" class="space-y-3">
                            <!-- Sliders se generan din√°micamente -->
                        </div>
                        <div class="text-xs text-gray-400 mt-2">
                            ‚öñÔ∏è Los g√©neros siempre suman 100% - Al ajustar uno, los otros se rebalancean autom√°ticamente
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n de generaci√≥n -->
                <button id="generateBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                    <span id="generateBtnText">üé≠ Generar Narrativa √âpica</span>
                </button>
            </div>

            <!-- Panel de configuraci√≥n de imagen IA -->
            <div class="space-y-6">
                <!-- Control principal de imagen IA -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center space-x-3 mb-4">
                        <input type="checkbox" id="useImageAI" class="w-5 h-5 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                        <label for="useImageAI" class="text-lg font-semibold text-purple-400">
                            üé® Generar imagen IA real (Perchance.org)
                        </label>
                    </div>
                    
                    <div id="imageAIInfo" class="hidden mt-2 p-3 bg-blue-900/20 border border-blue-500/30 rounded text-sm text-blue-300">
                        üé® <strong>Imagen IA real:</strong> Se analizar√° tu narrativa para crear una imagen √∫nica usando Perchance.org<br />
                        <small class="opacity-80">‚úÖ 100% compatible con GitHub Pages - Generaci√≥n real garantizada</small>
                    </div>

                    <!-- Controles avanzados de imagen -->
                    <div id="imageControlsSection" class="hidden mt-4 space-y-4">
                        <!-- Dimensiones y orientaci√≥n -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">üìê Dimensiones y orientaci√≥n</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Ancho</label>
                                    <select id="imageWidth" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                        <option value="512">512px</option>
                                        <option value="768">768px</option>
                                        <option value="1024" selected>1024px</option>
                                        <option value="1280">1280px</option>
                                        <option value="1536">1536px</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Alto</label>
                                    <select id="imageHeight" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                        <option value="512">512px</option>
                                        <option value="768" selected>768px</option>
                                        <option value="1024">1024px</option>
                                        <option value="1280">1280px</option>
                                        <option value="1536">1536px</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-2 flex gap-2">
                                <button onclick="setAspectRatio(1024, 768)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs">4:3</button>
                                <button onclick="setAspectRatio(1024, 576)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs">16:9</button>
                                <button onclick="setAspectRatio(768, 1024)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs">3:4</button>
                                <button onclick="setAspectRatio(1024, 1024)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs">1:1</button>
                            </div>
                        </div>

                        <!-- Estilo art√≠stico -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">üé® Estilo art√≠stico</h4>
                            <select id="artStyle" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                <option value="auto">Autom√°tico (basado en narrativa)</option>
                                <option value="photorealistic">üì∏ Fotorrealista</option>
                                <option value="digital-art">üñ•Ô∏è Arte digital</option>
                                <option value="oil-painting">üé® Pintura al √≥leo</option>
                                <option value="watercolor">üåä Acuarela</option>
                                <option value="pencil-sketch">‚úèÔ∏è Boceto a l√°piz</option>
                                <option value="ink-drawing">üñãÔ∏è Dibujo a tinta</option>
                                <option value="comic-book">üìö Estilo c√≥mic</option>
                                <option value="anime">üáØüáµ Anime/manga</option>
                                <option value="fantasy-art">üßô‚Äç‚ôÇÔ∏è Arte fant√°stico</option>
                                <option value="sci-fi">üöÄ Ciencia ficci√≥n</option>
                                <option value="gothic">ü¶á G√≥tico</option>
                                <option value="horror">üò± Terror/Horror</option>
                                <option value="noir">üåë Film noir</option>
                                <option value="impressionist">üåÖ Impresionista</option>
                                <option value="surreal">üåÄ Surrealista</option>
                                <option value="expressionist">üé≠ Expresionista</option>
                                <option value="art-nouveau">üå∫ Art Nouveau</option>
                                <option value="baroque">üëë Barroco</option>
                                <option value="renaissance">üèõÔ∏è Renacentista</option>
                                <option value="mignola-style">üé≠ Estilo Mike Mignola</option>
                                <option value="frazetta-style">‚öîÔ∏è Estilo Frank Frazetta</option>
                                <option value="wrightson-style">üíÄ Estilo Bernie Wrightson</option>
                                <option value="moebius-style">üåå Estilo Moebius</option>
                                <option value="brom-style">üåô Estilo Gerald Brom</option>
                                <option value="bisley-style">üî• Estilo Simon Bisley</option>
                                <option value="burton-style">üé™ Estilo Tim Burton</option>
                                <option value="giger-style">üëæ Estilo H.R. Giger</option>
                                <option value="beksi≈Ñski-style">üåã Estilo Beksi≈Ñski</option>
                                <option value="vallejo-style">üó°Ô∏è Estilo Boris Vallejo</option>
                                <option value="bell-style">üßô‚Äç‚ôÄÔ∏è Estilo Julie Bell</option>
                                <option value="rackham-style">üßö Estilo Arthur Rackham</option>
                            </select>
                        </div>

                        <!-- Composici√≥n de imagen -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">üìê Composici√≥n de imagen</h4>
                            <select id="imageComposition" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                <option value="auto">Autom√°tica (basada en narrativa)</option>
                                <option value="centered">üéØ Centrada - Elemento principal en el centro</option>
                                <option value="rule-of-thirds">üìè Regla de tercios - Composici√≥n equilibrada</option>
                                <option value="close-up">üîç Primer plano - Enfoque cercano al sujeto</option>
                                <option value="medium-shot">üë§ Plano medio - Vista balanceada</option>
                                <option value="wide-shot">üåÖ Plano general - Vista amplia del escenario</option>
                                <option value="bird-eye">ü¶Ö Vista de p√°jaro - Desde arriba</option>
                                <option value="worm-eye">üêõ Vista de gusano - Desde abajo</option>
                                <option value="diagonal">üìê Diagonal - L√≠neas din√°micas</option>
                                <option value="symmetrical">‚öñÔ∏è Sim√©trica - Balance perfecto</option>
                                <option value="asymmetrical">üé≠ Asim√©trica - Balance din√°mico</option>
                                <option value="golden-ratio">üåü Proporci√≥n √°urea - Composici√≥n cl√°sica</option>
                            </select>
                        </div>

                        <!-- Estructura de escena -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">üèóÔ∏è Estructura de escena</h4>
                            <select id="sceneStructure" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                <option value="auto">Autom√°tica (basada en elementos)</option>
                                <option value="single-focus">üéØ Foco √∫nico - Un elemento principal</option>
                                <option value="multiple-elements">üé™ M√∫ltiples elementos - Varios puntos de inter√©s</option>
                                <option value="foreground-background">üé≠ Primer plano y fondo - Profundidad</option>
                                <option value="layered">üìö Por capas - M√∫ltiples niveles de profundidad</option>
                                <option value="environmental">üåç Ambiental - El entorno como protagonista</option>
                                <option value="character-focused">üë§ Enfoque en personaje - Protagonista destacado</option>
                                <option value="action-scene">‚ö° Escena de acci√≥n - Movimiento y dinamismo</option>
                                <option value="contemplative">üßò Contemplativa - Atm√≥sfera reflexiva</option>
                                <option value="dramatic">üé≠ Dram√°tica - Alta tensi√≥n emocional</option>
                                <option value="minimalist">‚ö™ Minimalista - Elementos esenciales</option>
                                <option value="complex">üîÄ Compleja - Rica en detalles</option>
                            </select>
                        </div>

                        <!-- Iluminaci√≥n y atm√≥sfera -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">üí° Iluminaci√≥n y atm√≥sfera</h4>
                            <select id="lighting" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                <option value="auto">Autom√°tica (basada en g√©nero)</option>
                                <option value="natural-daylight">‚òÄÔ∏è Luz natural diurna - Iluminaci√≥n clara</option>
                                <option value="golden-hour">üåÖ Hora dorada - Luz c√°lida y suave</option>
                                <option value="blue-hour">üåÜ Hora azul - Atm√≥sfera crepuscular</option>
                                <option value="dramatic-shadows">üåì Sombras dram√°ticas - Alto contraste</option>
                                <option value="soft-lighting">üí° Iluminaci√≥n suave - Ambiente tranquilo</option>
                                <option value="backlighting">üîÜ Contraluz - Siluetas y halos</option>
                                <option value="candle-fire">üïØÔ∏è Velas/fuego - Iluminaci√≥n c√°lida y danzante</option>
                                <option value="moonlight">üåô Luz de luna - Atm√≥sfera nocturna</option>
                                <option value="magical-glow">‚ú® Resplandor m√°gico - Iluminaci√≥n fant√°stica</option>
                                <option value="neon-cyberpunk">üåà Ne√≥n cyberpunk - Colores vibrantes</option>
                                <option value="mysterious-fog">üå´Ô∏è Niebla misteriosa - Atm√≥sfera enigm√°tica</option>
                            </select>
                        </div>

                        <!-- Modelo de IA -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">ü§ñ Modelo de IA</h4>
                            <select id="aiModel" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                <option value="standard" selected>Standard (equilibrado)</option>
                                <option value="artistic">Artistic (m√°s creativo)</option>
                                <option value="photogenic">Photogenic (m√°s realista)</option>
                                <option value="anime">Anime (estilo japon√©s)</option>
                                <option value="furry">Furry (personajes antropom√≥rficos)</option>
                            </select>
                        </div>

                        <!-- Configuraci√≥n avanzada -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">‚öôÔ∏è Configuraci√≥n avanzada</h4>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">
                                        Intensidad del prompt: <span id="promptStrengthValue">7</span>
                                    </label>
                                    <input type="range" id="promptStrength" min="1" max="10" value="7" 
                                           class="w-full accent-purple-500"
                                           oninput="document.getElementById('promptStrengthValue').textContent = this.value">
                                </div>

                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">
                                        Nivel de detalle: <span id="detailLevelValue">Medio</span>
                                    </label>
                                    <select id="detailLevel" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm"
                                            onchange="document.getElementById('detailLevelValue').textContent = this.options[this.selectedIndex].text">
                                        <option value="low">Bajo</option>
                                        <option value="medium" selected>Medio</option>
                                        <option value="high">Alto</option>
                                        <option value="ultra">Ultra detallado</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Semilla (seed) - para reproducibilidad</label>
                                    <div class="flex gap-2">
                                        <input type="number" id="imageSeed" placeholder="Autom√°tica" 
                                               class="flex-1 p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                        <button onclick="randomizeSeed()" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded text-xs">
                                            üé≤
                                        </button>
                                    </div>
                                </div>

                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="enhancePrompt" checked class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded">
                                    <label for="enhancePrompt" class="text-xs text-gray-400">
                                        ‚ú® Mejorar prompt autom√°ticamente
                                    </label>
                                </div>

                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="negativeSafety" checked class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded">
                                    <label for="negativeSafety" class="text-xs text-gray-400">
                                        üõ°Ô∏è Filtros de seguridad
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista previa del prompt -->
                <div id="promptPreview" class="hidden bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-purple-400">üëÅÔ∏è Vista previa del prompt</h3>
                        <div class="flex gap-2">
                            <button id="editPromptBtn" onclick="togglePromptEdit()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">
                                ‚úèÔ∏è Editar
                            </button>
                            <button id="savePromptBtn" onclick="savePromptEdit()" class="hidden px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-xs">
                                ‚úÖ Guardar
                            </button>
                            <button id="cancelPromptBtn" onclick="cancelPromptEdit()" class="hidden px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-xs">
                                ‚ùå Cancelar
                            </button>
                            <button id="resetPromptBtn" onclick="resetPromptToAuto()" class="px-3 py-1 bg-orange-600 hover:bg-orange-700 rounded text-xs">
                                üîÑ Auto
                            </button>
                        </div>
                    </div>
                    <div class="mb-2 px-3 py-1 bg-blue-900/30 border border-blue-500/50 rounded text-xs text-blue-300">
                        üåê Auto-traducido al ingl√©s para mejor calidad de imagen
                    </div>
                    <div id="promptDisplay" class="bg-gray-900/50 rounded-lg p-4 text-sm text-gray-300 font-mono leading-relaxed cursor-pointer hover:border hover:border-purple-500/50" onclick="togglePromptEdit()"></div>
                    <textarea id="promptEditor" class="hidden w-full h-32 p-4 bg-gray-900/50 border border-gray-600 rounded-lg text-sm text-gray-300 font-mono leading-relaxed resize-vertical focus:outline-none focus:border-purple-500" placeholder="Edita tu prompt aqu√≠..."></textarea>
                    <div id="promptStatus" class="mt-2 text-xs text-gray-400">
                        <span id="promptMode">ü§ñ Modo autom√°tico</span> ‚Ä¢ Clic para editar manualmente
                    </div>
                </div>
            </div>

            <!-- Panel de resultados -->
            <div class="space-y-6">
                <!-- Narrativa generada -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4">üìñ Narrativa Generada</h3>
                    
                    <div id="narrativePlaceholder" class="text-center text-gray-400 py-12">
                        <div class="text-4xl mb-3">üìö</div>
                        <p>Configura elementos y g√©neros para generar tu narrativa √©pica</p>
                    </div>
                    
                    <div id="narrativeContent" class="hidden">
                        <div class="bg-gray-900/50 rounded-lg border-l-4 border-purple-500 p-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm text-purple-300">üìù Narrativa (editable)</span>
                                <div class="flex gap-2">
                                    <button id="editNarrativeBtn" onclick="toggleNarrativeEdit()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <button id="saveNarrativeBtn" onclick="saveNarrativeEdit()" class="hidden px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-xs">
                                        ‚úÖ Guardar
                                    </button>
                                    <button id="cancelNarrativeBtn" onclick="cancelNarrativeEdit()" class="hidden px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-xs">
                                        ‚ùå Cancelar
                                    </button>
                                </div>
                            </div>
                            <div id="narrativeDisplay" class="text-gray-100 leading-relaxed"></div>
                            <textarea id="narrativeEditor" class="hidden w-full h-40 p-3 bg-gray-800 border border-gray-600 rounded text-gray-100 leading-relaxed resize-vertical focus:outline-none focus:border-purple-500" placeholder="Edita tu narrativa aqu√≠..."></textarea>
                        </div>
                    </div>
                    
                    <div id="loadingNarrative" class="hidden text-center py-8">
                        <div class="loading-animation text-4xl mb-3">üé≠</div>
                        <p class="text-purple-300">Creando tu narrativa √©pica...</p>
                    </div>
                </div>

                <!-- √Årea de im√°genes -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-purple-400">üé® Galer√≠a de Im√°genes IA</h3>
                        <button onclick="clearImageHistory()" id="clearHistoryBtn" class="hidden px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">
                            üóëÔ∏è Limpiar
                        </button>
                    </div>
                    
                    <div id="imagePlaceholder" class="text-center text-gray-400 py-8 border-2 border-dashed border-gray-600 rounded-lg">
                        <div class="text-3xl mb-2">üé®</div>
                        <div id="placeholderMessage">
                            <p class="text-sm">Activa la generaci√≥n de IA para crear im√°genes basadas en tu narrativa</p>
                            <p class="text-xs mt-1 opacity-75">‚úÖ Las im√°genes se acumular√°n en l√≠neas hasta cambiar el prompt</p>
                        </div>
                        <div id="readyMessage" class="hidden">
                            <p class="text-sm text-green-300">‚úÖ Imagen IA activada - Genera una narrativa para crear la imagen</p>
                            <p class="text-xs mt-1 opacity-75">üé≠ El sistema crear√° autom√°ticamente una imagen basada en tu historia</p>
                        </div>
                    </div>
                    
                    <div id="loadingImage" class="hidden text-center py-8 border-2 border-dashed border-purple-500 rounded-lg">
                        <div class="loading-animation text-3xl mb-2">üé®</div>
                        <p class="text-purple-300 text-sm">Generando imagen IA real...</p>
                        <p class="text-xs text-purple-400 mt-1">Analizando narrativa con Perchance.org</p>
                    </div>
                    
                    <!-- Galer√≠a de im√°genes -->
                    <div id="imageGallery" class="hidden space-y-4">
                        <!-- Las im√°genes se a√±adir√°n aqu√≠ din√°micamente -->
                    </div>
                    
                    <div id="imageStatus" class="mt-3 p-2 bg-green-900/30 rounded border border-green-500/50 text-xs text-green-300 hidden">
                        <!-- Status se actualiza din√°micamente -->
                    </div>

                    <!-- Controles principales del proyecto -->
                    <div class="mt-4 flex flex-wrap gap-2">
                        <button onclick="downloadCompleteProject()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                            üì¶ Descargar Proyecto (.zip)
                        </button>
                        <button onclick="handleGeneration()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                            üé≠ Regenerar Narrativa
                        </button>
                    </div>

                    <!-- Controles espec√≠ficos de imagen (solo cuando hay im√°genes) -->
                    <div id="imageControls" class="hidden mt-3 flex flex-wrap gap-2">
                        <button onclick="regenerateImage()" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm">
                            üîÑ Generar Variaci√≥n de Imagen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado de la aplicaci√≥n
        let appState = {
            selectedGenres: [],
            genreIntensities: {},
            generatedNarrative: '',
            useImageAI: false,
            currentImageUrl: '',
            currentImagePrompt: '',
            currentDisplayPrompt: '',
            isGenerating: false,
            imageHistory: [],
            currentPromptHash: null
        };

        // G√©neros disponibles
        const genres = {
            'terror': { name: 'Terror', icon: 'üëª', color: 'from-red-600 to-red-800' },
            'fantasia': { name: 'Fantas√≠a', icon: 'üßô‚Äç‚ôÇÔ∏è', color: 'from-purple-600 to-purple-800' },
            'romance': { name: 'Romance', icon: 'üíï', color: 'from-pink-600 to-pink-800' },
            'misterio': { name: 'Misterio', icon: 'üîç', color: 'from-yellow-600 to-yellow-800' },
            'ciencia-ficcion': { name: 'Ciencia Ficci√≥n', icon: 'üöÄ', color: 'from-blue-600 to-blue-800' },
            'aventura': { name: 'Aventura', icon: '‚öîÔ∏è', color: 'from-green-600 to-green-800' },
            'comedia': { name: 'Comedia', icon: 'üòÑ', color: 'from-orange-600 to-orange-800' },
            'drama': { name: 'Drama', icon: 'üé≠', color: 'from-indigo-600 to-indigo-800' }
        };

        // Variables para edici√≥n de narrativa
        let originalNarrativeText = '';
        let isEditingNarrative = false;

        // Variables para edici√≥n de prompt
        let originalPromptText = '';
        let isEditingPrompt = false;
        let isPromptManual = false;
        let manualPromptText = '';

        // Crear elementos de g√©nero
        function createGenreElements() {
            const genreGrid = document.getElementById('genreGrid');
            
            Object.keys(genres).forEach(genreId => {
                const genre = genres[genreId];
                const genreCard = document.createElement('div');
                genreCard.className = `genre-card bg-gradient-to-br ${genre.color} p-4 rounded-lg cursor-pointer text-center`;
                genreCard.dataset.genreId = genreId;
                
                genreCard.innerHTML = `
                    <div class="text-2xl mb-2">${genre.icon}</div>
                    <div class="text-sm font-medium">${genre.name}</div>
                `;
                
                genreCard.addEventListener('click', () => toggleGenre(genreId));
                genreGrid.appendChild(genreCard);
            });
        }

        // Alternar selecci√≥n de g√©nero
        function toggleGenre(genreId) {
            const genreCard = document.querySelector(`[data-genre-id="${genreId}"]`);
            const isSelected = appState.selectedGenres.includes(genreId);
            
            if (isSelected) {
                appState.selectedGenres = appState.selectedGenres.filter(g => g !== genreId);
                genreCard.classList.remove('selected');
                delete appState.genreIntensities[genreId];
            } else {
                if (appState.selectedGenres.length < 3) {
                    appState.selectedGenres.push(genreId);
                    genreCard.classList.add('selected');
                    appState.genreIntensities[genreId] = 70;
                } else {
                    alert('M√°ximo 3 g√©neros permitidos. Deselecciona uno primero.');
                    return;
                }
            }
            
            updateGenreCount();
            updateGenreIntensityControls();
            updatePromptPreview();
        }

        // Actualizar controles de intensidad de g√©neros
        function updateGenreIntensityControls() {
            const controlsSection = document.getElementById('genreIntensityControls');
            const slidersContainer = document.getElementById('genreSliders');
            
            if (appState.selectedGenres.length === 0) {
                controlsSection.classList.add('hidden');
                return;
            }
            
            controlsSection.classList.remove('hidden');
            slidersContainer.innerHTML = '';
            
            // Inicializar intensidades para que sumen 100
            initializeIntensitiesTo100();
            
            // Crear indicador de total
            const totalIndicatorHtml = `
                <div class="mb-3 p-2 bg-gray-900/50 rounded-lg border border-gray-600">
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-400">Total:</span>
                        <span id="totalIntensity" class="text-purple-300 font-semibold">100%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-1 mt-1">
                        <div id="totalBar" class="bg-purple-500 h-1 rounded-full transition-all duration-300" style="width: 100%"></div>
                    </div>
                </div>
            `;
            
            slidersContainer.innerHTML = totalIndicatorHtml;
            
            appState.selectedGenres.forEach(genreId => {
                const genre = genres[genreId];
                const intensity = appState.genreIntensities[genreId] || Math.floor(100 / appState.selectedGenres.length);
                
                const sliderHtml = `
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center space-x-2 min-w-0 flex-1">
                            <span class="text-lg">${genre.icon}</span>
                            <span class="text-sm text-gray-300 truncate">${genre.name}</span>
                        </div>
                        <div class="flex items-center space-x-2 min-w-0 flex-1">
                            <input type="range" 
                                   id="intensity-${genreId}" 
                                   min="1" 
                                   max="98" 
                                   value="${intensity}"
                                   class="flex-1 accent-purple-500"
                                   oninput="updateGenreIntensity('${genreId}', this.value)">
                            <span id="intensity-value-${genreId}" class="text-xs text-purple-300 min-w-[3rem] text-right">
                                ${intensity}%
                            </span>
                        </div>
                    </div>
                `;
                
                slidersContainer.innerHTML += sliderHtml;
            });
            
            updateTotalIndicator();
        }
        
        // Inicializar intensidades para que sumen exactamente 100
        function initializeIntensitiesTo100() {
            const numGenres = appState.selectedGenres.length;
            if (numGenres === 0) return;
            
            const baseValue = Math.floor(100 / numGenres);
            const remainder = 100 - (baseValue * numGenres);
            
            appState.selectedGenres.forEach((genreId, index) => {
                appState.genreIntensities[genreId] = baseValue + (index < remainder ? 1 : 0);
            });
        }
        
        // Actualizar indicador de total
        function updateTotalIndicator() {
            const total = appState.selectedGenres.reduce((sum, id) => sum + (appState.genreIntensities[id] || 0), 0);
            const totalSpan = document.getElementById('totalIntensity');
            const totalBar = document.getElementById('totalBar');
            
            if (totalSpan) {
                totalSpan.textContent = `${total}%`;
                totalSpan.className = total === 100 ? 'text-green-300 font-semibold' : 'text-yellow-300 font-semibold';
            }
            
            if (totalBar) {
                totalBar.style.width = `${Math.min(total, 100)}%`;
                totalBar.className = total === 100 ? 
                    'bg-green-500 h-1 rounded-full transition-all duration-300' : 
                    'bg-yellow-500 h-1 rounded-full transition-all duration-300';
            }
        }

        // Actualizar intensidad de g√©nero espec√≠fico manteniendo suma = 100
        window.updateGenreIntensity = function(genreId, value) {
            const newValue = parseInt(value);
            const oldValue = appState.genreIntensities[genreId] || 0;
            
            appState.genreIntensities[genreId] = newValue;
            
            const otherGenres = appState.selectedGenres.filter(id => id !== genreId);
            
            if (otherGenres.length > 0) {
                let otherTotal = otherGenres.reduce((sum, id) => sum + (appState.genreIntensities[id] || 0), 0);
                const targetOtherTotal = 100 - newValue;
                
                if (targetOtherTotal > 0 && otherTotal > 0) {
                    const ratio = targetOtherTotal / otherTotal;
                    
                    otherGenres.forEach(id => {
                        const currentValue = appState.genreIntensities[id] || 0;
                        const adjustedValue = Math.max(1, Math.round(currentValue * ratio));
                        appState.genreIntensities[id] = adjustedValue;
                        
                        const slider = document.getElementById(`intensity-${id}`);
                        const valueSpan = document.getElementById(`intensity-value-${id}`);
                        if (slider) slider.value = adjustedValue;
                        if (valueSpan) valueSpan.textContent = `${adjustedValue}%`;
                    });
                } else if (targetOtherTotal > 0) {
                    const equalValue = Math.floor(targetOtherTotal / otherGenres.length);
                    let remainder = targetOtherTotal - (equalValue * otherGenres.length);
                    
                    otherGenres.forEach((id, index) => {
                        const adjustedValue = equalValue + (index < remainder ? 1 : 0);
                        appState.genreIntensities[id] = adjustedValue;
                        
                        const slider = document.getElementById(`intensity-${id}`);
                        const valueSpan = document.getElementById(`intensity-value-${id}`);
                        if (slider) slider.value = adjustedValue;
                        if (valueSpan) valueSpan.textContent = `${adjustedValue}%`;
                    });
                }
            }
            
            const valueSpan = document.getElementById(`intensity-value-${genreId}`);
            if (valueSpan) {
                valueSpan.textContent = `${newValue}%`;
            }
            
            updateTotalIndicator();
            updatePromptPreview();
        };

        // Actualizar contador de g√©neros
        function updateGenreCount() {
            const genreCount = document.getElementById('genreCount');
            genreCount.textContent = `${appState.selectedGenres.length}/3`;
        }

        // Generar narrativa √©pica con intensidades
        function generateNarrative() {
            const element1 = document.getElementById('element1').value.trim();
            const element2 = document.getElementById('element2').value.trim();
            const element3 = document.getElementById('element3').value.trim();
            
            if (!element1 && !element2 && !element3) {
                throw new Error('Ingresa al menos un elemento personalizado.');
            }
            
            if (appState.selectedGenres.length === 0) {
                throw new Error('Selecciona al menos un g√©nero.');
            }
            
            const elements = [element1, element2, element3].filter(Boolean);
            const genreNames = appState.selectedGenres.map(id => genres[id].name);
            
            const dominantGenres = appState.selectedGenres
                .map(id => ({
                    id,
                    name: genreNames[appState.selectedGenres.indexOf(id)],
                    intensity: appState.genreIntensities[id] || 70
                }))
                .sort((a, b) => b.intensity - a.intensity);

            let narrativeStyle = '';
            if (dominantGenres[0]?.intensity > 85) {
                narrativeStyle = `Con una fuerte influencia de ${dominantGenres[0].name.toLowerCase()}, `;
            } else if (dominantGenres.length > 1 && dominantGenres[0]?.intensity > 70) {
                narrativeStyle = `Balanceando elementos de ${dominantGenres.map(g => g.name.toLowerCase()).join(' y ')}, `;
            }

            const narratives = [
                `${narrativeStyle}en las profundidades de ${element2 || 'un lugar misterioso'}, donde ${element3 || 'objetos antiguos'} guardan secretos milenarios, ${element1 || 'nuestro protagonista'} descubre que su destino est√° entrelazado con fuerzas m√°s all√° de su comprensi√≥n.`,

                `${narrativeStyle}cuando ${element1 || 'el protagonista'} se encuentra frente a ${element2 || 'lo desconocido'}, la presencia de ${element3 || 'elementos m√≠sticos'} revela verdades que cambiar√°n el curso de esta historia donde ${genreNames.join(' y ').toLowerCase()} se entrelazan.`,

                `Los elementos se entrelazan en una danza c√≥smica: ${elements.join(', ')} se convierten en las piezas fundamentales de una narrativa que ${narrativeStyle}trasciende los g√©neros de ${genreNames.join(', ')}, creando algo completamente nuevo y extraordinario.`,

                `En este universo donde ${genreNames.map(name => name.toLowerCase()).join(' se fusiona con ')} en perfecta armon√≠a, ${narrativeStyle}cada elemento cobra vida propia. ${element1 || 'El protagonista'} debe navegar entre ${element2 || 'm√∫ltiples realidades'} mientras ${element3 || 'fuerzas ancestrales'} despiertan para revelar los secretos m√°s profundos de la existencia.`
            ];
            
            return narratives.join('\n\n');
        }

        // Analizar texto narrativo para imagen
        function analyzeNarrativeForImage(narrative) {
            const lowerText = narrative.toLowerCase();
            let sceneElements = [];
            let mood = 'epic';
            
            if (lowerText.includes('library') || lowerText.includes('biblioteca')) sceneElements.push('ancient library');
            if (lowerText.includes('forest') || lowerText.includes('bosque')) sceneElements.push('mystical forest');
            if (lowerText.includes('castle') || lowerText.includes('castillo')) sceneElements.push('medieval castle');
            if (lowerText.includes('ocean') || lowerText.includes('sea') || lowerText.includes('oc√©ano') || lowerText.includes('mar')) sceneElements.push('vast ocean');
            if (lowerText.includes('mountain') || lowerText.includes('monta√±a')) sceneElements.push('towering mountains');
            if (lowerText.includes('city') || lowerText.includes('ciudad')) sceneElements.push('grand cityscape');
            if (lowerText.includes('temple') || lowerText.includes('templo')) sceneElements.push('sacred temple');
            if (lowerText.includes('cave') || lowerText.includes('cueva')) sceneElements.push('mysterious cave');
            if (lowerText.includes('tower') || lowerText.includes('torre')) sceneElements.push('ancient tower');
            if (lowerText.includes('palace') || lowerText.includes('palacio')) sceneElements.push('grand palace');
            if (lowerText.includes('village') || lowerText.includes('aldea') || lowerText.includes('pueblo')) sceneElements.push('medieval village');
            if (lowerText.includes('desert') || lowerText.includes('desierto')) sceneElements.push('vast desert');
            if (lowerText.includes('island') || lowerText.includes('isla')) sceneElements.push('mystical island');
            
            if (lowerText.includes('dark') || lowerText.includes('shadow') || lowerText.includes('oscur') || lowerText.includes('sombra')) mood = 'dark and mysterious';
            else if (lowerText.includes('magic') || lowerText.includes('mystical') || lowerText.includes('m√°gic') || lowerText.includes('m√≠stic')) mood = 'magical and enchanting';
            else if (lowerText.includes('romantic') || lowerText.includes('love') || lowerText.includes('rom√°ntic') || lowerText.includes('amor')) mood = 'romantic and warm';
            else if (lowerText.includes('epic') || lowerText.includes('legendary') || lowerText.includes('√©pic') || lowerText.includes('legendario')) mood = 'epic and grandiose';
            else if (lowerText.includes('horror') || lowerText.includes('terror') || lowerText.includes('frightening')) mood = 'horror and terrifying';
            else if (lowerText.includes('peaceful') || lowerText.includes('serene') || lowerText.includes('tranquil') || lowerText.includes('pac√≠fico')) mood = 'peaceful and serene';
            else if (lowerText.includes('adventure') || lowerText.includes('exciting') || lowerText.includes('aventura') || lowerText.includes('emocionante')) mood = 'adventurous and exciting';
            else if (lowerText.includes('dramatic') || lowerText.includes('intense') || lowerText.includes('dram√°tic') || lowerText.includes('intenso')) mood = 'dramatic and intense';
            
            return { sceneElements, mood };
        }

        // Traducir texto al ingl√©s de forma simple pero efectiva
        function translateToEnglish(text) {
            if (!text) return text;
            
            const translations = {
                // B√°sicos
                'y': 'and', 'o': 'or', 'en': 'in', 'el': 'the', 'la': 'the', 'los': 'the', 'las': 'the',
                'un': 'a', 'una': 'a', 'de': 'of', 'del': 'of the', 'al': 'to the', 'con': 'with',
                'sin': 'without', 'por': 'by', 'para': 'for', 'desde': 'from', 'hasta': 'until',
                
                // Narrativa
                'historia': 'story', 'narrativa': 'narrative', 'aventura': 'adventure', 'cuento': 'tale',
                'protagonista': 'protagonist', 'personaje': 'character', 'h√©roe': 'hero', 'hero√≠na': 'heroine',
                
                // Lugares
                'mundo': 'world', 'universo': 'universe', 'reino': 'kingdom', 'ciudad': 'city',
                'pueblo': 'town', 'aldea': 'village', 'casa': 'house', 'hogar': 'home', 'lugar': 'place',
                'castillo': 'castle', 'palacio': 'palace', 'torre': 'tower', 'fortaleza': 'fortress',
                'bosque': 'forest', 'selva': 'jungle', 'monta√±a': 'mountain', 'r√≠o': 'river',
                'lago': 'lake', 'mar': 'sea', 'oc√©ano': 'ocean', 'isla': 'island', 'desierto': 'desert',
                'cueva': 'cave', 'caverna': 'cavern', 'templo': 'temple', 'iglesia': 'church',
                'biblioteca': 'library', 'escuela': 'school', 'mercado': 'market', 'plaza': 'square',
                
                // Objetos
                'libro': 'book', 'pergamino': 'scroll', 'mapa': 'map', 'espada': 'sword',
                'escudo': 'shield', 'armadura': 'armor', 'anillo': 'ring', 'amuleto': 'amulet',
                'poci√≥n': 'potion', 'hechizo': 'spell', 'magia': 'magic', 'cristal': 'crystal',
                'oro': 'gold', 'plata': 'silver', 'cofre': 'chest', 'tesoro': 'treasure',
                
                // Criaturas
                'drag√≥n': 'dragon', 'mago': 'wizard', 'bruja': 'witch', 'hada': 'fairy',
                'duende': 'elf', 'gigante': 'giant', 'fantasma': 'ghost', 'demonio': 'demon',
                
                // Descriptivos
                'grande': 'big', 'peque√±o': 'small', 'enorme': 'huge', 'fuerte': 'strong',
                'd√©bil': 'weak', 'poderoso': 'powerful', 'hermoso': 'beautiful', 'm√°gico': 'magical',
                'm√≠stico': 'mystical', '√©pico': 'epic', 'legendario': 'legendary', 'misterioso': 'mysterious',
                'secreto': 'secret', 'oculto': 'hidden', 'oscuro': 'dark', 'brillante': 'bright',
                'antiguo': 'ancient', 'viejo': 'old', 'nuevo': 'new', 'sagrado': 'sacred',
                'divino': 'divine', 'maligno': 'evil', 'bondadoso': 'good', 'peligroso': 'dangerous',
                'seguro': 'safe', 'valiente': 'brave', 'sabio': 'wise',
                
                // Colores
                'rojo': 'red', 'azul': 'blue', 'verde': 'green', 'amarillo': 'yellow',
                'negro': 'black', 'blanco': 'white', 'gris': 'gray', 'morado': 'purple',
                
                // Tiempo
                'd√≠a': 'day', 'noche': 'night', 'ma√±ana': 'morning', 'tarde': 'afternoon',
                'sol': 'sun', 'luna': 'moon', 'estrella': 'star', 'lluvia': 'rain',
                
                // Frases espec√≠ficas
                'pececillo de plata': 'silverfish creature',
                'biblioteca gigantesca': 'gigantic library',
                'libro voluminoso': 'voluminous book',
                'fuerzas ancestrales': 'ancestral forces',
                'secretos milenarios': 'millennial secrets',
                'elementos m√≠sticos': 'mystical elements',
                'lugar misterioso': 'mysterious place',
                'm√∫ltiples realidades': 'multiple realities',
                'nuestro protagonista': 'our protagonist',
                'el protagonista': 'the protagonist'
            };
            
            let translatedText = text.toLowerCase();
            
            // Procesar frases complejas primero
            Object.keys(translations).forEach(spanish => {
                if (spanish.includes(' ')) {
                    const regex = new RegExp('\\b' + spanish.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
                    translatedText = translatedText.replace(regex, translations[spanish]);
                }
            });
            
            // Luego procesar palabras individuales
            Object.keys(translations).forEach(spanish => {
                if (!spanish.includes(' ')) {
                    const regex = new RegExp('\\b' + spanish.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
                    translatedText = translatedText.replace(regex, translations[spanish]);
                }
            });
            
            return translatedText.replace(/\s+/g, ' ').trim();
        }

        // Crear prompt para imagen IA
        function createImagePrompt(narrative, customElements) {
            // Traducir autom√°ticamente toda la narrativa y elementos personalizados
            const englishNarrative = translateToEnglish(narrative);
            const analysis = analyzeNarrativeForImage(englishNarrative);
            
            const artStyleElement = document.getElementById('artStyle');
            const detailLevelElement = document.getElementById('detailLevel');
            const enhancePromptElement = document.getElementById('enhancePrompt');
            const compositionElement = document.getElementById('imageComposition');
            const structureElement = document.getElementById('sceneStructure');
            const lightingElement = document.getElementById('lighting');
            
            const artStyle = artStyleElement ? artStyleElement.value : 'auto';
            const detailLevel = detailLevelElement ? detailLevelElement.value : 'medium';
            const enhancePrompt = enhancePromptElement ? enhancePromptElement.checked : true;
            const composition = compositionElement ? compositionElement.value : 'auto';
            const structure = structureElement ? structureElement.value : 'auto';
            const lighting = lightingElement ? lightingElement.value : 'auto';
            
            let promptParts = [];
            
            // Traducir autom√°ticamente todos los elementos personalizados
            if (customElements.length > 0) {
                customElements.forEach((element, index) => {
                    const translatedElement = translateToEnglish(element);
                    if (index === 0) {
                        promptParts.push(`${translatedElement} as main character`);
                    } else {
                        promptParts.push(`${translatedElement} in scene`);
                    }
                });
            }
            
            if (analysis.sceneElements.length > 0) {
                promptParts.push(`set in ${analysis.sceneElements.join(' and ')}`);
            }
            
            promptParts.push(`${analysis.mood} atmosphere`);
            
            const stylePrompts = {
                'photorealistic': 'photorealistic, highly detailed, professional photography',
                'digital-art': 'digital art, concept art style, highly detailed illustration',
                'oil-painting': 'oil painting, classical art style, rich textures',
                'watercolor': 'watercolor painting, soft colors, artistic brushstrokes',
                'pencil-sketch': 'pencil sketch, detailed drawing, artistic shading',
                'ink-drawing': 'ink drawing, black and white, detailed linework, crosshatching',
                'comic-book': 'comic book style, bold colors, dynamic composition',
                'anime': 'anime style, manga art, vibrant colors',
                'fantasy-art': 'fantasy art, magical realism, ethereal beauty',
                'sci-fi': 'science fiction art, futuristic, technology aesthetic',
                'gothic': 'gothic art style, dark atmosphere, dramatic shadows',
                'horror': 'horror art style, scary, macabre, dark and twisted',
                'noir': 'film noir style, black and white, high contrast, dramatic lighting',
                'impressionist': 'impressionist painting, soft brushstrokes, light and color',
                'surreal': 'surrealist art, dreamlike, bizarre, imaginative',
                'expressionist': 'expressionist art, emotional, distorted, intense colors',
                'art-nouveau': 'art nouveau style, organic forms, decorative, elegant',
                'baroque': 'baroque art style, ornate, dramatic, rich detail',
                'renaissance': 'renaissance art style, classical, balanced composition',
                'mignola-style': 'Mike Mignola style, bold shadows, minimal colors, geometric shapes',
                'frazetta-style': 'Frank Frazetta style, dynamic action, muscular figures, fantasy',
                'wrightson-style': 'Bernie Wrightson style, detailed ink work, horror atmosphere, crosshatching',
                'moebius-style': 'Moebius style, clean lines, sci-fi, detailed backgrounds',
                'brom-style': 'Gerald Brom style, dark fantasy, atmospheric, gothic beauty',
                'bisley-style': 'Simon Bisley style, painted texture, dynamic action, bold colors',
                'burton-style': 'Tim Burton style, gothic whimsy, elongated figures, dark fairy tale',
                'giger-style': 'H.R. Giger style, biomechanical, dark, surreal horror',
                'beksi≈Ñski-style': 'Zdzis≈Çaw Beksi≈Ñski style, nightmarish, surreal landscapes, dark fantasy',
                'vallejo-style': 'Boris Vallejo style, heroic fantasy, muscular figures, dramatic poses',
                'bell-style': 'Julie Bell style, fantasy art, strong figures, vibrant colors',
                'rackham-style': 'Arthur Rackham style, intricate pen and ink, watercolor washes, fairy tale illustration, whimsical and grotesque, sinuous lines, muted earth tones, ethereal fantasy, folklore atmosphere'
            };
            
            if (artStyle !== 'auto' && stylePrompts[artStyle]) {
                promptParts.push(stylePrompts[artStyle]);
            }
            
            const detailPrompts = {
                'low': 'simple, clean',
                'medium': 'detailed, well composed',
                'high': 'highly detailed, intricate',
                'ultra': 'ultra detailed, masterpiece quality, perfect composition'
            };
            
            promptParts.push(detailPrompts[detailLevel]);
            
            if (enhancePrompt) {
                promptParts.push('professional artwork, beautiful composition, dramatic lighting');
            }
            
            return promptParts.join(', ');
        }

        // Generar imagen usando API
        async function generatePerchanceImage(prompt) {
            const imageWidthElement = document.getElementById('imageWidth');
            const imageHeightElement = document.getElementById('imageHeight');
            const imageSeedElement = document.getElementById('imageSeed');
            
            const width = imageWidthElement ? imageWidthElement.value : '1024';
            const height = imageHeightElement ? imageHeightElement.value : '768';
            const seed = imageSeedElement ? (imageSeedElement.value || Math.floor(Math.random() * 1000000)) : Math.floor(Math.random() * 1000000);
            
            const imageAPIs = [
                {
                    name: 'Pollinations',
                    generateUrl: () => {
                        const cleanPrompt = prompt.replace(/[^a-zA-Z0-9\s,.-]/g, ' ').trim();
                        return `https://image.pollinations.ai/prompt/${encodeURIComponent(cleanPrompt)}?width=${width}&height=${height}&seed=${seed}&nologo=true`;
                    }
                },
                {
                    name: 'Placeholder',
                    generateUrl: () => `https://picsum.photos/${width}/${height}?random=${seed}`
                }
            ];
            
            for (let i = 0; i < imageAPIs.length; i++) {
                const api = imageAPIs[i];
                
                try {
                    const imageUrl = api.generateUrl();
                    
                    const result = await new Promise((resolve, reject) => {
                        const img = new Image();
                        const timeout = setTimeout(() => {
                            reject(new Error(`Timeout en ${api.name}`));
                        }, 15000);
                        
                        img.onload = () => {
                            clearTimeout(timeout);
                            resolve({
                                url: imageUrl,
                                prompt: prompt,
                                width: width,
                                height: height,
                                seed: seed,
                                api: api.name
                            });
                        };
                        
                        img.onerror = (error) => {
                            clearTimeout(timeout);
                            reject(new Error(`Error cargando imagen de ${api.name}`));
                        };
                        
                        img.src = imageUrl;
                    });
                    
                    return result;
                    
                } catch (error) {
                    if (i === imageAPIs.length - 1) {
                        throw error;
                    }
                }
            }
        }

        // Generar hash simple para comparar prompts
        function generatePromptHash(prompt) {
            let hash = 0;
            for (let i = 0; i < prompt.length; i++) {
                const char = prompt.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // Mostrar imagen generada en la galer√≠a
        function displayImage(imageResult) {
            const placeholder = document.getElementById('imagePlaceholder');
            const gallery = document.getElementById('imageGallery');
            const controls = document.getElementById('imageControls');
            const status = document.getElementById('imageStatus');
            const clearBtn = document.getElementById('clearHistoryBtn');
            
            appState.currentImageUrl = imageResult.url;
            appState.currentImagePrompt = imageResult.prompt;
            
            const promptHash = generatePromptHash(imageResult.prompt);
            const promptChanged = appState.currentPromptHash !== null && appState.currentPromptHash !== promptHash;
            
            if (promptChanged) {
                appState.imageHistory = [];
            }
            
            appState.currentPromptHash = promptHash;
            
            const imageData = {
                ...imageResult,
                timestamp: Date.now(),
                id: `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
            };
            
            appState.imageHistory.push(imageData);
            
            placeholder.classList.add('hidden');
            gallery.classList.remove('hidden');
            controls.classList.remove('hidden');
            clearBtn.classList.remove('hidden');
            
            renderImageGallery();
            
            status.innerHTML = `üé® Imagen ${appState.imageHistory.length} generada: ${imageResult.width}x${imageResult.height} | Seed: ${imageResult.seed} | API: ${imageResult.api}`;
            status.classList.remove('hidden');
        }

        // Renderizar galer√≠a de im√°genes
        function renderImageGallery() {
            const gallery = document.getElementById('imageGallery');
            
            if (appState.imageHistory.length === 0) {
                gallery.innerHTML = '';
                return;
            }
            
            const imagesPerRow = 3;
            let galleryHTML = '';
            
            const currentPrompt = appState.imageHistory[0]?.prompt || '';
            galleryHTML += `
                <div class="mb-4 p-3 bg-gray-900/50 rounded-lg border border-purple-500/30">
                    <h4 class="text-sm font-medium text-purple-300 mb-2">üìù Prompt actual (${appState.imageHistory.length} variaciones):</h4>
                    <p class="text-xs text-gray-300 font-mono leading-relaxed">${currentPrompt}</p>
                </div>
            `;
            
            for (let i = 0; i < appState.imageHistory.length; i += imagesPerRow) {
                const rowImages = appState.imageHistory.slice(i, i + imagesPerRow);
                
                galleryHTML += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-3">';
                
                rowImages.forEach((imageData, index) => {
                    const globalIndex = i + index;
                    galleryHTML += `
                        <div class="relative group">
                            <img src="${imageData.url}" 
                                 alt="Imagen IA ${globalIndex + 1}" 
                                 class="w-full h-32 object-cover rounded-lg border border-gray-600 transition-all duration-300 hover:border-purple-500 cursor-pointer"
                                 onclick="openImageModal('${imageData.id}')"
                                 onload="this.style.opacity='1'" 
                                 style="opacity:0;">
                            
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/70 transition-all duration-300 rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100">
                                <div class="text-center text-white">
                                    <p class="text-xs font-medium">#${globalIndex + 1}</p>
                                    <p class="text-xs">API: ${imageData.api}</p>
                                    <p class="text-xs">Seed: ${imageData.seed}</p>
                                    <div class="flex gap-1 mt-2">
                                        <button onclick="openImageModal('${imageData.id}')" class="px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-xs">
                                            üëÅÔ∏è
                                        </button>
                                        <button onclick="regenerateFromImage('${imageData.id}')" class="px-2 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs">
                                            üîÑ
                                        </button>
                                        <button onclick="removeImage('${imageData.id}')" class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">
                                            ‚ùå
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="absolute top-2 left-2 bg-black/70 backdrop-blur-sm rounded px-2 py-1">
                                <p class="text-xs text-green-300">#${globalIndex + 1}</p>
                            </div>
                            
                            <div class="absolute top-2 right-2 bg-black/70 backdrop-blur-sm rounded px-2 py-1">
                                <p class="text-xs text-blue-300">${imageData.api}</p>
                            </div>
                        </div>
                    `;
                });
                
                galleryHTML += '</div>';
            }
            
            gallery.innerHTML = galleryHTML;
        }

        // Actualizar vista previa del prompt (todo auto-traducido al ingl√©s)
        function updatePromptPreview() {
            if (!appState.useImageAI) return;
            
            const narrative = appState.generatedNarrative;
            if (!narrative) return;
            
            const promptDisplay = document.getElementById('promptDisplay');
            const promptPreview = document.getElementById('promptPreview');
            const promptMode = document.getElementById('promptMode');
            
            let finalPrompt;
            
            if (isPromptManual && manualPromptText.trim() !== '') {
                // Usar prompt manual
                finalPrompt = manualPromptText.trim();
                if (promptMode) {
                    promptMode.textContent = '‚úèÔ∏è Modo manual';
                }
            } else {
                // Generar prompt autom√°tico
                const element1 = document.getElementById('element1');
                const element2 = document.getElementById('element2');
                const element3 = document.getElementById('element3');
                
                const customElements = [
                    element1 ? element1.value.trim() : '',
                    element2 ? element2.value.trim() : '',
                    element3 ? element3.value.trim() : ''
                ].filter(Boolean);
                
                finalPrompt = createImagePrompt(narrative, customElements);
                if (promptMode) {
                    promptMode.textContent = 'ü§ñ Modo autom√°tico';
                }
            }
            
            if (promptDisplay) {
                promptDisplay.textContent = finalPrompt;
            }
            
            if (promptPreview) {
                promptPreview.classList.remove('hidden');
            }
            
            // Almacenar el prompt actual para uso en generaci√≥n de im√°genes
            appState.currentDisplayPrompt = finalPrompt;
        }

        // Manejar generaci√≥n principal
        async function handleGeneration() {
            if (appState.isGenerating) return;
            
            const generateBtn = document.getElementById('generateBtn');
            const generateBtnText = document.getElementById('generateBtnText');
            const loadingNarrative = document.getElementById('loadingNarrative');
            const narrativePlaceholder = document.getElementById('narrativePlaceholder');
            const narrativeContent = document.getElementById('narrativeContent');
            
            try {
                appState.isGenerating = true;
                generateBtn.disabled = true;
                generateBtnText.textContent = 'üé≠ Generando...';
                loadingNarrative.classList.remove('hidden');
                narrativePlaceholder.classList.add('hidden');
                narrativeContent.classList.add('hidden');
                
                const imageAICheckbox = document.getElementById('useImageAI');
                appState.useImageAI = imageAICheckbox.checked;
                
                const placeholderMessage = document.getElementById('placeholderMessage');
                const readyMessage = document.getElementById('readyMessage');
                
                if (appState.useImageAI) {
                    if (placeholderMessage) placeholderMessage.classList.add('hidden');
                    if (readyMessage) readyMessage.classList.remove('hidden');
                } else {
                    if (placeholderMessage) placeholderMessage.classList.remove('hidden');
                    if (readyMessage) readyMessage.classList.add('hidden');
                }
                
                const narrative = generateNarrative();
                appState.generatedNarrative = narrative;
                
                await new Promise(resolve => setTimeout(resolve, 1500));
                loadingNarrative.classList.add('hidden');
                
                const narrativeDisplay = document.getElementById('narrativeDisplay');
                if (narrativeDisplay) {
                    narrativeDisplay.innerHTML = narrative.replace(/\n/g, '<br><br>');
                }
                
                narrativeContent.classList.remove('hidden');
                updatePromptPreview();
                
                if (appState.useImageAI) {
                    const loadingImage = document.getElementById('loadingImage');
                    const imagePlaceholder = document.getElementById('imagePlaceholder');
                    const gallery = document.getElementById('imageGallery');
                    
                    const showInGallery = appState.imageHistory.length > 0;
                    
                    if (!showInGallery) {
                        imagePlaceholder.classList.add('hidden');
                    } else {
                        gallery.classList.remove('hidden');
                    }
                    
                    loadingImage.classList.remove('hidden');
                    
                    try {
                        // Obtener elementos personalizados y traducir autom√°ticamente
                        const customElements = [
                            document.getElementById('element1')?.value?.trim() || '',
                            document.getElementById('element2')?.value?.trim() || '',
                            document.getElementById('element3')?.value?.trim() || ''
                        ].filter(Boolean);
                        
                        // Usar prompt editado o crear autom√°ticamente
                        const imagePrompt = appState.currentDisplayPrompt || createImagePrompt(narrative, customElements);
                        const imageResult = await generatePerchanceImage(imagePrompt);
                        
                        loadingImage.classList.add('hidden');
                        displayImage(imageResult);
                        
                    } catch (error) {
                        console.error('Error generando imagen:', error);
                        loadingImage.classList.add('hidden');
                        
                        if (!showInGallery) {
                            imagePlaceholder.classList.remove('hidden');
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error en la generaci√≥n:', error);
                alert('Error: ' + error.message);
                loadingNarrative.classList.add('hidden');
                narrativePlaceholder.classList.remove('hidden');
            } finally {
                appState.isGenerating = false;
                generateBtn.disabled = false;
                generateBtnText.textContent = 'üé≠ Generar Narrativa √âpica';
            }
        }

        // Funciones globales para controles
        window.setAspectRatio = function(width, height) {
            document.getElementById('imageWidth').value = width;
            document.getElementById('imageHeight').value = height;
            updatePromptPreview();
        };

        window.randomizeSeed = function() {
            const randomSeed = Math.floor(Math.random() * 1000000);
            document.getElementById('imageSeed').value = randomSeed;
        };

        window.regenerateImage = async function() {
            if (!appState.generatedNarrative) {
                alert('Genera una narrativa primero.');
                return;
            }
            
            const loadingImage = document.getElementById('loadingImage');
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            
            const showInGallery = appState.imageHistory.length > 0;
            if (!showInGallery) {
                imagePlaceholder.classList.add('hidden');
            }
            loadingImage.classList.remove('hidden');
            
            try {
                let imagePrompt;
                
                if (appState.currentImagePrompt) {
                    imagePrompt = appState.currentImagePrompt;
                } else {
                    // Obtener elementos y traducir autom√°ticamente
                    const customElements = [
                        document.getElementById('element1')?.value?.trim() || '',
                        document.getElementById('element2')?.value?.trim() || '',
                        document.getElementById('element3')?.value?.trim() || ''
                    ].filter(Boolean);
                    
                    // Usar prompt editado o crear autom√°ticamente
                    imagePrompt = appState.currentDisplayPrompt || createImagePrompt(appState.generatedNarrative, customElements);
                }
                
                const imageResult = await generatePerchanceImage(imagePrompt);
                
                loadingImage.classList.add('hidden');
                displayImage(imageResult);
                
            } catch (error) {
                console.error('Error regenerando imagen:', error);
                loadingImage.classList.add('hidden');
                
                if (!showInGallery) {
                    imagePlaceholder.classList.remove('hidden');
                }
                
                alert('Error regenerando imagen: ' + error.message);
            }
        };

        window.clearImageHistory = function() {
            if (confirm('¬øSeguro que quieres limpiar toda la galer√≠a de im√°genes?')) {
                appState.imageHistory = [];
                appState.currentPromptHash = null;
                
                const gallery = document.getElementById('imageGallery');
                const placeholder = document.getElementById('imagePlaceholder');
                const controls = document.getElementById('imageControls');
                const clearBtn = document.getElementById('clearHistoryBtn');
                const status = document.getElementById('imageStatus');
                
                gallery.classList.add('hidden');
                placeholder.classList.remove('hidden');
                controls.classList.add('hidden');
                clearBtn.classList.add('hidden');
                status.classList.add('hidden');
            }
        };

        window.openImageModal = function(imageId) {
            const imageData = appState.imageHistory.find(img => img.id === imageId);
            if (!imageData) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            modal.onclick = () => document.body.removeChild(modal);
            
            modal.innerHTML = `
                <div class="max-w-4xl max-h-full bg-gray-800 rounded-lg overflow-hidden" onclick="event.stopPropagation()">
                    <div class="p-4 border-b border-gray-600">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-purple-400">üé® Imagen IA - Detalles</h3>
                            <button onclick="document.body.removeChild(document.querySelector('.fixed'))" class="text-gray-400 hover:text-white">‚úï</button>
                        </div>
                    </div>
                    <div class="p-4">
                        <img src="${imageData.url}" alt="Imagen IA" class="w-full rounded-lg mb-4">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-purple-300 font-medium">Dimensiones:</p>
                                <p class="text-gray-300">${imageData.width}x${imageData.height}</p>
                            </div>
                            <div>
                                <p class="text-purple-300 font-medium">API:</p>
                                <p class="text-gray-300">${imageData.api}</p>
                            </div>
                            <div>
                                <p class="text-purple-300 font-medium">Seed:</p>
                                <p class="text-gray-300">${imageData.seed}</p>
                            </div>
                            <div>
                                <p class="text-purple-300 font-medium">Generado:</p>
                                <p class="text-gray-300">${new Date(imageData.timestamp).toLocaleString('es-ES')}</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-purple-300 font-medium mb-2">Prompt:</p>
                            <p class="text-gray-300 text-xs font-mono bg-gray-900/50 p-3 rounded leading-relaxed">${imageData.prompt}</p>
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="regenerateFromImage('${imageData.id}')" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm">
                                üîÑ Crear Variaci√≥n
                            </button>
                            <button onclick="downloadCompleteProject()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-sm">
                                üì¶ Descargar Proyecto
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };

        window.removeImage = function(imageId) {
            if (confirm('¬øEliminar esta imagen de la galer√≠a?')) {
                appState.imageHistory = appState.imageHistory.filter(img => img.id !== imageId);
                
                if (appState.imageHistory.length === 0) {
                    clearImageHistory();
                } else {
                    renderImageGallery();
                }
            }
        };

        window.regenerateFromImage = async function(imageId) {
            const imageData = appState.imageHistory.find(img => img.id === imageId);
            if (!imageData) return;
            
            appState.currentImagePrompt = imageData.prompt;
            
            const modal = document.querySelector('.fixed');
            if (modal) document.body.removeChild(modal);
            
            await regenerateImage();
        };

        // Funci√≥n para convertir imagen a blob JPG
        async function convertImageToJPG(imageUrl, filename) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        
                        canvas.toBlob(function(blob) {
                            resolve({ blob, filename });
                        }, 'image/jpeg', 0.95);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                img.onerror = function() {
                    fetch(imageUrl)
                        .then(response => response.blob())
                        .then(blob => resolve({ blob, filename }))
                        .catch(reject);
                };
                
                img.src = imageUrl;
            });
        }

        // Funci√≥n principal para descargar proyecto completo
        window.downloadCompleteProject = async function() {
            if (!appState.generatedNarrative) {
                alert('Genera una narrativa primero para descargar el proyecto.');
                return;
            }
            
            const downloadBtn = document.querySelector('[onclick="downloadCompleteProject()"]') || 
                               document.getElementById('downloadZipBtn');
            
            let originalText = 'üì¶ Descargar Proyecto (.zip)';
            
            if (downloadBtn) {
                originalText = downloadBtn.textContent;
                downloadBtn.textContent = 'üì¶ Creando ZIP...';
                downloadBtn.disabled = true;
            }
            
            try {
                const zip = new JSZip();
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');
                
                const markdownContent = generateMarkdownContent();
                zip.file('narrativa.md', markdownContent);
                
                if (appState.imageHistory.length > 0) {
                    const imagePromises = appState.imageHistory.map(async (imageData, index) => {
                        try {
                            const filename = 'imagen-' + String(index + 1).padStart(2, '0') + '.jpg';
                            const result = await convertImageToJPG(imageData.url, filename);
                            zip.file(filename, result.blob);
                            return true;
                        } catch (error) {
                            console.warn('Error a√±adiendo imagen:', error);
                            return false;
                        }
                    });
                    
                    await Promise.all(imagePromises);
                }
                
                const readmeContent = generateReadmeContent();
                zip.file('README.txt', readmeContent);
                
                const zipBlob = await zip.generateAsync({ 
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });
                
                const url = URL.createObjectURL(zipBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'narrativAI-proyecto-' + timestamp + '.zip';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('Error creando proyecto ZIP:', error);
                alert('Error creando el archivo ZIP: ' + error.message);
            } finally {
                if (downloadBtn) {
                    downloadBtn.textContent = originalText;
                    downloadBtn.disabled = false;
                }
            }
        };

        // Generar contenido Markdown
        function generateMarkdownContent() {
            const element1 = document.getElementById('element1');
            const element2 = document.getElementById('element2');
            const element3 = document.getElementById('element3');
            
            const customElements = [
                element1 ? element1.value || 'No especificado' : 'No especificado',
                element2 ? element2.value || 'No especificado' : 'No especificado',
                element3 ? element3.value || 'No especificado' : 'No especificado'
            ];
            
            let markdownContent = '# üé≠ Narrativa √âpica - narrativAI\n\n';
            markdownContent += '**Proyecto generado el:** ' + new Date().toLocaleString('es-ES') + '\n\n';
            markdownContent += '## üìñ Tu Historia √âpica\n\n';
            markdownContent += appState.generatedNarrative + '\n\n';
            
            if (originalNarrativeText && originalNarrativeText !== appState.generatedNarrative) {
                markdownContent += '*üìù Nota: Esta narrativa fue editada manualmente despu√©s de la generaci√≥n inicial.*\n\n';
            }
            
            markdownContent += '## ‚öñÔ∏è Configuraci√≥n de G√©neros\n\n';
            markdownContent += '**G√©neros seleccionados:** ' + appState.selectedGenres.map(id => genres[id].icon + ' ' + genres[id].name + ' (' + (appState.genreIntensities[id] || 70) + '%)').join(', ') + '\n\n';
            markdownContent += '## üéØ Elementos Personalizados\n\n';
            markdownContent += '- **üéØ Principal:** ' + customElements[0] + '\n';
            markdownContent += '- **üî∏ Secundario:** ' + customElements[1] + '\n';
            markdownContent += '- **üèõÔ∏è Contexto:** ' + customElements[2] + '\n\n';
            
            if (appState.currentImagePrompt) {
                markdownContent += '## üé® Configuraci√≥n de Imagen IA\n\n';
                markdownContent += '**Total de im√°genes generadas:** ' + appState.imageHistory.length + '\n\n';
                markdownContent += '**Prompt utilizado:**\n```\n' + appState.currentImagePrompt + '\n```\n\n';
                markdownContent += '**Im√°genes incluidas:**\n';
                markdownContent += appState.imageHistory.map((img, index) => '- imagen-' + String(index + 1).padStart(2, '0') + '.jpg (' + img.width + 'x' + img.height + ', API: ' + img.api + ', Seed: ' + img.seed + ')').join('\n');
            } else {
                markdownContent += '## üé® Configuraci√≥n de Imagen IA\n\nNo se generaron im√°genes para este proyecto.';
            }
            
            markdownContent += '\n\n---\n\n*Generado con ‚ù§Ô∏è por **narrativAI*** üé≠‚ú®';
            
            return markdownContent;
        }

        // Generar contenido README
        function generateReadmeContent() {
            let readmeContent = 'üì¶ PROYECTO NARRATIVAI - INFORMACI√ìN\n';
            readmeContent += '=====================================\n\n';
            readmeContent += 'üé≠ Contenido del proyecto:\n';
            readmeContent += '- narrativa.md: Historia √©pica generada con configuraci√≥n completa\n';
            readmeContent += appState.imageHistory.length > 0 ? '- imagen-01.jpg a imagen-' + String(appState.imageHistory.length).padStart(2, '0') + '.jpg: Im√°genes IA generadas\n' : '- No se incluyeron im√°genes\n';
            readmeContent += '- README.txt: Este archivo con informaci√≥n del proyecto\n\n';
            readmeContent += 'üìä Estad√≠sticas:\n';
            readmeContent += '- Narrativa: ' + (appState.generatedNarrative ? 'Incluida' : 'No generada') + '\n';
            readmeContent += '- G√©neros: ' + appState.selectedGenres.length + '/3 seleccionados\n';
            readmeContent += '- Elementos personalizados: 3 configurados\n';
            readmeContent += '- Im√°genes IA: ' + appState.imageHistory.length + ' generadas\n';
            readmeContent += '- Fecha de creaci√≥n: ' + new Date().toLocaleString('es-ES') + '\n\n';
            readmeContent += 'üîß Configuraci√≥n utilizada:\n';
            readmeContent += '- G√©neros: ' + appState.selectedGenres.map(id => genres[id].name).join(', ') + '\n';
            readmeContent += '- Imagen IA: ' + (appState.useImageAI ? 'Activada' : 'Desactivada') + '\n';
            if (appState.currentImagePrompt) {
                readmeContent += '- Prompt de imagen: "' + appState.currentImagePrompt.substring(0, 100) + '..."\n';
            }
            readmeContent += '\nüé® Herramienta: narrativAI (GitHub Pages Edition)\n';
            readmeContent += '‚ú® Proyecto exportado autom√°ticamente\n\n';
            readmeContent += '¬°Gracias por usar narrativAI! üé≠\n';
            
            return readmeContent;
        }

        // Funci√≥n para activar/desactivar modo de edici√≥n
        window.toggleNarrativeEdit = function() {
            const narrativeDisplay = document.getElementById('narrativeDisplay');
            const narrativeEditor = document.getElementById('narrativeEditor');
            const editBtn = document.getElementById('editNarrativeBtn');
            const saveBtn = document.getElementById('saveNarrativeBtn');
            const cancelBtn = document.getElementById('cancelNarrativeBtn');
            
            if (!isEditingNarrative) {
                isEditingNarrative = true;
                originalNarrativeText = appState.generatedNarrative;
                
                narrativeDisplay.classList.add('hidden');
                narrativeEditor.classList.remove('hidden');
                narrativeEditor.value = appState.generatedNarrative;
                narrativeEditor.focus();
                
                editBtn.classList.add('hidden');
                saveBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
            }
        };

        // Funci√≥n para guardar cambios
        window.saveNarrativeEdit = function() {
            const narrativeDisplay = document.getElementById('narrativeDisplay');
            const narrativeEditor = document.getElementById('narrativeEditor');
            const editBtn = document.getElementById('editNarrativeBtn');
            const saveBtn = document.getElementById('saveNarrativeBtn');
            const cancelBtn = document.getElementById('cancelNarrativeBtn');
            
            if (isEditingNarrative) {
                const newText = narrativeEditor.value.trim();
                
                if (newText === '') {
                    alert('La narrativa no puede estar vac√≠a.');
                    return;
                }
                
                appState.generatedNarrative = newText;
                narrativeDisplay.innerHTML = newText.replace(/\n/g, '<br><br>');
                
                narrativeDisplay.classList.remove('hidden');
                narrativeEditor.classList.add('hidden');
                
                editBtn.classList.remove('hidden');
                saveBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');
                
                isEditingNarrative = false;
                
                if (appState.useImageAI) {
                    updatePromptPreview();
                }
            }
        };

        // Funci√≥n para cancelar edici√≥n
        window.cancelNarrativeEdit = function() {
            const narrativeDisplay = document.getElementById('narrativeDisplay');
            const narrativeEditor = document.getElementById('narrativeEditor');
            const editBtn = document.getElementById('editNarrativeBtn');
            const saveBtn = document.getElementById('saveNarrativeBtn');
            const cancelBtn = document.getElementById('cancelNarrativeBtn');
            
            if (isEditingNarrative) {
                narrativeEditor.value = originalNarrativeText;
                
                narrativeDisplay.classList.remove('hidden');
                narrativeEditor.classList.add('hidden');
                
                editBtn.classList.remove('hidden');
                saveBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');
                
                isEditingNarrative = false;
            }
        };

        // Funciones para edici√≥n de prompt
        window.togglePromptEdit = function() {
            const promptDisplay = document.getElementById('promptDisplay');
            const promptEditor = document.getElementById('promptEditor');
            const editBtn = document.getElementById('editPromptBtn');
            const saveBtn = document.getElementById('savePromptBtn');
            const cancelBtn = document.getElementById('cancelPromptBtn');
            
            if (!isEditingPrompt) {
                isEditingPrompt = true;
                originalPromptText = promptDisplay.textContent || '';
                
                promptDisplay.classList.add('hidden');
                promptEditor.classList.remove('hidden');
                promptEditor.value = originalPromptText;
                promptEditor.focus();
                
                editBtn.classList.add('hidden');
                saveBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
            }
        };

        window.savePromptEdit = function() {
            const promptDisplay = document.getElementById('promptDisplay');
            const promptEditor = document.getElementById('promptEditor');
            const editBtn = document.getElementById('editPromptBtn');
            const saveBtn = document.getElementById('savePromptBtn');
            const cancelBtn = document.getElementById('cancelPromptBtn');
            const promptMode = document.getElementById('promptMode');
            
            if (isEditingPrompt) {
                const newPrompt = promptEditor.value.trim();
                
                if (newPrompt === '') {
                    alert('El prompt no puede estar vac√≠o.');
                    return;
                }
                
                // Marcar como manual y guardar
                isPromptManual = true;
                manualPromptText = newPrompt;
                
                promptDisplay.textContent = newPrompt;
                promptDisplay.classList.remove('hidden');
                promptEditor.classList.add('hidden');
                
                editBtn.classList.remove('hidden');
                saveBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');
                
                if (promptMode) {
                    promptMode.textContent = '‚úèÔ∏è Modo manual';
                }
                
                isEditingPrompt = false;
                
                // Actualizar el prompt almacenado
                appState.currentDisplayPrompt = newPrompt;
            }
        };

        window.cancelPromptEdit = function() {
            const promptDisplay = document.getElementById('promptDisplay');
            const promptEditor = document.getElementById('promptEditor');
            const editBtn = document.getElementById('editPromptBtn');
            const saveBtn = document.getElementById('savePromptBtn');
            const cancelBtn = document.getElementById('cancelPromptBtn');
            
            if (isEditingPrompt) {
                promptEditor.value = originalPromptText;
                
                promptDisplay.classList.remove('hidden');
                promptEditor.classList.add('hidden');
                
                editBtn.classList.remove('hidden');
                saveBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');
                
                isEditingPrompt = false;
            }
        };

        window.resetPromptToAuto = function() {
            if (confirm('¬øVolver al modo autom√°tico? Se perder√°n los cambios manuales del prompt.')) {
                isPromptManual = false;
                manualPromptText = '';
                
                // Forzar actualizaci√≥n del prompt autom√°tico
                updatePromptPreview();
            }
        };

        // Configurar event listeners de forma segura
        function setupEventListeners() {
            const useImageAICheckbox = document.getElementById('useImageAI');
            if (useImageAICheckbox) {
                useImageAICheckbox.addEventListener('change', (e) => {
                    appState.useImageAI = e.target.checked;
                    const info = document.getElementById('imageAIInfo');
                    const controlsSection = document.getElementById('imageControlsSection');
                    const promptPreview = document.getElementById('promptPreview');
                    const placeholderMessage = document.getElementById('placeholderMessage');
                    const readyMessage = document.getElementById('readyMessage');
                    
                    if (appState.useImageAI) {
                        if (info) info.classList.remove('hidden');
                        if (controlsSection) controlsSection.classList.remove('hidden');
                        
                        if (placeholderMessage) placeholderMessage.classList.add('hidden');
                        if (readyMessage) readyMessage.classList.remove('hidden');
                        
                        if (appState.generatedNarrative) {
                            updatePromptPreview();
                        }
                    } else {
                        if (info) info.classList.add('hidden');
                        if (controlsSection) controlsSection.classList.add('hidden');
                        if (promptPreview) promptPreview.classList.add('hidden');
                        
                        if (placeholderMessage) placeholderMessage.classList.remove('hidden');
                        if (readyMessage) readyMessage.classList.add('hidden');
                    }
                });
            }

            ['artStyle', 'detailLevel', 'promptStrength', 'enhancePrompt', 'imageWidth', 'imageHeight', 'imageComposition', 'sceneStructure', 'lighting'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updatePromptPreview);
                    element.addEventListener('input', updatePromptPreview);
                }
            });

            const generateBtn = document.getElementById('generateBtn');
            const downloadZipBtn = document.getElementById('downloadZipBtn');
            const regenerateBtn = document.getElementById('regenerateBtn');
            
            if (generateBtn) {
                generateBtn.addEventListener('click', handleGeneration);
            }
            
            if (downloadZipBtn) {
                downloadZipBtn.addEventListener('click', downloadCompleteProject);
            }
            
            if (regenerateBtn) {
                regenerateBtn.addEventListener('click', handleGeneration);
            }

            const narrativeEditor = document.getElementById('narrativeEditor');
            if (narrativeEditor) {
                narrativeEditor.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        e.preventDefault();
                        saveNarrativeEdit();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelNarrativeEdit();
                    }
                });
            }

            const promptEditor = document.getElementById('promptEditor');
            if (promptEditor) {
                promptEditor.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        e.preventDefault();
                        savePromptEdit();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelPromptEdit();
                    }
                });
            }
        }

        // Inicializaci√≥n
        function initializeApp() {
            try {
                createGenreElements();
                updateGenreCount();
                setupEventListeners();
                
                const useImageAICheckbox = document.getElementById('useImageAI');
                if (useImageAICheckbox) {
                    const initialImageAIState = useImageAICheckbox.checked;
                    appState.useImageAI = initialImageAIState;
                    
                    if (initialImageAIState) {
                        const imageAIInfo = document.getElementById('imageAIInfo');
                        const imageControlsSection = document.getElementById('imageControlsSection');
                        const placeholderMessage = document.getElementById('placeholderMessage');
                        const readyMessage = document.getElementById('readyMessage');
                        
                        if (imageAIInfo) imageAIInfo.classList.remove('hidden');
                        if (imageControlsSection) imageControlsSection.classList.remove('hidden');
                        if (placeholderMessage) placeholderMessage.classList.add('hidden');
                        if (readyMessage) readyMessage.classList.remove('hidden');
                    }
                }
                
                console.log('üé≠ narrativAI inicializado correctamente');
                
            } catch (error) {
                console.error('Error en inicializaci√≥n:', error);
            }
        }

        // Inicializar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
