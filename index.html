<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Argumentos Narrativos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        .slider::-webkit-slider-thumb {
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #8b5cf6;
            cursor: pointer;
            border: 2px solid #ffffff;
            box-shadow: 0 0 0 1px #8b5cf6;
        }
        
        .slider::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #8b5cf6;
            cursor: pointer;
            border: 2px solid #ffffff;
            box-shadow: 0 0 0 1px #8b5cf6;
        }

        .gradient-text {
            background: linear-gradient(45deg, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card-blur {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.3);
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .title-gradient {
            background: linear-gradient(45deg, #fbbf24, #ec4899, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 to-blue-900 min-h-screen text-white">
    <div class="max-w-4xl mx-auto p-6">
        <div class="card-blur rounded-lg p-8 shadow-2xl">
            <h1 class="text-4xl font-bold text-center mb-8 gradient-text">
                Generador de Argumentos Narrativos
            </h1>
            
            <!-- Configuraci√≥n de IA -->
            <div class="mb-8 p-6 bg-gray-800/50 rounded-lg border border-purple-500/30">
                <h3 class="text-lg font-semibold mb-4 text-purple-300 text-center">
                    ü§ñ IA: Mejora de Texto + Generaci√≥n de Im√°genes
                </h3>
                
                <div class="mb-6">
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div class="flex items-center">
                            <input
                                type="checkbox"
                                id="useAI"
                                class="mr-3 h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                            />
                            <label for="useAI" class="text-purple-300 font-medium">
                                üìù Mejorar texto con IA
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input
                                type="checkbox"
                                id="useImageAI"
                                class="mr-3 h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                            />
                            <label for="useImageAI" class="text-purple-300 font-medium">
                                üé® Generar im√°genes con IA
                            </label>
                        </div>
                    </div>
                    
                    <div id="aiConfig" class="space-y-4 hidden">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-purple-300">
                                    Proveedor de IA (Texto)
                                </label>
                                <select id="aiProvider" class="w-full px-3 py-2 bg-gray-700 border border-purple-400 rounded-lg focus:ring-2 focus:ring-purple-300 text-white">
                                    <option value="openrouter">OpenRouter (M√∫ltiples modelos)</option>
                                    <option value="openai">OpenAI GPT-4 (Directo)</option>
                                    <option value="claude">Claude (Directo)</option>
                                    <option value="gemini">Google Gemini (Directo)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-purple-300">
                                    Proveedor de IA (Im√°genes)
                                </label>
                                <select id="imageProvider" class="w-full px-3 py-2 bg-gray-700 border border-purple-400 rounded-lg focus:ring-2 focus:ring-purple-300 text-white">
                                    <option value="openai">OpenAI DALL-E 3</option>
                                    <option value="replicate">Replicate (Flux, SDXL)</option>
                                    <option value="stability">Stability AI</option>
                                    <option value="fal">Fal.ai (Flux Pro)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-purple-300">
                                    API Key (Texto)
                                </label>
                                <input
                                    type="password"
                                    id="aiApiKey"
                                    placeholder="API key para mejorar texto"
                                    class="w-full px-3 py-2 bg-gray-700 border border-purple-400 rounded-lg focus:ring-2 focus:ring-purple-300 text-white placeholder-gray-400"
                                />
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-purple-300">
                                    API Key (Im√°genes)
                                </label>
                                <input
                                    type="password"
                                    id="imageApiKey"
                                    placeholder="API key para generar im√°genes"
                                    class="w-full px-3 py-2 bg-gray-700 border border-purple-400 rounded-lg focus:ring-2 focus:ring-purple-300 text-white placeholder-gray-400"
                                />
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 text-center">
                            üîí Tus API keys se mantienen privadas y solo se usan localmente en tu navegador
                        </p>
                        
                        <div id="modelSelector" class="hidden">
                            <label class="block text-sm font-medium mb-2 text-purple-300">
                                Modelo de IA
                            </label>
                            <select id="selectedModel" class="w-full px-3 py-2 bg-gray-700 border border-purple-400 rounded-lg focus:ring-2 focus:ring-purple-300 text-white text-sm">
                                <optgroup label="üî• Recomendados">
                                    <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet (Mejor creatividad)</option>
                                    <option value="openai/gpt-4o">GPT-4o (R√°pido y potente)</option>
                                    <option value="google/gemini-pro-1.5">Gemini Pro 1.5 (Contexto largo)</option>
                                </optgroup>
                                <optgroup label="üí∞ Econ√≥micos">
                                    <option value="anthropic/claude-3-haiku">Claude 3 Haiku (R√°pido y barato)</option>
                                    <option value="openai/gpt-3.5-turbo">GPT-3.5 Turbo (Cl√°sico econ√≥mico)</option>
                                    <option value="meta-llama/llama-3.1-8b-instruct">Llama 3.1 8B (Gratuito)</option>
                                </optgroup>
                                <optgroup label="‚ö° Modelos R√°pidos">
                                    <option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
                                    <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                                    <option value="google/gemini-flash-1.5">Gemini Flash 1.5</option>
                                </optgroup>
                                <optgroup label="üß† Modelos Avanzados">
                                    <option value="anthropic/claude-3-opus">Claude 3 Opus (M√°xima calidad)</option>
                                    <option value="openai/gpt-4-turbo">GPT-4 Turbo</option>
                                    <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B</option>
                                </optgroup>
                                <optgroup label="üé≠ Especializados">
                                    <option value="perplexity/llama-3.1-sonar-large-128k-chat">Perplexity Sonar (Investigaci√≥n)</option>
                                    <option value="microsoft/wizardlm-2-8x22b">WizardLM 2 (Razonamiento)</option>
                                    <option value="mistralai/mixtral-8x7b-instruct">Mixtral 8x7B (Multiling√ºe)</option>
                                </optgroup>
                            </select>
                            <p class="text-xs text-gray-400 mt-1">
                                üí° OpenRouter te da acceso a m√∫ltiples modelos con una sola API key
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Elementos Personalizados -->
            <div class="mb-8 p-6 bg-gray-800/50 rounded-lg border border-purple-500/30">
                <h3 class="text-lg font-semibold mb-4 text-purple-300 text-center">
                    ‚úçÔ∏è Configuraci√≥n Creativa
                </h3>
                
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-purple-300">
                            Estilo Narrativo
                        </label>
                        <select id="narrativeStyle" class="w-full px-3 py-2 bg-gray-700 border border-purple-400 rounded-lg focus:ring-2 focus:ring-purple-300 text-white">
                            <option value="original">Original (Estilo propio)</option>
                            <option value="minimalist">Minimalista (Precisi√≥n austera)</option>
                            <option value="baroque">Barroco (Riqueza descriptiva)</option>
                            <option value="poetic">Po√©tico (Lenguaje elevado)</option>
                            <option value="intimate">√çntimo (Voz personal)</option>
                            <option value="experimental">Experimental (Innovador)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-purple-300">
                            Profundidad Tem√°tica
                        </label>
                        <select id="thematicDepth" class="w-full px-3 py-2 bg-gray-700 border border-purple-400 rounded-lg focus:ring-2 focus:ring-purple-300 text-white">
                            <option value="surface">Superficial (Entretenimiento)</option>
                            <option value="moderate">Moderada (Reflexiva)</option>
                            <option value="deep">Profunda (Introspectiva)</option>
                            <option value="philosophical">Filos√≥fica (Existencial)</option>
                            <option value="social">Social (Cr√≠tica)</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2 text-purple-300">
                        Elementos Creativos Personalizados
                    </label>
                    <textarea
                        id="customElements"
                        placeholder="ej: espejo que muestra el futuro, bibliotecario que perdi√≥ la voz, reloj que marca tiempo emocional..."
                        rows="3"
                        class="w-full px-4 py-3 bg-gray-700 border border-purple-400 rounded-lg focus:ring-2 focus:ring-purple-300 focus:border-transparent text-white placeholder-gray-400 resize-none"
                    ></textarea>
                    <p class="text-xs text-gray-400 mt-2">
                        üí° Separa diferentes elementos con comas. Se integrar√°n org√°nicamente en tu narrativa
                    </p>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="avoidCliches" class="mr-3 h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded" checked>
                        <label for="avoidCliches" class="text-purple-300 font-medium text-sm">
                            üö´ Evitar clich√©s y frases rebuscadas
                        </label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="emphasizeOriginality" class="mr-3 h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded" checked>
                        <label for="emphasizeOriginality" class="text-purple-300 font-medium text-sm">
                            ‚ú® Priorizar originalidad y creatividad
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Selecci√≥n de G√©neros -->
            <div class="grid md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label class="block text-sm font-medium mb-2 text-purple-300">
                        Primer G√©nero
                    </label>
                    <select id="genre1" class="w-full px-4 py-3 bg-gray-800 border border-purple-500 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent text-white">
                        <option value="">Selecciona un g√©nero</option>
                        <option value="terror">Terror/Horror</option>
                        <option value="ciencia-ficcion">Ciencia Ficci√≥n</option>
                        <option value="fantasia">Fantas√≠a</option>
                        <option value="romance">Romance</option>
                        <option value="misterio">Misterio</option>
                        <option value="thriller">Thriller</option>
                        <option value="aventura">Aventura</option>
                        <option value="drama">Drama</option>
                        <option value="comedia">Comedia</option>
                        <option value="western">Western</option>
                        <option value="historico">Hist√≥rico</option>
                        <option value="distopia">Distop√≠a</option>
                        <option value="policiaco">Policiaco</option>
                        <option value="supernatural">Sobrenatural</option>
                        <option value="accion">Acci√≥n</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2 text-purple-300">
                        Segundo G√©nero
                    </label>
                    <select id="genre2" class="w-full px-4 py-3 bg-gray-800 border border-purple-500 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent text-white">
                        <option value="">Selecciona un g√©nero</option>
                        <option value="terror">Terror/Horror</option>
                        <option value="ciencia-ficcion">Ciencia Ficci√≥n</option>
                        <option value="fantasia">Fantas√≠a</option>
                        <option value="romance">Romance</option>
                        <option value="misterio">Misterio</option>
                        <option value="thriller">Thriller</option>
                        <option value="aventura">Aventura</option>
                        <option value="drama">Drama</option>
                        <option value="comedia">Comedia</option>
                        <option value="western">Western</option>
                        <option value="historico">Hist√≥rico</option>
                        <option value="distopia">Distop√≠a</option>
                        <option value="policiaco">Policiaco</option>
                        <option value="supernatural">Sobrenatural</option>
                        <option value="accion">Acci√≥n</option>
                    </select>
                </div>
            </div>

            <!-- Ajuste de Pesos -->
            <div id="weightControls" class="mb-8 p-6 bg-gray-800/50 rounded-lg border border-purple-500/30 hidden">
                <h3 class="text-lg font-semibold mb-4 text-purple-300 text-center">
                    Ajustar Peso de Influencia
                </h3>
                
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-purple-300" id="genre1Label">
                                G√©nero 1
                            </span>
                            <span class="text-sm font-bold text-purple-400" id="weight1Display">
                                50%
                            </span>
                        </div>
                        <input
                            type="range"
                            id="weight1"
                            min="10"
                            max="90"
                            value="50"
                            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider"
                        />
                    </div>
                    
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-purple-300" id="genre2Label">
                                G√©nero 2
                            </span>
                            <span class="text-sm font-bold text-purple-400" id="weight2Display">
                                50%
                            </span>
                        </div>
                        <input
                            type="range"
                            id="weight2"
                            min="10"
                            max="90"
                            value="50"
                            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider"
                        />
                    </div>
                    
                    <div class="text-center text-xs text-gray-400 mt-2" id="balanceInfo">
                        ‚öñÔ∏è Narrativa equilibrada entre ambos g√©neros
                    </div>
                </div>
            </div>

            <!-- Botones de Acci√≥n -->
            <div class="text-center mb-6 space-y-4">
                <button
                    id="generateBtn"
                    disabled
                    class="px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed rounded-lg font-semibold text-white shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center mx-auto"
                >
                    ‚ú® Generar Nuevo Argumento
                </button>
                
                <button
                    id="exportBtn"
                    class="px-6 py-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed rounded-lg font-medium text-white shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center mx-auto hidden"
                >
                    üì¶ Exportar como ZIP
                    <span class="ml-2 text-xs opacity-80">(MD + JPG)</span>
                </button>
            </div>

            <!-- Resultado -->
            <div id="resultContainer" class="bg-gradient-to-r from-purple-800/50 to-blue-800/50 p-6 rounded-lg border border-purple-500/30 hidden">
                <div id="titleContainer" class="mb-6 text-center hidden">
                    <h2 id="generatedTitle" class="text-3xl font-bold title-gradient mb-2">
                    </h2>
                    <p class="text-sm text-purple-300 opacity-80">
                        ‚ú® T√≠tulo generado autom√°ticamente
                    </p>
                </div>
                
                <h3 class="text-xl font-semibold mb-4 text-purple-300">
                    Argumento Narrativo:
                </h3>
                
                <!-- Imagen generada -->
                <div id="imageContainer" class="mb-6 hidden">
                    <div class="relative rounded-lg overflow-hidden bg-gray-800/50 border border-purple-400/30">
                        <div id="imageLoading" class="flex items-center justify-center h-64 bg-gray-800/50 hidden">
                            <div class="text-center">
                                <div class="spinner mx-auto mb-4"></div>
                                <p class="text-purple-300 text-sm">Generando imagen visual...</p>
                            </div>
                        </div>
                        <div id="imageDisplay" class="relative hidden">
                            <img id="narrativeImage" class="w-full h-64 object-cover" alt="Visualizaci√≥n del argumento narrativo" />
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                            <div class="absolute bottom-4 left-4 right-4">
                                <p class="text-white text-sm font-medium">
                                    üé® Interpretaci√≥n visual del argumento generado
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <p id="narrativeText" class="text-lg leading-relaxed text-gray-100 mb-4">
                </p>
                
                <div id="narrativeInfo" class="mt-4 text-sm text-purple-300 space-y-1">
                </div>
            </div>

            <div class="mt-8 text-center text-sm text-purple-300">
                <p>‚úçÔ∏è Sistema narrativo avanzado: Creatividad original + Estilos literarios + IA opcional</p>
                <p class="text-xs text-gray-400 mt-2">
                    üí° Enfoque en originalidad, rigor compositivo y desarrollo de estilo propio
                </p>
                <div class="mt-3 flex flex-wrap justify-center gap-2 text-xs">
                    <span class="px-2 py-1 bg-purple-600/20 rounded border border-purple-500/30">‚ú® Originalidad</span>
                    <span class="px-2 py-1 bg-blue-600/20 rounded border border-blue-500/30">üé® Estilos Literarios</span>
                    <span class="px-2 py-1 bg-green-600/20 rounded border border-green-500/30">üö´ Anti-clich√©s</span>
                    <span class="px-2 py-1 bg-orange-600/20 rounded border border-orange-500/30">üß† Profundidad Tem√°tica</span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Estado de la aplicaci√≥n
        let appState = {
            genre1: '',
            genre2: '',
            weight1: 50,
            weight2: 50,
            customElements: '',
            narrativeStyle: 'original',
            thematicDepth: 'moderate',
            avoidCliches: true,
            emphasizeOriginality: true,
            useAiEnhancement: false,
            useImageAI: false,
            aiProvider: 'openrouter',
            imageProvider: 'openai',
            aiApiKey: '',
            imageApiKey: '',
            selectedModel: 'anthropic/claude-3.5-sonnet',
            narrative: '',
            generatedTitle: '',
            generatedImageUrl: '',
            isEnhancing: false,
            isGeneratingImage: false,
            isExporting: false
        };

        // Mapeo de g√©neros
        const genreLabels = {
            'terror': 'Terror/Horror',
            'ciencia-ficcion': 'Ciencia Ficci√≥n',
            'fantasia': 'Fantas√≠a',
            'romance': 'Romance',
            'misterio': 'Misterio',
            'thriller': 'Thriller',
            'aventura': 'Aventura',
            'drama': 'Drama',
            'comedia': 'Comedia',
            'western': 'Western',
            'historico': 'Hist√≥rico',
            'distopia': 'Distop√≠a',
            'policiaco': 'Policiaco',
            'supernatural': 'Sobrenatural',
            'accion': 'Acci√≥n'
        };

        // Base de datos narrativa
        const narrativeData = {
            characters: {
                terror: ['una m√©dium que perdi√≥ su don despu√©s de un trauma', 'un documentalista obsesionado con lo paranormal', 'una ni√±era en una casa con historia siniestra', 'un restaurador de arte que descubre secretos en las pinturas', 'un embalsamador que escucha las √∫ltimas palabras de los muertos', 'una psic√≥loga infantil que trata ni√±os que ven cosas', 'un vigilante nocturno en un hospital abandonado', 'una fot√≥grafa que captura presencias en sus im√°genes', 'un investigador de seguros especializado en muertes extra√±as', 'una enfermera que trabaja en el turno de noche de un geri√°trico', 'un t√©cnico de sonido que graba psicofon√≠as', 'una vendedora de antig√ºedades que conoce la historia de cada objeto', 'un exterminador que encuentra m√°s que insectos en las casas', 'una maestra de preescolar en una escuela con pasado turbio'],
                'ciencia-ficcion': ['una ingeniera de terraformaci√≥n en su √∫ltimo proyecto', 'un arque√≥logo que estudia civilizaciones extintas', 'una piloto de carga interestelar', 'un bi√≥logo marino en una estaci√≥n submarina', 'una programadora de IA que desarrolla consciencias artificiales', 'un xenobi√≥logo que estudia formas de vida alien√≠genas', 'una t√©cnica de criosue√±o en una nave generacional', 'un minero de asteroides que encuentra algo inesperado', 'una doctora en una colonia marciana aislada', 'un ingeniero de portales dimensionales', 'una especialista en comunicaci√≥n con especies no humanas', 'un t√©cnico de mantenimiento en una estaci√≥n espacial', 'una genetista que modifica ADN humano para la supervivencia', 'un explorador de agujeros negros'],
                fantasia: ['una cart√≥grafa de reinos perdidos', 'un traductor de idiomas muertos', 'una herbalista que cultiva plantas imposibles', 'un escriba real con memoria perfecta'],
                romance: ['una organizadora de bodas que no cree en el amor', 'un chef que cocina seg√∫n las emociones', 'una terapeuta de parejas reci√©n divorciada', 'un florista que habla con las plantas'],
                misterio: ['una archivista que encuentra patrones en casos fr√≠os', 'un psic√≥logo forense retirado', 'una periodista de investigaci√≥n independiente', 'un profesor de criminolog√≠a con insomnio'],
                thriller: ['una especialista en seguridad corporativa', 'un ex-militar convertido en guardaespaldas', 'una analista de inteligencia freelance', 'un piloto de helic√≥ptero de rescate'],
                aventura: ['una gu√≠a de monta√±a con claustrofobia', 'un buceador de aguas profundas', 'una exploradora de cuevas', 'un piloto de avionetas de emergencia'],
                drama: ['un trabajador social que perdi√≥ la fe', 'una enfermera de cuidados paliativos', 'un profesor de primaria en un barrio dif√≠cil', 'una directora de refugio para animales'],
                comedia: ['un comediante stand-up con ansiedad social', 'una organizadora de eventos desastrosos', 'un actor de teatro infantil frustrado', 'una critique gastron√≥mica vegetariana'],
                western: ['una herrera que hace armas especiales', 'un veterinario de caballos itinerante', 'una maestra de escuela en pueblo fronterizo', 'un cart√≥grafo del territorio salvaje'],
                historico: ['una conservadora de manuscritos antiguos', 'un arque√≥logo especializado en una √©poca espec√≠fica', 'una int√©rprete de idiomas antiguos', 'un restaurador de objetos hist√≥ricos'],
                distopia: ['una t√©cnica de mantenimiento en la ciudad subterr√°nea', 'un distribuidor de recursos en el nuevo orden', 'una educadora clandestina', 'un cultivador de alimentos hidrop√≥nicos'],
                policiaco: ['una detective de homicidios con sinestesia', 'un investigador privado especializado en desapariciones', 'una analista de patrones criminales', 'un negociador de crisis'],
                supernatural: ['una medium esc√©ptica que investiga fraudes', 'un coleccionista de objetos malditos', 'una antrop√≥loga especializada en folklore', 'un sacerdote que perdi√≥ la fe'],
                accion: ['una especialista en demoliciones', 'un instructor de artes marciales', 'una stuntwoman de pel√≠culas', 'un especialista en rescates extremos']
            },
            motivations: {
                personal: ['busca redimirse por un error del pasado', 'quiere proteger a alguien que ama', 'necesita demostrar su inocencia', 'intenta recuperar algo que perdi√≥'],
                professional: ['debe completar su √∫ltimo caso antes de retirarse', 'quiere exponer una conspiraci√≥n', 'necesita salvar su reputaci√≥n', 'debe cumplir una promesa profesional'],
                survival: ['huye de algo que la persigue', 'est√° atrapada en una situaci√≥n peligrosa', 'debe encontrar una cura o soluci√≥n urgente', 'lucha contra el tiempo'],
                discovery: ['busca la verdad sobre su origen', 'quiere resolver un misterio familiar', 'necesita encontrar a alguien desaparecido', 'debe descifrar un secreto ancestral'],
                transformation: ['debe superar un trauma profundo', 'quiere cambiar completamente de vida', 'necesita aceptar una nueva realidad', 'busca un nuevo prop√≥sito']
            },
            obstacles: {
                external: ['una organizaci√≥n poderosa la persigue', 'las autoridades no le creen', 'el tiempo se agota r√°pidamente', 'sus recursos son limitados'],
                internal: ['sus propios miedos la paralizan', 'no conf√≠a en sus habilidades', 'debe trabajar con alguien que odia', 'sus recuerdos no son confiables'],
                supernatural: ['fuerzas sobrenaturales interfieren', 'las leyes de la realidad no se aplican', 'est√° maldita o bendecida', 'puede ver cosas que otros no ven'],
                social: ['su familia se opone a sus decisiones', 'la comunidad la rechaza', 'debe elegir entre lealtades', 'sus acciones afectan a inocentes'],
                technological: ['la tecnolog√≠a falla en momentos cr√≠ticos', 'est√° siendo vigilada digitalmente', 'debe operar sin tecnolog√≠a moderna', 'la IA ha desarrollado consciencia propia']
            },
            settings: {
                intimate: ['un faro abandonado durante una tormenta', 'un taller de reparaci√≥n familiar', 'una librer√≠a que permanece abierta toda la noche', 'un invernadero en el techo de un edificio'],
                institutional: ['un hospital psiqui√°trico reconvertido en hotel', 'una universidad durante las vacaciones de verano', 'un museo despu√©s del horario de cierre', 'una estaci√≥n de tren en una ciudad peque√±a'],
                natural: ['un bosque donde los √°rboles crecen en espiral', 'una playa donde aparecen objetos del pasado', 'una monta√±a que cambia de forma', 'un desierto que llueve solo de noche'],
                urban: ['una ciudad donde llueve solo en ciertos barrios', 'un edificio de apartamentos con inquilinos misteriosos', 'una red de t√∫neles bajo la ciudad', 'un mercado nocturno que aparece irregularmente'],
                futuristic: ['una colonia espacial que perdi√≥ contacto con la Tierra', 'una ciudad flotante en las nubes', 'un laboratorio subterr√°neo autosustentable', 'una nave generacional cerca de su destino']
            },
            twists: [
                'pero cada decisi√≥n que toma crea una realidad paralela',
                'sin saber que es la √∫nica persona real en un mundo de simulaciones',
                'mientras sus recuerdos se reescriben constantemente',
                'pero el antagonista resulta ser una versi√≥n futura de s√≠ misma',
                'descubriendo que el mundo que conoce es solo uno de muchos niveles de realidad',
                'pero sus acciones afectan retroactivamente su propio pasado',
                'mientras una inteligencia superior observa y juzga cada movimiento',
                'sin darse cuenta de que est√° atrapada en el √∫ltimo sue√±o de alguien m√°s',
                'pero cada persona que salva desaparece de la existencia',
                'descubriendo que es la √∫nica que recuerda c√≥mo era el mundo antes'
            ],
            genreThemes: {
                terror: ['lo familiar se vuelve amenazante', 'la p√©rdida de control sobre la propia realidad', 'secretos del pasado que regresan'],
                'ciencia-ficcion': ['las consecuencias imprevistas del progreso', 'la evoluci√≥n de la consciencia', 'los l√≠mites de la exploraci√≥n'],
                fantasia: ['el poder conlleva responsabilidad', 'la magia tiene un precio', 'los mundos ocultos coexisten con el nuestro'],
                romance: ['el amor trasciende las barreras', 'la vulnerabilidad como fortaleza', 'encontrar la conexi√≥n genuina'],
                misterio: ['la verdad est√° oculta a simple vista', 'las apariencias enga√±an', 'cada pista lleva a m√°s preguntas'],
                thriller: ['nadie es quien aparenta ser', 'el tiempo es el enemigo', 'la paranoia justificada'],
                aventura: ['el viaje transforma al viajero', 'lo desconocido revela verdades internas', 'la supervivencia requiere adaptaci√≥n'],
                drama: ['las decisiones definen el car√°cter', 'la redenci√≥n es posible', 'las relaciones humanas son complejas'],
                comedia: ['el absurdo revela verdades profundas', 'la risa sana heridas', 'la imperfecci√≥n es humana'],
                western: ['la justicia vs. la ley', 'civilizaci√≥n vs. naturaleza salvaje', 'el honor personal por encima de todo'],
                historico: ['el pasado influye en el presente', 'las lecciones no aprendidas se repiten', 'los individuos pueden cambiar la historia'],
                distopia: ['la resistencia individual contra el sistema', 'la esperanza en tiempos oscuros', 'el precio de la seguridad'],
                policiaco: ['la justicia no siempre coincide con la ley', 'la obsesi√≥n puede consumir', 'los culpables a menudo se ocultan entre los inocentes'],
                supernatural: ['los l√≠mites entre realidad y fantas√≠a se difuminan', 'algunas fuerzas est√°n beyond comprensi√≥n humana', 'la fe vs. la raz√≥n'],
                accion: ['las decisiones r√°pidas revelan el verdadero car√°cter', 'la adrenalina clarifica las prioridades', 'el hero√≠smo surge en momentos extremos']
            }
        };

        // Funciones auxiliares
        const getRandomFromArray = (array) => {
            return array[Math.floor(Math.random() * array.length)];
        };

        const generateCreativeNarrative = () => {
            if (!appState.genre1 || !appState.genre2) return '';

            const primaryGenre = appState.weight1 > appState.weight2 ? appState.genre1 : appState.genre2;
            const secondaryGenre = appState.weight1 > appState.weight2 ? appState.genre2 : appState.genre1;
            const dominanceLevel = Math.abs(appState.weight1 - appState.weight2);

            const character = getRandomFromArray(narrativeData.characters[primaryGenre] || narrativeData.characters[secondaryGenre] || Object.values(narrativeData.characters).flat());
            const motivation = getRandomFromArray(Object.values(narrativeData.motivations).flat());
            const obstacle = getRandomFromArray(Object.values(narrativeData.obstacles).flat());
            const setting = getRandomFromArray(Object.values(narrativeData.settings).flat());
            const twist = getRandomFromArray(narrativeData.twists);

            const primaryTheme = getRandomFromArray(narrativeData.genreThemes[primaryGenre] || []);
            const secondaryTheme = getRandomFromArray(narrativeData.genreThemes[secondaryGenre] || []);

            // Aplicar estilo narrativo y profundidad tem√°tica
            let narrative = craftNarrativeWithStyle(character, setting, motivation, obstacle, primaryTheme, secondaryTheme, twist, dominanceLevel);

            return narrative;
        };

        const craftNarrativeWithStyle = (character, setting, motivation, obstacle, primaryTheme, secondaryTheme, twist, dominanceLevel) => {
            let narrative = '';
            
            // Estructuras narrativas seg√∫n estilo
            switch (appState.narrativeStyle) {
                case 'minimalist':
                    narrative = craftMinimalistNarrative(character, setting, motivation, obstacle, primaryTheme, twist);
                    break;
                case 'baroque':
                    narrative = craftBaroqueNarrative(character, setting, motivation, obstacle, primaryTheme, secondaryTheme, twist);
                    break;
                case 'poetic':
                    narrative = craftPoeticNarrative(character, setting, motivation, obstacle, primaryTheme, twist);
                    break;
                case 'intimate':
                    narrative = craftIntimateNarrative(character, setting, motivation, obstacle, primaryTheme, twist);
                    break;
                case 'experimental':
                    narrative = craftExperimentalNarrative(character, setting, motivation, obstacle, primaryTheme, twist);
                    break;
                default: // original
                    narrative = craftOriginalNarrative(character, setting, motivation, obstacle, primaryTheme, secondaryTheme, twist, dominanceLevel);
            }

            // Aplicar profundidad tem√°tica
            narrative = enhanceThematicDepth(narrative, primaryTheme, secondaryTheme);
            
            // Evitar clich√©s si est√° activado
            if (appState.avoidCliches) {
                narrative = avoidCommonCliches(narrative);
            }

            return narrative;
        };

        const craftMinimalistNarrative = (character, setting, motivation, obstacle, theme, twist) => {
            const actions = [
                'observa', 'camina', 'espera', 'decide', 'recuerda', 'imagina', 'descubre', 'comprende', 'acepta', 'rechaza'
            ];
            const action = getRandomFromArray(actions);
            
            let narrative = `${character.charAt(0).toUpperCase() + character.slice(1)} ${action} en ${setting}. `;
            narrative += `${motivation.charAt(0).toUpperCase() + motivation.slice(1)}. `;
            narrative += `${obstacle.charAt(0).toUpperCase() + obstacle.slice(1)}. `;
            
            // Expandir para alcanzar ~200 palabras manteniendo el estilo minimalista
            const details = [
                'Cada d√≠a que pasa, la situaci√≥n se vuelve m√°s compleja.',
                'Las decisiones simples ahora requieren una reflexi√≥n profunda.',
                'El entorno familiar se transforma en algo desconocido.',
                'Los peque√±os gestos adquieren un significado inesperado.',
                'El silencio entre las palabras dice m√°s que las conversaciones.',
                'Las rutinas diarias se convierten en rituales de supervivencia.',
                'Cada objeto en el espacio cuenta una historia diferente.',
                'La memoria juega trucos que revelan verdades ocultas.'
            ];
            
            narrative += ` ${getRandomFromArray(details)} `;
            narrative += `${getRandomFromArray(details)} `;
            
            if (theme) {
                narrative += `En el fondo, todo esto revela c√≥mo ${theme}. `;
            }
            
            narrative += `${getRandomFromArray(details)} `;
            
            if (Math.random() > 0.4) {
                narrative += `${twist.charAt(0).toUpperCase() + twist.slice(1)}.`;
            }
            
            narrative += ` ${getRandomFromArray(details)} `;
            narrative += `Al final, lo que parece simple en la superficie esconde capas de complejidad que solo se revelan con el tiempo y la paciencia de observar.`;
            
            return narrative;
        };

        const craftBaroqueNarrative = (character, setting, motivation, obstacle, primaryTheme, secondaryTheme, twist) => {
            const elaborateDescriptors = [
                'envuelto en la penumbra de sus pensamientos',
                'arrastrando consigo el peso de decisiones pasadas',
                'navegando entre las complejidades de su destino',
                'tejiendo los hilos de una realidad fragmentada'
            ];
            
            let narrative = `En la vastedad ornamentada de ${setting}, ${character} se encuentra ${getRandomFromArray(elaborateDescriptors)}. `;
            narrative += `Su alma, impulsada por la fuerza arrolladora de ${motivation.toLowerCase()}, se encuentra ante el laberinto intrincado que representa ${obstacle.toLowerCase()}. `;
            
            // Expansi√≥n barroca rica en detalles
            narrative += `Cada paso que da resuena con ecos de historias anteriores, mientras que las sombras danzan al comp√°s de secretos susurrados por generaciones. `;
            narrative += `El aire mismo parece espeso con la carga de expectativas no cumplidas y promesas que aguardan su momento de revelaci√≥n. `;
            
            if (primaryTheme && secondaryTheme) {
                narrative += `La narrativa se despliega como un tapiz majestuoso donde ${primaryTheme} se entrelaza con ${secondaryTheme}, `;
                narrative += `revelando las capas ocultas de la experiencia humana con una complejidad que desaf√≠a toda comprensi√≥n simple. `;
            }
            
            narrative += `Los detalles aparentemente insignificantes cobran vida propia: el crujido de un suelo que guarda memorias, la manera en que la luz filtra verdades a trav√©s de cristales empa√±ados por el tiempo. `;
            narrative += `Todo se conecta en una sinfon√≠a de elementos que convergen hacia un punto de transformaci√≥n inevitable. `;
            
            if (Math.random() > 0.2) {
                narrative += `Sin embargo, el destino, en su magnificencia cruel y hermosa, reserva una revelaci√≥n que transformar√° para siempre la comprensi√≥n de todo lo vivido: ${twist.toLowerCase()}.`;
            }
            
            narrative += ` En este momento de claridad deslumbrante, todas las piezas del rompecabezas encuentran su lugar perfecto.`;
            
            return narrative;
        };

        const craftPoeticNarrative = (character, setting, motivation, obstacle, theme, twist) => {
            const poeticVerbs = [
                'danza con las sombras', 'susurra a los vientos', 'abraza el silencio', 
                'dialoga con los ecos', 'se funde con la bruma', 'escucha los latidos del tiempo'
            ];
            
            const poeticMetaphors = [
                'como p√©talos que caen en un estanque de memorias',
                'cual notas perdidas de una melod√≠a antigua',
                'como hilos de luz tejiendo nuevos amaneceres',
                'cual palabras escritas en la arena del tiempo',
                'como susurros que despiertan a los √°rboles dormidos'
            ];
            
            let narrative = `${character.charAt(0).toUpperCase() + character.slice(1)} ${getRandomFromArray(poeticVerbs)} en la vastedad po√©tica de ${setting}. `;
            narrative += `Su coraz√≥n, tambor sagrado de la existencia, late al ritmo eterno de ${motivation.toLowerCase()}, `;
            narrative += `mientras ${obstacle.toLowerCase()} se alza como una monta√±a de cristal y sue√±os ante sus pasos. `;
            
            narrative += `Cada respiraci√≥n es un verso escrito en el aire, cada mirada una estrofa que encuentra eco en rincones olvidados del alma. `;
            narrative += `El tiempo fluye ${getRandomFromArray(poeticMetaphors)}, llevando consigo las esperanzas y los temores que danzan en espiral. `;
            
            if (theme) {
                narrative += `En este teatro de emociones, ${theme} se revela como la verdad central que ilumina cada escena. `;
            }
            
            narrative += `Las estaciones del coraz√≥n cambian con la cadencia de los d√≠as, y cada momento se convierte en una oportunidad de renacimiento. `;
            narrative += `Los colores del amanecer pintan nuevas posibilidades en el lienzo de lo que est√° por venir. `;
            
            if (Math.random() > 0.3) {
                narrative += `Y cuando las estrellas, c√≥mplices silenciosas del destino, se alinean en perfecta armon√≠a, descubre que ${twist.toLowerCase()}.`;
            }
            
            narrative += ` En ese instante de revelaci√≥n, el universo entero se detiene para contemplar la belleza de la transformaci√≥n.`;
            
            return narrative;
        };

        const craftIntimateNarrative = (character, setting, motivation, obstacle, theme, twist) => {
            const intimateConnectors = [
                'En lo m√°s profundo de su ser', 'Con una vulnerabilidad que apenas reconoce',
                'Desde el silencio de su alma', 'En la honestidad de sus temores'
            ];
            
            const personalReflections = [
                'Se permite, por primera vez en mucho tiempo, sentir sin juzgarse',
                'Las l√°grimas no derramadas encuentran finalmente su camino',
                'Reconoce en su propia voz ecos de voces que crey√≥ olvidadas',
                'Descubre que la soledad puede ser una compa√±√≠a apacible',
                'Se da cuenta de que respirar conscientemente es un acto de resistencia'
            ];
            
            let narrative = `${getRandomFromArray(intimateConnectors)}, ${character} habita el espacio √≠ntimo de ${setting}. `;
            narrative += `${motivation.charAt(0).toUpperCase() + motivation.slice(1)}, `;
            narrative += `aunque ${obstacle.toLowerCase()} le recuerda constantemente su vulnerabilidad humana, esa fragilidad que todos compartimos en secreto. `;
            
            narrative += `${getRandomFromArray(personalReflections)}. `;
            narrative += `Hay noches en las que las paredes parecen escuchar, y d√≠as en los que el silencio tiene m√°s sabidur√≠a que cualquier consejo. `;
            
            if (theme) {
                narrative += `En esta intimidad sin m√°scaras, ${theme} se revela no como una lecci√≥n, sino como una verdad vivida. `;
            }
            
            narrative += `${getRandomFromArray(personalReflections)}. `;
            narrative += `Las peque√±as victorias diarias - levantarse, caminar, elegir esperanza por encima del miedo - se convierten en actos heroicos que nadie m√°s puede ver. `;
            
            if (Math.random() > 0.3) {
                narrative += `Es en uno de esos momentos de absoluta honestidad consigo mismo cuando comprende que ${twist.toLowerCase()}.`;
            }
            
            narrative += ` Y en esa comprensi√≥n, encuentra una paz que no sab√≠a que estaba buscando.`;
            
            return narrative;
        };

        const craftExperimentalNarrative = (character, setting, motivation, obstacle, theme, twist) => {
            const experimentalStructures = [
                () => `[${character}] + [${setting}] = [${motivation}] √∑ [${obstacle}]`,
                () => `¬øQu√© sucede cuando ${character} x ${setting}? ${motivation}. Pero: ${obstacle}.`,
                () => `${setting}/${character}/${motivation} vs. ${obstacle}`,
                () => `INICIO: ${character}. LUGAR: ${setting}. MOTOR: ${motivation}. FRICCI√ìN: ${obstacle}.`
            ];
            
            let narrative = getRandomFromArray(experimentalStructures)();
            
            if (Math.random() > 0.6) {
                narrative += ` TWIST: ${twist}.`;
            }
            
            return narrative;
        };

        const craftOriginalNarrative = (character, setting, motivation, obstacle, primaryTheme, secondaryTheme, twist, dominanceLevel) => {
            // Estructura original m√°s sofisticada para ~200 palabras
            const narrativeStarters = [
                'Existe un momento en el que',
                'Hay algo inquietante en c√≥mo',
                'Nadie esperar√≠a que',
                'En el preciso instante cuando',
                'La verdad es que'
            ];
            
            const developmentPhases = [
                'Lo que comienza como una situaci√≥n aparentemente simple se revela como algo mucho m√°s complejo',
                'Cada decisi√≥n tomada abre nuevas puertas mientras cierra otras de forma irreversible',
                'Los patrones que parec√≠an establecidos empiezan a mostrar grietas que nadie hab√≠a notado antes',
                'Las relaciones familiares se transforman bajo la presi√≥n de circunstancias extraordinarias',
                'El entorno f√≠sico parece responder a los cambios emocionales de formas inexplicables'
            ];
            
            let narrative = `${getRandomFromArray(narrativeStarters)} ${character} ${getRandomFromArray(['habita', 'pertenece a', 'se encuentra perdido en', 'redefine', 'cuestiona'])} ${setting}. `;
            narrative += `${motivation.charAt(0).toUpperCase() + motivation.slice(1)}, `;
            narrative += `sin embargo, ${obstacle.toLowerCase()}. `;

            narrative += `${getRandomFromArray(developmentPhases)}. `;
            narrative += `Los d√≠as se suceden con una intensidad creciente, donde cada conversaci√≥n casual puede convertirse en un punto de inflexi√≥n. `;

            if (dominanceLevel > 20) {
                if (primaryTheme) {
                    narrative += `La historia revela progresivamente c√≥mo ${primaryTheme}, `;
                    narrative += `manifest√°ndose en detalles que van desde lo cotidiano hasta lo extraordinario. `;
                }
                if (secondaryTheme && Math.random() > 0.3) {
                    narrative += `Mientras que sutilmente, casi imperceptiblemente, ${secondaryTheme}. `;
                }
            } else {
                if (primaryTheme && secondaryTheme) {
                    narrative += `La narrativa equilibra magistralmente ${primaryTheme} con ${secondaryTheme}, `;
                    narrative += `creando una tensi√≥n creativa que impulsa cada escena hacia nuevos territorios emocionales. `;
                }
            }

            narrative += `${getRandomFromArray(developmentPhases)}. `;

            if (Math.random() > 0.3) {
                narrative += `Todo cambia definitivamente cuando comprende que ${twist}. `;
            }

            narrative += `En ese momento de claridad, las piezas dispersas del rompecabezas encuentran su lugar perfecto, revelando una imagen que trasciende cualquier expectativa inicial.`;

            return narrative;
        };

        const enhanceThematicDepth = (narrative, primaryTheme, secondaryTheme) => {
            const depthEnhancements = {
                'surface': narrative, // Sin cambios
                'moderate': narrative + ` Esta historia invita a reflexionar sobre las decisiones que definen nuestro camino.`,
                'deep': narrative + ` En el fondo, esta narrativa explora los mecanismos mediante los cuales construimos nuestra identidad frente a la adversidad.`,
                'philosophical': narrative + ` ¬øQu√© es la realidad sino el conjunto de percepciones que elegimos aceptar? Esta historia cuestiona los fundamentos mismos de la existencia.`,
                'social': narrative + ` A trav√©s de esta historia, se examina c√≥mo las estructuras sociales moldean y limitan nuestras posibilidades de autorrealizaci√≥n.`
            };
            
            return depthEnhancements[appState.thematicDepth] || narrative;
        };

        const avoidCommonCliches = (narrative) => {
            const clicheReplacements = {
                'de repente': ['inesperadamente', 'sin previo aviso', 'en un instante'],
                'era una noche oscura y tormentosa': ['la noche se extend√≠a inquieta', 'la oscuridad abraza el mundo', 'el tiempo se suspende en penumbras'],
                'todo cambi√≥ para siempre': ['nada volvi√≥ a ser igual', 'el mundo se reconfigur√≥', 'la realidad tom√≥ nuevas formas'],
                'no era lo que parec√≠a': ['ocultaba algo m√°s profundo', 'guardaba secretos inesperados', 'revelaba capas ocultas'],
                'al final del d√≠a': ['en √∫ltima instancia', 'cuando todo se asienta', 'al cerrar el c√≠rculo']
            };
            
            Object.keys(clicheReplacements).forEach(cliche => {
                if (narrative.toLowerCase().includes(cliche)) {
                    const replacement = getRandomFromArray(clicheReplacements[cliche]);
                    narrative = narrative.replace(new RegExp(cliche, 'gi'), replacement);
                }
            });
            
            return narrative;
        };

        const incorporateCustomElements = (baseNarrative) => {
            if (!appState.customElements.trim()) return baseNarrative;

            const elements = appState.customElements.split(',').map(e => e.trim()).filter(e => e.length > 0);
            if (elements.length === 0) return baseNarrative;

            // Seleccionar 1-3 elementos para usar
            const selectedElements = [];
            const numElements = Math.min(Math.floor(Math.random() * 3) + 1, elements.length);
            
            for (let i = 0; i < numElements; i++) {
                const randomElement = getRandomFromArray(elements);
                if (!selectedElements.includes(randomElement)) {
                    selectedElements.push(randomElement);
                }
            }

            let enhancedNarrative = baseNarrative;

            // M√©todos de integraci√≥n m√°s directos y literales
            selectedElements.forEach((element, index) => {
                // Extraer palabras clave del elemento personalizado para usarlas m√°s literalmente
                const cleanElement = element.toLowerCase().trim();
                
                // M√©todos de integraci√≥n que preservan mejor las palabras exactas
                const integrationMethods = [
                    // M√©todo 1: Reemplazar ubicaci√≥n o contexto
                    () => {
                        if (enhancedNarrative.includes('se encuentra en')) {
                            enhancedNarrative = enhancedNarrative.replace(/se encuentra en ([^.]+)/, `se encuentra en $1, donde descubre ${element}`);
                        } else if (enhancedNarrative.includes('habita')) {
                            enhancedNarrative = enhancedNarrative.replace(/habita ([^.]+)/, `habita $1 junto a ${element}`);
                        }
                    },
                    
                    // M√©todo 2: Integrar como elemento central del conflicto
                    () => {
                        if (enhancedNarrative.includes('sin embargo,') || enhancedNarrative.includes('pero ')) {
                            enhancedNarrative = enhancedNarrative.replace(/(sin embargo,|pero )/, `$1 ${element} representa el obst√°culo que `);
                        } else {
                            const sentences = enhancedNarrative.split('. ');
                            if (sentences.length > 1) {
                                sentences[1] = `${element.charAt(0).toUpperCase() + element.slice(1)} complica su situaci√≥n, ya que ${sentences[1].toLowerCase()}`;
                                enhancedNarrative = sentences.join('. ');
                            }
                        }
                    },
                    
                    // M√©todo 3: Como herramienta o aliado
                    () => {
                        if (enhancedNarrative.includes('descubre que')) {
                            enhancedNarrative = enhancedNarrative.replace(/descubre que/, `utiliza ${element} para descubrir que`);
                        } else {
                            const sentences = enhancedNarrative.split('. ');
                            if (sentences.length > 2) {
                                const insertIndex = Math.floor(sentences.length / 2);
                                sentences.splice(insertIndex, 0, `${element.charAt(0).toUpperCase() + element.slice(1)} se convierte en su √∫nica esperanza`);
                                enhancedNarrative = sentences.join('. ');
                            }
                        }
                    },
                    
                    // M√©todo 4: Integraci√≥n directa como elemento central
                    () => {
                        const firstSentence = enhancedNarrative.split('.')[0];
                        const restOfNarrative = enhancedNarrative.substring(firstSentence.length + 1);
                        enhancedNarrative = `${firstSentence} con ${element}.${restOfNarrative}`;
                    },
                    
                    // M√©todo 5: Como revelaci√≥n final
                    () => {
                        if (enhancedNarrative.includes('cuando')) {
                            enhancedNarrative = enhancedNarrative.replace(/cuando ([^.]+)/, `cuando descubre que ${element} $1`);
                        } else {
                            enhancedNarrative += ` Todo cambia cuando ${element} revela su verdadera naturaleza.`;
                        }
                    }
                ];

                // Intentar m√©todos de integraci√≥n hasta que uno funcione
                const method = getRandomFromArray(integrationMethods);
                const originalNarrative = enhancedNarrative;
                
                try {
                    method();
                    // Verificar que realmente se integr√≥ el elemento
                    if (!enhancedNarrative.toLowerCase().includes(cleanElement.substring(0, Math.min(10, cleanElement.length)))) {
                        // Si no se integr√≥ bien, usar m√©todo directo
                        enhancedNarrative = originalNarrative + ` ${element.charAt(0).toUpperCase() + element.slice(1)} se vuelve fundamental en esta historia.`;
                    }
                } catch (e) {
                    // M√©todo de respaldo que garantiza la inclusi√≥n literal
                    enhancedNarrative = originalNarrative + ` En el centro de todo est√° ${element}, que define el destino del protagonista.`;
                }
            });

            return enhancedNarrative;
        };

        const generateTitle = (narrative, primaryGenre, secondaryGenre) => {
            if (!narrative) return '';

            const titlePatterns = {
                terror: [
                    'El √∫ltimo [sustantivo]', 'Sombras de [lugar]', 'La herencia de [personaje]', 
                    '[Sustantivo] silenciosos', 'Despu√©s de [evento]', 'Los ojos de [personaje]',
                    'El ritual de [lugar]', 'Susurros en [lugar]', 'La maldici√≥n de [objeto]',
                    'Cuando [evento] despierte', 'El guardi√°n de [lugar]', 'Ecos de [tiempo]'
                ],
                'ciencia-ficcion': [
                    'Protocolo [nombre]', 'El proyecto [c√≥digo]', 'Horizonte [lugar]', 
                    'La estaci√≥n [nombre]', 'C√≥digo [n√∫mero]', 'El experimento [nombre]',
                    'Se√±al desde [lugar]', 'La √∫ltima [tecnolog√≠a]', 'Genesis [n√∫mero]',
                    'El algoritmo [nombre]', 'Nave [designaci√≥n]', 'Conexi√≥n [t√©rmino]'
                ],
                drama: [
                    'La vida de [personaje]', 'Historias de [lugar]', 'El precio de [decisi√≥n]',
                    'Familia [apellido]', 'Los d√≠as de [per√≠odo]', 'El peso de [responsabilidad]',
                    'Decisiones en [lugar]', 'La herencia de [familia]', 'Tiempo de [cambio]',
                    'El camino de [personaje]', 'Lecciones de [vida]', 'El futuro de [lugar]'
                ]
            };

            const extractKeyElements = (text) => {
                const elements = {
                    personajes: [],
                    lugares: [],
                    objetos: [],
                    customElements: []
                };

                // Extraer personajes del texto
                const personajePatterns = [
                    /un[a]? ([^,\.]+?)(?= que|,|\.|$)/g,
                    /el ([^,\.]+?)(?= que|,|\.|$)/g,
                    /la ([^,\.]+?)(?= que|,|\.|$)/g
                ];

                personajePatterns.forEach(pattern => {
                    const matches = text.match(pattern);
                    if (matches) {
                        matches.forEach(match => {
                            const clean = match.replace(/^(un[a]?|el|la) /, '').trim();
                            if (clean.length > 3 && clean.length < 30) {
                                elements.personajes.push(clean);
                            }
                        });
                    }
                });

                // Priorizar elementos personalizados del usuario
                if (appState.customElements.trim()) {
                    const customEls = appState.customElements.split(',').map(e => e.trim()).filter(e => e.length > 0);
                    
                    // Usar los elementos personalizados tal como los escribi√≥ el usuario
                    elements.customElements = customEls;
                    
                    // Tambi√©n extraer palabras clave de los elementos personalizados para t√≠tulos
                    customEls.forEach(element => {
                        // Extraer sustantivos principales del elemento personalizado
                        const words = element.split(' ').filter(word => word.length > 3);
                        elements.objetos.push(...words.slice(0, 2)); // Primeras 2 palabras significativas
                        
                        // A√±adir el elemento completo tambi√©n
                        elements.objetos.push(element);
                    });
                }

                return elements;
            };

            const keyElements = extractKeyElements(narrative);
            
            const primaryPatterns = titlePatterns[primaryGenre] || titlePatterns['drama'];
            const selectedPattern = getRandomFromArray(primaryPatterns);

            let finalTitle = selectedPattern;

            // Priorizar elementos personalizados del usuario para los t√≠tulos
            const getCustomElementForTitle = () => {
                if (keyElements.customElements.length > 0) {
                    const element = getRandomFromArray(keyElements.customElements);
                    // Extraer la palabra principal del elemento personalizado
                    const mainWord = element.split(' ')[0];
                    return mainWord.length > 2 ? mainWord : element;
                }
                return null;
            };

            const customElement = getCustomElementForTitle();
            
            const replacements = {
                '[sustantivo]': customElement || keyElements.objetos[0] || keyElements.personajes[0] || 'secreto',
                '[lugar]': customElement ? `${customElement}` : 'las sombras',
                '[personaje]': keyElements.personajes[0] || 'protagonista',
                '[objeto]': customElement || keyElements.objetos[0] || 'misterio',
                '[evento]': customElement ? `el despertar de ${customElement}` : 'el despertar',
                '[nombre]': customElement || `${Math.random().toString(36).substr(2, 6).toUpperCase()}`,
                '[c√≥digo]': `${Math.random().toString(36).substr(2, 4).toUpperCase()}-${Math.floor(Math.random() * 99)}`,
                '[n√∫mero]': Math.floor(Math.random() * 99) + 1,
                '[tiempo]': customElement ? `${customElement}` : 'medianoche',
                '[tecnolog√≠a]': customElement || 'conexi√≥n',
                '[designaci√≥n]': customElement || 'Odisea',
                '[t√©rmino]': customElement || 'neural',
                '[decisi√≥n]': customElement ? `${customElement}` : 'la verdad',
                '[apellido]': 'Sterling',
                '[responsabilidad]': customElement ? `${customElement}` : 'las decisiones',
                '[vida]': customElement ? `${customElement}` : 'una elecci√≥n',
                '[cambio]': customElement || 'transformaci√≥n',
                '[per√≠odo]': 'transici√≥n',
                '[familia]': 'los Morrison'
            };

            Object.keys(replacements).forEach(placeholder => {
                if (finalTitle.includes(placeholder)) {
                    finalTitle = finalTitle.replace(placeholder, replacements[placeholder]);
                }
            });

            // T√≠tulos h√≠bridos que incorporan elementos personalizados
            if (Math.abs(appState.weight1 - appState.weight2) <= 15) {
                const hybridTitles = [];
                
                if (keyElements.customElements.length > 0) {
                    const mainElement = keyElements.customElements[0];
                    const secondElement = keyElements.customElements[1];
                    
                    hybridTitles.push(
                        `${keyElements.personajes[0] || 'El Elegido'} y ${mainElement}`,
                        `Entre ${mainElement} ${secondElement ? `y ${secondElement}` : 'y Destino'}`,
                        `La Historia de ${mainElement}`,
                        `El ${mainElement} Perdido`,
                        `Cuando ${mainElement} Despierta`,
                        `Los Secretos de ${mainElement}`
                    );
                } else {
                    hybridTitles.push(
                        `${keyElements.personajes[0] || 'El Elegido'} de Dos Mundos`,
                        `Entre Sombras y Destino`,
                        `La Llave de los Secretos`,
                        `El √öltimo Guardi√°n`
                    );
                }
                
                if (Math.random() > 0.5) {
                    finalTitle = getRandomFromArray(hybridTitles);
                }
            }

            finalTitle = finalTitle.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');

            finalTitle = finalTitle.replace(/\b(De|El|La|Los|Las|En|Con|Por|Para|Sin|Desde|Hasta)\b/g, 
                match => match.toLowerCase()
            );
            
            finalTitle = finalTitle.charAt(0).toUpperCase() + finalTitle.slice(1);

            return finalTitle;
        };

        const enhanceWithAI = async (baseNarrative) => {
            if (!appState.useAiEnhancement || !appState.aiApiKey.trim()) return baseNarrative;
            
            appState.isEnhancing = true;
            updateGenerateButton();
            
            try {
                const genreInfo = `G√©neros: ${genreLabels[appState.genre1]} (${appState.weight1}%) + ${genreLabels[appState.genre2]} (${appState.weight2}%)`;
                const elementsInfo = appState.customElements.trim() ? `Elementos personalizados: ${appState.customElements}` : '';
                const styleInfo = `Estilo narrativo: ${appState.narrativeStyle}, Profundidad: ${appState.thematicDepth}`;
                
                const creativityDirectives = [
                    '- ORIGINALIDAD PRIORITARIA: Enfatiza la creatividad y la originalidad por encima de todo',
                    '- RIGOR COMPOSITIVO: Mant√©n precisi√≥n y estructura, pero sin descuidar la innovaci√≥n',
                    '- ESTILO PROPIO: Desarrolla una voz narrativa distintiva y personal',
                    '- EVITA FRASES REBUSCADAS: Busca claridad expresiva sin artificiosidad',
                    '- SENTIDO EN CADA L√çNEA: Cada frase debe aportar significado y valor',
                    '- FLORECER IDEAS: Permite que las ideas se desarrollen de forma natural y org√°nica',
                    '- USAR ELEMENTOS EXACTOS: Incorpora las palabras y conceptos espec√≠ficos del usuario de forma literal y prominente'
                ];
                
                const avoidanceDirectives = appState.avoidCliches ? 
                    '- EVITA CLICH√âS: No uses expresiones manidas ni f√≥rmulas predecibles\n' : '';
                
                const originalityEmphasis = appState.emphasizeOriginality ? 
                    '- B√öSQUEDA DE LO √öNICO: Encuentra √°ngulos narrativos inesperados y sobresalientes\n' : '';
                
                const prompt = `Eres un escritor experimentado que valora la originalidad y la creatividad literaria. Tu misi√≥n es transformar esta sinopsis siguiendo estos principios:

${creativityDirectives.join('\n')}
${avoidanceDirectives}${originalityEmphasis}
CONFIGURACI√ìN:
${genreInfo}
${styleInfo}
${elementsInfo}

SINOPSIS ORIGINAL:
"${baseNarrative}"

INSTRUCCIONES ESPEC√çFICAS:
1. Reescribe con un estilo ${appState.narrativeStyle} y profundidad ${appState.thematicDepth}
2. LONGITUD OBJETIVO: Aproximadamente 200 palabras (ni menos de 180, ni m√°s de 220)
3. Cada palabra debe justificar su presencia
4. Busca perspectivas narrativas inesperadas
5. Desarrolla una voz distintiva que sea √∫nica y memorable
6. Integra las ideas de forma que florezcan naturalmente
7. CR√çTICO: Si hay elementos personalizados, √∫salos de forma literal y prominente en la narrativa
8. Los elementos personalizados deben aparecer con sus palabras exactas o muy similares
9. Mant√©n el idioma espa√±ol pero con personalidad propia

VERSI√ìN MEJORADA (200 palabras aproximadamente):`;

                let response;
                
                if (appState.aiProvider === 'openrouter') {
                    response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${appState.aiApiKey}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.href,
                            'X-Title': 'Generador Narrativo Standalone'
                        },
                        body: JSON.stringify({
                            model: appState.selectedModel,
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 400,
                            temperature: 0.8,
                            top_p: 0.9,
                        }),
                    });
                } else if (appState.aiProvider === 'openai') {
                    response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${appState.aiApiKey}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'gpt-4',
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 400,
                            temperature: 0.8,
                        }),
                    });
                }
                
                if (response?.ok) {
                    const data = await response.json();
                    let enhancedText;
                    
                    if (appState.aiProvider === 'openrouter' || appState.aiProvider === 'openai') {
                        enhancedText = data.choices[0]?.message?.content;
                    }
                    
                    return enhancedText || baseNarrative;
                } else {
                    const errorData = await response.json();
                    console.error('Error de API:', errorData);
                    throw new Error(errorData.error?.message || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error al mejorar con IA:', error);
            } finally {
                appState.isEnhancing = false;
                updateGenerateButton();
            }
            
            return baseNarrative;
        };

        const generateImagePrompt = (narrative, primaryGenre, secondaryGenre) => {
            const genreStyles = {
                'terror': 'dark atmospheric horror, shadows and fog, eerie lighting, gothic architecture',
                'ciencia-ficcion': 'futuristic sci-fi, neon lights, cyberpunk aesthetic, space technology, holographic displays',
                'fantasia': 'magical fantasy, ethereal lighting, mystical creatures, enchanted forest, magical aura',
                'romance': 'warm romantic lighting, soft pastel colors, intimate atmosphere, dreamy bokeh',
                'misterio': 'noir mystery, dramatic chiaroscuro lighting, film noir aesthetic, detective atmosphere',
                'thriller': 'intense dramatic lighting, high contrast, suspenseful mood, urban decay',
                'aventura': 'epic adventure, dynamic composition, heroic lighting, vast landscapes',
                'drama': 'emotional dramatic lighting, realistic human expressions, natural environments',
                'comedia': 'bright cheerful colors, whimsical atmosphere, cartoonish style, vibrant lighting',
                'western': 'wild west aesthetic, dusty landscapes, dramatic sunsets, frontier towns',
                'historico': 'period accurate historical setting, vintage atmosphere, authentic costumes',
                'distopia': 'dystopian future, industrial decay, muted desaturated colors, oppressive architecture',
                'policiaco': 'crime scene investigation, urban noir, detective office, city nightlife',
                'supernatural': 'supernatural phenomena, ghostly apparitions, otherworldly atmosphere, mystical energy',
                'accion': 'high energy action, dynamic motion blur, explosive effects, intense combat'
            };

            const primaryStyle = genreStyles[primaryGenre] || 'cinematic dramatic';
            const secondaryStyle = genreStyles[secondaryGenre] || 'atmospheric moody';
            
            let imagePrompt = `${primaryStyle}`;
            
            if (Math.abs(appState.weight1 - appState.weight2) <= 20) {
                imagePrompt += `, seamlessly blended with ${secondaryStyle}`;
            } else {
                imagePrompt += `, with subtle influences of ${secondaryStyle}`;
            }
            
            // Extraer elementos espec√≠ficos de la narrativa
            if (narrative.includes('faro')) imagePrompt += ', lighthouse in stormy weather';
            if (narrative.includes('bosque')) imagePrompt += ', mystical enchanted forest';
            if (narrative.includes('ciudad')) imagePrompt += ', sprawling urban cityscape';
            if (narrative.includes('espacio')) imagePrompt += ', vast outer space with stars and nebulae';
            if (narrative.includes('laboratorio')) imagePrompt += ', high-tech scientific laboratory';
            if (narrative.includes('hospital')) imagePrompt += ', sterile medical facility corridors';
            if (narrative.includes('librer√≠a')) imagePrompt += ', cozy bookstore with towering shelves';
            if (narrative.includes('monta√±a')) imagePrompt += ', majestic mountain peaks';
            if (narrative.includes('desierto')) imagePrompt += ', endless desert dunes';
            if (narrative.includes('nave')) imagePrompt += ', futuristic spacecraft interior';
            if (narrative.includes('colonia')) imagePrompt += ', sci-fi space colony';
            if (narrative.includes('estaci√≥n')) imagePrompt += ', space station or train station';
            
            // A√±adir elementos personalizados de forma m√°s literal y directa
            if (appState.customElements.trim()) {
                const customElements = appState.customElements.split(',').map(e => e.trim()).filter(e => e.length > 0);
                
                // Usar los primeros 2-3 elementos directamente en el prompt
                customElements.slice(0, 3).forEach(element => {
                    const cleanElement = element.toLowerCase();
                    
                    // Mapeo directo para elementos comunes
                    if (cleanElement.includes('espejo')) {
                        imagePrompt += `, ${cleanElement.includes('futuro') ? 'time-reflecting mirror showing future visions' : 'ornate magical mirror'}`;
                    } else if (cleanElement.includes('reloj')) {
                        imagePrompt += `, ${cleanElement.includes('tiempo') || cleanElement.includes('emocional') ? 'emotional time clock with shifting numbers' : 'antique clockwork mechanism'}`;
                    } else if (cleanElement.includes('libro') || cleanElement.includes('bibliotecario')) {
                        imagePrompt += `, ${cleanElement.includes('perdi√≥') || cleanElement.includes('voz') ? 'silent librarian with ancient books' : 'ancient leather-bound book'}`;
                    } else if (cleanElement.includes('llave')) {
                        imagePrompt += ', mysterious ornate key';
                    } else if (cleanElement.includes('robot')) {
                        imagePrompt += ', advanced robotic figure';
                    } else if (cleanElement.includes('drag√≥n')) {
                        imagePrompt += ', majestic dragon creature';
                    } else if (cleanElement.includes('cristal')) {
                        imagePrompt += ', glowing crystal formations';
                    } else if (cleanElement.includes('portal')) {
                        imagePrompt += ', swirling dimensional portal';
                    } else {
                        // Para elementos que no tienen mapeo espec√≠fico, usarlos directamente
                        const keywords = element.split(' ').slice(0, 3).join(' ');
                        imagePrompt += `, ${keywords}`;
                    }
                });
                
                // A√±adir √©nfasis en que estos elementos sean prominentes
                if (customElements.length > 0) {
                    imagePrompt += ', featuring these elements prominently in the composition';
                }
            }
            
            // A√±adir calidad y estilo final
            imagePrompt += ', professional concept art, ultra detailed, cinematic composition, dramatic lighting, photorealistic, 8k quality, masterpiece';
            
            return imagePrompt;
        };

        const generateImageWithAI = async (prompt) => {
            if (!appState.useImageAI || !appState.imageApiKey.trim()) {
                // Fallback a placeholder si no hay IA de im√°genes
                const keywords = appState.genre1 === 'terror' ? 'dark,mystery' : 
                                appState.genre1 === 'ciencia-ficcion' ? 'space,future' : 
                                appState.genre1 === 'fantasia' ? 'fantasy,magic' : 'cinematic';
                return `https://source.unsplash.com/800x400/?${keywords}`;
            }
            
            console.log('üé® Generando imagen con IA:', {
                provider: appState.imageProvider,
                prompt: prompt.substring(0, 100) + '...',
                hasApiKey: !!appState.imageApiKey
            });
            
            try {
                let imageUrl = null;
                
                if (appState.imageProvider === 'openai') {
                    console.log('üì° Llamando a OpenAI DALL-E 3...');
                    const response = await fetch('https://api.openai.com/v1/images/generations', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${appState.imageApiKey}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'dall-e-3',
                            prompt: prompt,
                            n: 1,
                            size: '1024x1024',
                            quality: 'standard',
                            style: 'natural'
                        }),
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        imageUrl = data.data[0]?.url;
                        console.log('‚úÖ OpenAI gener√≥ imagen exitosamente');
                    } else {
                        const errorData = await response.json();
                        console.error('‚ùå Error de OpenAI:', errorData);
                        throw new Error(`OpenAI Error: ${errorData.error?.message || 'Unknown error'}`);
                    }
                    
                } else if (appState.imageProvider === 'replicate') {
                    console.log('üì° Llamando a Replicate...');
                    const response = await fetch('https://api.replicate.com/v1/predictions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Token ${appState.imageApiKey}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            version: 'ac732df83cea7fff18b8472768c88ad041fa750ff7682a21affe81863cbe77e4',
                            input: {
                                prompt: prompt,
                                width: 1024,
                                height: 1024,
                                num_outputs: 1,
                                guidance_scale: 7.5,
                                num_inference_steps: 50
                            }
                        }),
                    });
                    
                    if (response.ok) {
                        const prediction = await response.json();
                        console.log('‚è≥ Replicate prediction iniciada:', prediction.id);
                        
                        // Esperar a que se complete la generaci√≥n
                        let completed = false;
                        let attempts = 0;
                        while (!completed && attempts < 30) {
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            
                            const statusResponse = await fetch(`https://api.replicate.com/v1/predictions/${prediction.id}`, {
                                headers: {
                                    'Authorization': `Token ${appState.imageApiKey}`,
                                },
                            });
                            
                            if (statusResponse.ok) {
                                const status = await statusResponse.json();
                                console.log(`‚è≥ Replicate status: ${status.status} (intento ${attempts + 1})`);
                                
                                if (status.status === 'succeeded') {
                                    imageUrl = status.output[0];
                                    console.log('‚úÖ Replicate gener√≥ imagen exitosamente');
                                    completed = true;
                                } else if (status.status === 'failed') {
                                    console.error('‚ùå Replicate fall√≥:', status.error);
                                    throw new Error(`Replicate failed: ${status.error}`);
                                }
                            }
                            attempts++;
                        }
                        
                        if (!completed) {
                            throw new Error('Replicate timeout: La generaci√≥n tom√≥ demasiado tiempo');
                        }
                    } else {
                        const errorData = await response.json();
                        console.error('‚ùå Error de Replicate:', errorData);
                        throw new Error(`Replicate Error: ${errorData.detail || 'Unknown error'}`);
                    }
                    
                } else if (appState.imageProvider === 'stability') {
                    console.log('üì° Llamando a Stability AI...');
                    const response = await fetch('https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${appState.imageApiKey}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text_prompts: [{ text: prompt, weight: 1 }],
                            cfg_scale: 7,
                            height: 1024,
                            width: 1024,
                            steps: 50,
                            samples: 1,
                        }),
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.artifacts && data.artifacts.length > 0) {
                            // Convertir base64 a blob URL
                            const base64 = data.artifacts[0].base64;
                            const byteCharacters = atob(base64);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], { type: 'image/png' });
                            imageUrl = URL.createObjectURL(blob);
                            console.log('‚úÖ Stability AI gener√≥ imagen exitosamente');
                        }
                    } else {
                        const errorData = await response.json();
                        console.error('‚ùå Error de Stability AI:', errorData);
                        throw new Error(`Stability AI Error: ${errorData.message || 'Unknown error'}`);
                    }
                    
                } else if (appState.imageProvider === 'fal') {
                    console.log('üì° Llamando a Fal.ai...');
                    const response = await fetch('https://fal.run/fal-ai/flux-pro', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Key ${appState.imageApiKey}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            image_size: 'landscape_4_3',
                            num_inference_steps: 28,
                            guidance_scale: 3.5,
                            enable_safety_checker: true
                        }),
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        imageUrl = data.images[0]?.url;
                        console.log('‚úÖ Fal.ai gener√≥ imagen exitosamente');
                    } else {
                        const errorData = await response.json();
                        console.error('‚ùå Error de Fal.ai:', errorData);
                        throw new Error(`Fal.ai Error: ${errorData.detail || 'Unknown error'}`);
                    }
                }
                
                if (!imageUrl) {
                    throw new Error('No se pudo obtener URL de imagen del proveedor');
                }
                
                return imageUrl;
                
            } catch (error) {
                console.error('‚ùå Error completo generando imagen con IA:', error);
                
                // Mostrar error m√°s espec√≠fico al usuario
                const errorContainer = document.getElementById('imageContainer');
                if (errorContainer) {
                    const errorDisplay = document.createElement('div');
                    errorDisplay.className = 'text-red-400 text-sm p-4 bg-red-900/20 rounded border border-red-500/30 mb-4';
                    errorDisplay.innerHTML = `
                        <strong>‚ö†Ô∏è Error generando imagen:</strong><br>
                        ${error.message}<br>
                        <small>Usando placeholder temporal. Verifica tu API key y configuraci√≥n.</small>
                    `;
                    errorContainer.insertBefore(errorDisplay, errorContainer.firstChild);
                }
                
                // Fallback a placeholder en caso de error
                const keywords = appState.genre1 === 'terror' ? 'dark,mystery' : 
                                appState.genre1 === 'ciencia-ficcion' ? 'space,future' : 
                                appState.genre1 === 'fantasia' ? 'fantasy,magic' : 'cinematic';
                return `https://source.unsplash.com/800x400/?${keywords}`;
            }
        };

        const generateNarrative = async () => {
            if (!appState.genre1 || !appState.genre2) {
                appState.narrative = 'Selecciona ambos g√©neros para generar un argumento narrativo.';
                displayResult();
                return;
            }

            const baseNarrative = generateCreativeNarrative();
            const enhancedNarrative = incorporateCustomElements(baseNarrative);
            
            const finalNarrative = await enhanceWithAI(enhancedNarrative);
            appState.narrative = finalNarrative;
            
            const primaryGenre = appState.weight1 > appState.weight2 ? appState.genre1 : appState.genre2;
            const secondaryGenre = appState.weight1 > appState.weight2 ? appState.genre2 : appState.genre1;
            const intelligentTitle = generateTitle(finalNarrative, primaryGenre, secondaryGenre);
            appState.generatedTitle = intelligentTitle;
            
            // Generar imagen con IA real o placeholder (solo una imagen por narrativa)
            appState.isGeneratingImage = true;
            displayResult(); // Mostrar el loading
            
            try {
                const imagePrompt = generateImagePrompt(finalNarrative, primaryGenre, secondaryGenre);
                console.log('üé® Iniciando generaci√≥n de imagen con prompt:', imagePrompt.substring(0, 100) + '...');
                
                const imageUrl = await generateImageWithAI(imagePrompt);
                
                if (imageUrl) {
                    appState.generatedImageUrl = imageUrl;
                    console.log('‚úÖ Una imagen generada i assignada exitosament');
                } else {
                    console.warn('‚ö†Ô∏è No se recibi√≥ URL de imagen, usando placeholder');
                    const keywords = primaryGenre === 'terror' ? 'dark,mystery' : 
                                    primaryGenre === 'ciencia-ficcion' ? 'space,future' : 
                                    primaryGenre === 'fantasia' ? 'fantasy,magic' : 'cinematic';
                    appState.generatedImageUrl = `https://source.unsplash.com/800x400/?${keywords}`;
                }
            } catch (error) {
                console.error('‚ùå Error cr√≠tico generando imagen:', error);
                // Fallback a placeholder en caso de error
                const keywords = primaryGenre === 'terror' ? 'dark,mystery' : 
                                primaryGenre === 'ciencia-ficcion' ? 'space,future' : 
                                primaryGenre === 'fantasia' ? 'fantasy,magic' : 'cinematic';
                appState.generatedImageUrl = `https://source.unsplash.com/800x400/?${keywords}`;
            } finally {
                appState.isGeneratingImage = false;
                displayResult(); // Actualizar la visualizaci√≥n
            }
            
            displayResult();
        };

        const displayResult = () => {
            const resultContainer = document.getElementById('resultContainer');
            const titleContainer = document.getElementById('titleContainer');
            const generatedTitle = document.getElementById('generatedTitle');
            const narrativeText = document.getElementById('narrativeText');
            const narrativeInfo = document.getElementById('narrativeInfo');
            const imageContainer = document.getElementById('imageContainer');
            const imageLoading = document.getElementById('imageLoading');
            const imageDisplay = document.getElementById('imageDisplay');
            const narrativeImage = document.getElementById('narrativeImage');
            const exportBtn = document.getElementById('exportBtn');

            if (appState.narrative) {
                resultContainer.classList.remove('hidden');
                exportBtn.classList.remove('hidden');
                
                if (appState.generatedTitle) {
                    titleContainer.classList.remove('hidden');
                    generatedTitle.textContent = `"${appState.generatedTitle}"`;
                } else {
                    titleContainer.classList.add('hidden');
                }
                
                narrativeText.textContent = appState.narrative;
                
                // Mostrar imagen
                if (appState.generatedImageUrl || appState.isGeneratingImage) {
                    imageContainer.classList.remove('hidden');
                    
                    if (appState.isGeneratingImage) {
                        imageLoading.classList.remove('hidden');
                        imageDisplay.classList.add('hidden');
                        console.log('üîÑ Mostrando loading de imagen...');
                    } else if (appState.generatedImageUrl) {
                        imageLoading.classList.add('hidden');
                        imageDisplay.classList.remove('hidden');
                        narrativeImage.src = appState.generatedImageUrl;
                        console.log('üñºÔ∏è Mostrando imagen generada:', appState.generatedImageUrl.substring(0, 50) + '...');
                        
                        // A√±adir handler de error para la imagen
                        narrativeImage.onerror = () => {
                            console.error('‚ùå Error cargando imagen generada');
                            imageDisplay.innerHTML = `
                                <div class="flex items-center justify-center h-64 bg-gray-800/50 text-red-400">
                                    <div class="text-center">
                                        <p class="mb-2">‚ùå Error cargando imagen</p>
                                        <p class="text-sm">Verifica tu API key y conexi√≥n</p>
                                    </div>
                                </div>
                            `;
                        };
                        
                        narrativeImage.onload = () => {
                            console.log('‚úÖ Imagen cargada exitosamente en el DOM');
                        };
                    }
                } else {
                    imageContainer.classList.add('hidden');
                    console.log('üö´ No hay imagen para mostrar');
                }
                
                // Informaci√≥n de la narrativa
                let infoHtml = `
                    <div>
                        <span class="font-medium">G√©neros combinados:</span> ${genreLabels[appState.genre1]} + ${genreLabels[appState.genre2]}
                    </div>
                    <div>
                        <span class="font-medium">Distribuci√≥n de influencia:</span> ${appState.weight1}% / ${appState.weight2}%
                        ${Math.abs(appState.weight1 - appState.weight2) > 20 ? 
                            `<span class="ml-2 text-yellow-300">(Dominante: ${appState.weight1 > appState.weight2 ? genreLabels[appState.genre1] : genreLabels[appState.genre2]})</span>` : 
                            ''
                        }
                    </div>
                `;
                
                if (appState.generatedImageUrl) {
                    const imageSource = appState.useImageAI && appState.imageApiKey ? 
                        `üé® Imagen generada con ${appState.imageProvider === 'openai' ? 'DALL-E 3' : 
                                                 appState.imageProvider === 'replicate' ? 'Replicate AI' :
                                                 appState.imageProvider === 'stability' ? 'Stability AI' :
                                                 appState.imageProvider === 'fal' ? 'Fal.ai Flux Pro' : 'IA'}` :
                        'üé® Imagen de placeholder (activa IA de im√°genes para generar con IA real)';
                    
                    infoHtml += `
                        <div class="mt-2 text-xs ${appState.useImageAI && appState.imageApiKey ? 'text-blue-400' : 'text-gray-400'}">
                            ${imageSource}
                        </div>
                    `;
                }
                
                infoHtml += `
                    <div class="mt-2 text-xs text-blue-400">
                        ‚úçÔ∏è Estilo: ${appState.narrativeStyle} ‚Ä¢ Profundidad: ${appState.thematicDepth}
                        ${appState.avoidCliches ? ' ‚Ä¢ Sin clich√©s' : ''}
                        ${appState.emphasizeOriginality ? ' ‚Ä¢ M√°xima originalidad' : ''}
                    </div>
                `;
                
                if (appState.useAiEnhancement && appState.aiApiKey) {
                    infoHtml += `
                        <div class="mt-2 text-xs text-green-400">
                            ü§ñ Narrativa mejorada con IA (${appState.aiProvider === 'openrouter' ? `OpenRouter: ${appState.selectedModel.split('/')[1]}` : appState.aiProvider})
                        </div>
                    `;
                }
                
                infoHtml += `
                    <div class="mt-4 text-center">
                        <p class="text-xs text-purple-300 mb-2">
                            üí° Usa el bot√≥n "Exportar como ZIP" para descargar el relato en Markdown y la imagen en JPG
                        </p>
                    </div>
                `;
                
                narrativeInfo.innerHTML = infoHtml;
            } else {
                resultContainer.classList.add('hidden');
                exportBtn.classList.add('hidden');
            }
        };

        const exportToZip = async () => {
            if (!appState.narrative) return;
            
            appState.isExporting = true;
            updateExportButton();
            
            try {
                const zip = new JSZip();
                
                const genreInfo = `${genreLabels[appState.genre1]} + ${genreLabels[appState.genre2]}`;
                const timestamp = new Date().toLocaleString('es-ES');
                
                const markdownContent = `# ${appState.generatedTitle || 'Argumento Narrativo Generado'}

**Fecha de generaci√≥n:** ${timestamp}  
**G√©neros:** ${genreInfo}  
**Distribuci√≥n:** ${appState.weight1}% / ${appState.weight2}%  
${Math.abs(appState.weight1 - appState.weight2) > 20 ? `**G√©nero dominante:** ${appState.weight1 > appState.weight2 ? genreLabels[appState.genre1] : genreLabels[appState.genre2]}` : '**Equilibrio:** Narrativa equilibrada entre ambos g√©neros'}

${appState.customElements.trim() ? `**Elementos personalizados:** ${appState.customElements}` : ''}
${appState.useAiEnhancement && appState.aiApiKey ? `**Mejorado con IA:** ${appState.aiProvider === 'openrouter' ? `OpenRouter (${appState.selectedModel.split('/')[1]})` : appState.aiProvider}` : ''}

---

## Sinopsis

${appState.narrative}

---

*Generado con el Sistema H√≠brido de Narrativas*  
*Combinaci√≥n de generaci√≥n procedural + IA opcional + im√°genes autom√°ticas*
`;

                zip.file('argumento_narrativo.md', markdownContent);
                
                if (appState.generatedImageUrl) {
                    try {
                        const response = await fetch(appState.generatedImageUrl);
                        if (response.ok) {
                            const imageBlob = await response.blob();
                            zip.file('imagen_narrativa.jpg', imageBlob);
                        }
                    } catch (imageError) {
                        console.warn('Error al procesar imagen:', imageError);
                    }
                }
                
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const downloadUrl = URL.createObjectURL(zipBlob);
                
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `narrativa_${Date.now()}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(downloadUrl);
                
            } catch (error) {
                console.error('Error al exportar:', error);
                alert('Error al generar la exportaci√≥n. Int√©ntalo de nuevo.');
            } finally {
                appState.isExporting = false;
                updateExportButton();
            }
        };

        // Funciones de UI
        const updateGenerateButton = () => {
            const btn = document.getElementById('generateBtn');
            if (appState.isEnhancing) {
                btn.innerHTML = `
                    <div class="spinner mr-2"></div>
                    Mejorando con IA...
                `;
                btn.disabled = true;
            } else if (appState.isGeneratingImage) {
                btn.innerHTML = `
                    <div class="spinner mr-2"></div>
                    Generando imagen...
                `;
                btn.disabled = true;
            } else {
                const aiFeatures = [];
                if (appState.useAiEnhancement && appState.aiApiKey) aiFeatures.push('Texto IA');
                if (appState.useImageAI && appState.imageApiKey) aiFeatures.push('Imagen IA');
                
                btn.innerHTML = `
                    ‚ú® Generar Nuevo Argumento
                    ${aiFeatures.length > 0 ? ` (${aiFeatures.join(' + ')})` : ''}
                `;
                btn.disabled = !appState.genre1 || !appState.genre2;
            }
        };

        const updateExportButton = () => {
            const btn = document.getElementById('exportBtn');
            if (appState.isExporting) {
                btn.innerHTML = `
                    <div class="spinner mr-2"></div>
                    Creando ZIP...
                `;
                btn.disabled = true;
            } else {
                btn.innerHTML = `
                    üì¶ Exportar como ZIP
                    <span class="ml-2 text-xs opacity-80">(MD + JPG)</span>
                `;
                btn.disabled = false;
            }
        };

        const updateWeightControls = () => {
            const weightControls = document.getElementById('weightControls');
            const genre1Label = document.getElementById('genre1Label');
            const genre2Label = document.getElementById('genre2Label');
            const weight1Display = document.getElementById('weight1Display');
            const weight2Display = document.getElementById('weight2Display');
            const balanceInfo = document.getElementById('balanceInfo');
            
            if (appState.genre1 && appState.genre2) {
                weightControls.classList.remove('hidden');
                genre1Label.textContent = genreLabels[appState.genre1];
                genre2Label.textContent = genreLabels[appState.genre2];
                weight1Display.textContent = `${appState.weight1}%`;
                weight2Display.textContent = `${appState.weight2}%`;
                
                if (Math.abs(appState.weight1 - appState.weight2) > 20) {
                    balanceInfo.innerHTML = `üé≠ Narrativa con fuerte influencia de ${appState.weight1 > appState.weight2 ? genreLabels[appState.genre1] : genreLabels[appState.genre2]}`;
                    balanceInfo.className = 'text-center text-xs text-yellow-400 mt-2';
                } else {
                    balanceInfo.innerHTML = '‚öñÔ∏è Narrativa equilibrada entre ambos g√©neros';
                    balanceInfo.className = 'text-center text-xs text-green-400 mt-2';
                }
            } else {
                weightControls.classList.add('hidden');
            }
        };

        const updateSliderBackground = (slider, value) => {
            slider.style.background = `linear-gradient(to right, #8b5cf6 0%, #8b5cf6 ${value}%, #374151 ${value}%, #374151 100%)`;
        };

        // Event Listeners
        document.getElementById('useAI').addEventListener('change', (e) => {
            appState.useAiEnhancement = e.target.checked;
            const aiConfig = document.getElementById('aiConfig');
            if (appState.useAiEnhancement || appState.useImageAI) {
                aiConfig.classList.remove('hidden');
            } else {
                aiConfig.classList.add('hidden');
            }
            updateGenerateButton();
        });

        document.getElementById('useImageAI').addEventListener('change', (e) => {
            appState.useImageAI = e.target.checked;
            const aiConfig = document.getElementById('aiConfig');
            if (appState.useAiEnhancement || appState.useImageAI) {
                aiConfig.classList.remove('hidden');
            } else {
                aiConfig.classList.add('hidden');
            }
            updateGenerateButton();
        });

        document.getElementById('aiProvider').addEventListener('change', (e) => {
            appState.aiProvider = e.target.value;
            const modelSelector = document.getElementById('modelSelector');
            if (appState.aiProvider === 'openrouter') {
                modelSelector.classList.remove('hidden');
            } else {
                modelSelector.classList.add('hidden');
            }
            
            const apiKeyInput = document.getElementById('aiApiKey');
            apiKeyInput.placeholder = appState.aiProvider === 'openrouter' ? 
                'Ingresa tu API key de OpenRouter' : 
                `Ingresa tu API key de ${appState.aiProvider}`;
        });

        document.getElementById('selectedModel').addEventListener('change', (e) => {
            appState.selectedModel = e.target.value;
        });

        document.getElementById('imageProvider').addEventListener('change', (e) => {
            appState.imageProvider = e.target.value;
            
            const imageApiKeyInput = document.getElementById('imageApiKey');
            const placeholders = {
                'openai': 'API key de OpenAI para DALL-E 3',
                'replicate': 'API token de Replicate',
                'stability': 'API key de Stability AI',
                'fal': 'API key de Fal.ai'
            };
            imageApiKeyInput.placeholder = placeholders[appState.imageProvider];
        });

        document.getElementById('aiApiKey').addEventListener('input', (e) => {
            appState.aiApiKey = e.target.value;
            updateGenerateButton();
        });

        document.getElementById('imageApiKey').addEventListener('input', (e) => {
            appState.imageApiKey = e.target.value;
            updateGenerateButton();
        });

        document.getElementById('customElements').addEventListener('input', (e) => {
            appState.customElements = e.target.value;
        });

        document.getElementById('narrativeStyle').addEventListener('change', (e) => {
            appState.narrativeStyle = e.target.value;
            if (appState.genre1 && appState.genre2) {
                generateNarrative();
            }
        });

        document.getElementById('thematicDepth').addEventListener('change', (e) => {
            appState.thematicDepth = e.target.value;
            if (appState.genre1 && appState.genre2) {
                generateNarrative();
            }
        });

        document.getElementById('avoidCliches').addEventListener('change', (e) => {
            appState.avoidCliches = e.target.checked;
            if (appState.genre1 && appState.genre2) {
                generateNarrative();
            }
        });

        document.getElementById('emphasizeOriginality').addEventListener('change', (e) => {
            appState.emphasizeOriginality = e.target.checked;
            if (appState.genre1 && appState.genre2) {
                generateNarrative();
            }
        });

        document.getElementById('genre1').addEventListener('change', (e) => {
            appState.genre1 = e.target.value;
            updateWeightControls();
            updateGenerateButton();
            if (appState.genre1 && appState.genre2) {
                generateNarrative();
            }
        });

        document.getElementById('genre2').addEventListener('change', (e) => {
            appState.genre2 = e.target.value;
            updateWeightControls();
            updateGenerateButton();
            if (appState.genre1 && appState.genre2) {
                generateNarrative();
            }
        });

        document.getElementById('weight1').addEventListener('input', (e) => {
            appState.weight1 = parseInt(e.target.value);
            appState.weight2 = 100 - appState.weight1;
            document.getElementById('weight2').value = appState.weight2;
            updateWeightControls();
            updateSliderBackground(e.target, appState.weight1);
            updateSliderBackground(document.getElementById('weight2'), appState.weight2);
            if (appState.genre1 && appState.genre2) {
                generateNarrative();
            }
        });

        document.getElementById('weight2').addEventListener('input', (e) => {
            appState.weight2 = parseInt(e.target.value);
            appState.weight1 = 100 - appState.weight2;
            document.getElementById('weight1').value = appState.weight1;
            updateWeightControls();
            updateSliderBackground(e.target, appState.weight2);
            updateSliderBackground(document.getElementById('weight1'), appState.weight1);
            if (appState.genre1 && appState.genre2) {
                generateNarrative();
            }
        });

        document.getElementById('generateBtn').addEventListener('click', generateNarrative);
        document.getElementById('exportBtn').addEventListener('click', exportToZip);

        // Inicializaci√≥n
        updateGenerateButton();
        updateSliderBackground(document.getElementById('weight1'), 50);
        updateSliderBackground(document.getElementById('weight2'), 50);
        document.getElementById('modelSelector').classList.remove('hidden');
    </script>
</body>
</html>
