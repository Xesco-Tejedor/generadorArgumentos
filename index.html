<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ narrativAI - Perchance Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            min-height: 100vh;
        }
        .genre-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .genre-card.selected {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }
        .genre-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }
        .loading-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .control-group {
            background: rgba(31, 41, 55, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.5);
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 bg-clip-text text-transparent mb-4">
                üé≠ narrativAI
            </h1>
            <p class="text-xl text-gray-300 mb-2">
                üìö Narrativas √©picas con elementos personalizados + Im√°genes IA reales
            </p>
            <p class="text-lg text-purple-300 mb-4">
                üé¨ Hasta 3 g√©neros balanceados + Generaci√≥n Perchance.org (GitHub Pages compatible)
            </p>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- Panel de elementos y g√©neros -->
            <div class="space-y-6">
                <!-- Elementos personalizados -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4">
                        ‚ú® Elementos personalizados (aparecen literalmente)
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">
                                üéØ Elemento principal
                            </label>
                            <input type="text" id="element1" placeholder="ej: pececillo de plata" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">
                                üî∏ Elemento secundario
                            </label>
                            <input type="text" id="element2" placeholder="ej: biblioteca gigantesca" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">
                                üèõÔ∏è Elemento de contexto
                            </label>
                            <input type="text" id="element3" placeholder="ej: libro voluminoso y antiguo" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 text-white">
                        </div>
                    </div>
                </div>

                <!-- Selecci√≥n de g√©neros -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4 flex items-center">
                        üé≠ Selecciona g√©neros (m√°ximo 3)
                        <span id="genreCount" class="ml-2 text-sm bg-purple-600 px-2 py-1 rounded-full">0/3</span>
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4" id="genreGrid">
                        <!-- G√©neros se generan din√°micamente -->
                    </div>

                    <!-- Controles de intensidad de g√©neros -->
                    <div id="genreIntensityControls" class="hidden mt-4 space-y-3">
                        <h4 class="text-sm font-medium text-purple-300 mb-3">‚öñÔ∏è Intensidad de g√©neros seleccionados</h4>
                        <div id="genreSliders" class="space-y-3">
                            <!-- Sliders se generan din√°micamente -->
                        </div>
                        <div class="text-xs text-gray-400 mt-2">
                            ‚öñÔ∏è Los g√©neros siempre suman 100% - Al ajustar uno, los otros se rebalancean autom√°ticamente
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n de generaci√≥n -->
                <button id="generateBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                    <span id="generateBtnText">üé≠ Generar Narrativa √âpica</span>
                </button>
            </div>

            <!-- Panel de configuraci√≥n de imagen IA -->
            <div class="space-y-6">
                <!-- Control principal de imagen IA -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center space-x-3 mb-4">
                        <input type="checkbox" id="useImageAI" class="w-5 h-5 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                        <label for="useImageAI" class="text-lg font-semibold text-purple-400">
                            üé® Generar imagen IA real (Perchance.org)
                        </label>
                    </div>
                    
                    <div id="imageAIInfo" class="hidden mt-2 p-3 bg-blue-900/20 border border-blue-500/30 rounded text-sm text-blue-300">
                        üé® <strong>Imagen IA real:</strong> Se analizar√° tu narrativa para crear una imagen √∫nica usando Perchance.org<br />
                        <small class="opacity-80">‚úÖ 100% compatible con GitHub Pages - Generaci√≥n real garantizada</small>
                    </div>

                    <!-- Controles avanzados de imagen -->
                    <div id="imageControlsSection" class="hidden mt-4 space-y-4">
                        <!-- Dimensiones y orientaci√≥n -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">üìê Dimensiones y orientaci√≥n</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Ancho</label>
                                    <select id="imageWidth" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                        <option value="512">512px</option>
                                        <option value="768">768px</option>
                                        <option value="1024" selected>1024px</option>
                                        <option value="1280">1280px</option>
                                        <option value="1536">1536px</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Alto</label>
                                    <select id="imageHeight" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                        <option value="512">512px</option>
                                        <option value="768" selected>768px</option>
                                        <option value="1024">1024px</option>
                                        <option value="1280">1280px</option>
                                        <option value="1536">1536px</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-2 flex gap-2">
                                <button onclick="setAspectRatio(1024, 768)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs">4:3</button>
                                <button onclick="setAspectRatio(1024, 576)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs">16:9</button>
                                <button onclick="setAspectRatio(768, 1024)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs">3:4</button>
                                <button onclick="setAspectRatio(1024, 1024)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs">1:1</button>
                            </div>
                        </div>

                        <!-- Estilo art√≠stico -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">üé® Estilo art√≠stico</h4>
                            <select id="artStyle" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                <option value="auto">Autom√°tico (basado en narrativa)</option>
                                <option value="photorealistic">üì∏ Fotorrealista</option>
                                <option value="digital-art">üñ•Ô∏è Arte digital</option>
                                <option value="oil-painting">üé® Pintura al √≥leo</option>
                                <option value="watercolor">üåä Acuarela</option>
                                <option value="pencil-sketch">‚úèÔ∏è Boceto a l√°piz</option>
                                <option value="comic-book">üìö Estilo c√≥mic</option>
                                <option value="anime">üáØüáµ Anime/manga</option>
                                <option value="fantasy-art">üßô‚Äç‚ôÇÔ∏è Arte fant√°stico</option>
                                <option value="sci-fi">üöÄ Ciencia ficci√≥n</option>
                                <option value="gothic">ü¶á G√≥tico</option>
                                <option value="impressionist">üåÖ Impresionista</option>
                                <option value="surreal">üåÄ Surrealista</option>
                                <option value="mignola-style">üé≠ Estilo Mike Mignola</option>
                                <option value="frazetta-style">‚öîÔ∏è Estilo Frank Frazetta</option>
                            </select>
                        </div>

                        <!-- Composici√≥n de imagen -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">üìê Composici√≥n de imagen</h4>
                            <select id="imageComposition" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                <option value="auto">Autom√°tica (basada en narrativa)</option>
                                <option value="centered">üéØ Centrada - Elemento principal en el centro</option>
                                <option value="rule-of-thirds">üìè Regla de tercios - Composici√≥n equilibrada</option>
                                <option value="close-up">üîç Primer plano - Enfoque cercano al sujeto</option>
                                <option value="medium-shot">üë§ Plano medio - Vista balanceada</option>
                                <option value="wide-shot">üåÖ Plano general - Vista amplia del escenario</option>
                                <option value="bird-eye">ü¶Ö Vista de p√°jaro - Desde arriba</option>
                                <option value="worm-eye">üêõ Vista de gusano - Desde abajo</option>
                                <option value="diagonal">üìê Diagonal - L√≠neas din√°micas</option>
                                <option value="symmetrical">‚öñÔ∏è Sim√©trica - Balance perfecto</option>
                                <option value="asymmetrical">üé≠ Asim√©trica - Balance din√°mico</option>
                                <option value="golden-ratio">üåü Proporci√≥n √°urea - Composici√≥n cl√°sica</option>
                            </select>
                        </div>

                        <!-- Estructura de escena -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">üèóÔ∏è Estructura de escena</h4>
                            <select id="sceneStructure" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                <option value="auto">Autom√°tica (basada en elementos)</option>
                                <option value="single-focus">üéØ Foco √∫nico - Un elemento principal</option>
                                <option value="multiple-elements">üé™ M√∫ltiples elementos - Varios puntos de inter√©s</option>
                                <option value="foreground-background">üé≠ Primer plano y fondo - Profundidad</option>
                                <option value="layered">üìö Por capas - M√∫ltiples niveles de profundidad</option>
                                <option value="environmental">üåç Ambiental - El entorno como protagonista</option>
                                <option value="character-focused">üë§ Enfoque en personaje - Protagonista destacado</option>
                                <option value="action-scene">‚ö° Escena de acci√≥n - Movimiento y dinamismo</option>
                                <option value="contemplative">üßò Contemplativa - Atm√≥sfera reflexiva</option>
                                <option value="dramatic">üé≠ Dram√°tica - Alta tensi√≥n emocional</option>
                                <option value="minimalist">‚ö™ Minimalista - Elementos esenciales</option>
                                <option value="complex">üîÄ Compleja - Rica en detalles</option>
                            </select>
                        </div>

                        <!-- Iluminaci√≥n y atm√≥sfera -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">üí° Iluminaci√≥n y atm√≥sfera</h4>
                            <select id="lighting" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                <option value="auto">Autom√°tica (basada en g√©nero)</option>
                                <option value="natural-daylight">‚òÄÔ∏è Luz natural diurna - Iluminaci√≥n clara</option>
                                <option value="golden-hour">üåÖ Hora dorada - Luz c√°lida y suave</option>
                                <option value="blue-hour">üåÜ Hora azul - Atm√≥sfera crepuscular</option>
                                <option value="dramatic-shadows">üåì Sombras dram√°ticas - Alto contraste</option>
                                <option value="soft-lighting">üí° Iluminaci√≥n suave - Ambiente tranquilo</option>
                                <option value="backlighting">üîÜ Contraluz - Siluetas y halos</option>
                                <option value="candle-fire">üïØÔ∏è Velas/fuego - Iluminaci√≥n c√°lida y danzante</option>
                                <option value="moonlight">üåô Luz de luna - Atm√≥sfera nocturna</option>
                                <option value="magical-glow">‚ú® Resplandor m√°gico - Iluminaci√≥n fant√°stica</option>
                                <option value="neon-cyberpunk">üåà Ne√≥n cyberpunk - Colores vibrantes</option>
                                <option value="mysterious-fog">üå´Ô∏è Niebla misteriosa - Atm√≥sfera enigm√°tica</option>
                            </select>
                        </div>

                        <!-- Modelo de IA -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">ü§ñ Modelo de IA</h4>
                            <select id="aiModel" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                <option value="standard" selected>Standard (equilibrado)</option>
                                <option value="artistic">Artistic (m√°s creativo)</option>
                                <option value="photogenic">Photogenic (m√°s realista)</option>
                                <option value="anime">Anime (estilo japon√©s)</option>
                                <option value="furry">Furry (personajes antropom√≥rficos)</option>
                            </select>
                        </div>

                        <!-- Configuraci√≥n avanzada -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">‚öôÔ∏è Configuraci√≥n avanzada</h4>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">
                                        Intensidad del prompt: <span id="promptStrengthValue">7</span>
                                    </label>
                                    <input type="range" id="promptStrength" min="1" max="10" value="7" 
                                           class="w-full accent-purple-500"
                                           oninput="document.getElementById('promptStrengthValue').textContent = this.value">
                                </div>

                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">
                                        Nivel de detalle: <span id="detailLevelValue">Medio</span>
                                    </label>
                                    <select id="detailLevel" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm"
                                            onchange="document.getElementById('detailLevelValue').textContent = this.options[this.selectedIndex].text">
                                        <option value="low">Bajo</option>
                                        <option value="medium" selected>Medio</option>
                                        <option value="high">Alto</option>
                                        <option value="ultra">Ultra detallado</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Semilla (seed) - para reproducibilidad</label>
                                    <div class="flex gap-2">
                                        <input type="number" id="imageSeed" placeholder="Autom√°tica" 
                                               class="flex-1 p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                        <button onclick="randomizeSeed()" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded text-xs">
                                            üé≤
                                        </button>
                                    </div>
                                </div>

                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="enhancePrompt" checked class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded">
                                    <label for="enhancePrompt" class="text-xs text-gray-400">
                                        ‚ú® Mejorar prompt autom√°ticamente
                                    </label>
                                </div>

                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="negativeSafety" checked class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded">
                                    <label for="negativeSafety" class="text-xs text-gray-400">
                                        üõ°Ô∏è Filtros de seguridad
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista previa del prompt -->
                <div id="promptPreview" class="hidden bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4">üëÅÔ∏è Vista previa del prompt</h3>
                    <div id="promptText" class="bg-gray-900/50 rounded-lg p-4 text-sm text-gray-300 font-mono leading-relaxed"></div>
                </div>
            </div>

            <!-- Panel de resultados -->
            <div class="space-y-6">
                <!-- Narrativa generada -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4">üìñ Narrativa Generada</h3>
                    
                    <div id="narrativePlaceholder" class="text-center text-gray-400 py-12">
                        <div class="text-4xl mb-3">üìö</div>
                        <p>Configura elementos y g√©neros para generar tu narrativa √©pica</p>
                    </div>
                    
                    <div id="narrativeContent" class="hidden">
                        <div class="bg-gray-900/50 rounded-lg border-l-4 border-purple-500 p-4">
                            <div id="narrativeText" class="text-gray-100 leading-relaxed"></div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 mt-4">
                            <button id="downloadZipBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                üì¶ Descargar Proyecto (.zip)
                            </button>
                            <button id="regenerateBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                üé≠ Regenerar
                            </button>
                        </div>
                    </div>
                    
                    <div id="loadingNarrative" class="hidden text-center py-8">
                        <div class="loading-animation text-4xl mb-3">üé≠</div>
                        <p class="text-purple-300">Creando tu narrativa √©pica...</p>
                    </div>
                </div>

                <!-- √Årea de im√°genes -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-purple-400">üé® Galer√≠a de Im√°genes IA</h3>
                        <button onclick="clearImageHistory()" id="clearHistoryBtn" class="hidden px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">
                            üóëÔ∏è Limpiar
                        </button>
                    </div>
                    
                    <div id="imagePlaceholder" class="text-center text-gray-400 py-8 border-2 border-dashed border-gray-600 rounded-lg">
                        <div class="text-3xl mb-2">üé®</div>
                        <div id="placeholderMessage">
                            <p class="text-sm">Activa la generaci√≥n de IA para crear im√°genes basadas en tu narrativa</p>
                            <p class="text-xs mt-1 opacity-75">‚úÖ Las im√°genes se acumular√°n en l√≠neas hasta cambiar el prompt</p>
                        </div>
                        <div id="readyMessage" class="hidden">
                            <p class="text-sm text-green-300">‚úÖ Imagen IA activada - Genera una narrativa para crear la imagen</p>
                            <p class="text-xs mt-1 opacity-75">üé≠ El sistema crear√° autom√°ticamente una imagen basada en tu historia</p>
                        </div>
                    </div>
                    
                    <div id="loadingImage" class="hidden text-center py-8 border-2 border-dashed border-purple-500 rounded-lg">
                        <div class="loading-animation text-3xl mb-2">üé®</div>
                        <p class="text-purple-300 text-sm">Generando imagen IA real...</p>
                        <p class="text-xs text-purple-400 mt-1">Analizando narrativa con Perchance.org</p>
                    </div>
                    
                    <!-- Galer√≠a de im√°genes -->
                    <div id="imageGallery" class="hidden space-y-4">
                        <!-- Las im√°genes se a√±adir√°n aqu√≠ din√°micamente -->
                    </div>
                    
                    <div id="imageStatus" class="mt-3 p-2 bg-green-900/30 rounded border border-green-500/50 text-xs text-green-300 hidden">
                        <!-- Status se actualiza din√°micamente -->
                    </div>

                    <!-- Controles de imagen generada -->
                    <div id="imageControls" class="hidden mt-4 flex flex-wrap gap-2">
                        <button onclick="regenerateImage()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm">
                            üîÑ Generar Variaci√≥n
                        </button>
                        <button onclick="downloadCompleteProject()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-sm">
                            üì¶ Descargar Proyecto (.zip)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado de la aplicaci√≥n
        let appState = {
            selectedGenres: [],
            genreIntensities: {}, // Intensidades de g√©neros
            generatedNarrative: '',
            useImageAI: false,
            currentImageUrl: '',
            currentImagePrompt: '',
            isGenerating: false,
            imageHistory: [], // Historial de im√°genes por prompt
            currentPromptHash: null // Hash del prompt actual para detectar cambios
        };

        // G√©neros disponibles
        const genres = {
            'terror': { name: 'Terror', icon: 'üëª', color: 'from-red-600 to-red-800' },
            'fantasia': { name: 'Fantas√≠a', icon: 'üßô‚Äç‚ôÇÔ∏è', color: 'from-purple-600 to-purple-800' },
            'romance': { name: 'Romance', icon: 'üíï', color: 'from-pink-600 to-pink-800' },
            'misterio': { name: 'Misterio', icon: 'üîç', color: 'from-yellow-600 to-yellow-800' },
            'ciencia-ficcion': { name: 'Ciencia Ficci√≥n', icon: 'üöÄ', color: 'from-blue-600 to-blue-800' },
            'aventura': { name: 'Aventura', icon: '‚öîÔ∏è', color: 'from-green-600 to-green-800' },
            'comedia': { name: 'Comedia', icon: 'üòÑ', color: 'from-orange-600 to-orange-800' },
            'drama': { name: 'Drama', icon: 'üé≠', color: 'from-indigo-600 to-indigo-800' }
        };

        // Crear elementos de g√©nero
        function createGenreElements() {
            const genreGrid = document.getElementById('genreGrid');
            
            Object.keys(genres).forEach(genreId => {
                const genre = genres[genreId];
                const genreCard = document.createElement('div');
                genreCard.className = `genre-card bg-gradient-to-br ${genre.color} p-4 rounded-lg cursor-pointer text-center`;
                genreCard.dataset.genreId = genreId;
                
                genreCard.innerHTML = `
                    <div class="text-2xl mb-2">${genre.icon}</div>
                    <div class="text-sm font-medium">${genre.name}</div>
                `;
                
                genreCard.addEventListener('click', () => toggleGenre(genreId));
                genreGrid.appendChild(genreCard);
            });
        }

        // Alternar selecci√≥n de g√©nero
        function toggleGenre(genreId) {
            const genreCard = document.querySelector(`[data-genre-id="${genreId}"]`);
            const isSelected = appState.selectedGenres.includes(genreId);
            
            if (isSelected) {
                appState.selectedGenres = appState.selectedGenres.filter(g => g !== genreId);
                genreCard.classList.remove('selected');
                delete appState.genreIntensities[genreId];
            } else {
                if (appState.selectedGenres.length < 3) {
                    appState.selectedGenres.push(genreId);
                    genreCard.classList.add('selected');
                    appState.genreIntensities[genreId] = 70; // Intensidad por defecto
                } else {
                    alert('M√°ximo 3 g√©neros permitidos. Deselecciona uno primero.');
                    return;
                }
            }
            
            updateGenreCount();
            updateGenreIntensityControls();
            updatePromptPreview();
        }

        // Actualizar controles de intensidad de g√©neros
        function updateGenreIntensityControls() {
            const controlsSection = document.getElementById('genreIntensityControls');
            const slidersContainer = document.getElementById('genreSliders');
            
            if (appState.selectedGenres.length === 0) {
                controlsSection.classList.add('hidden');
                return;
            }
            
            controlsSection.classList.remove('hidden');
            slidersContainer.innerHTML = '';
            
            // Inicializar intensidades para que sumen 100
            initializeIntensitiesTo100();
            
            // Crear indicador de total
            const totalIndicatorHtml = `
                <div class="mb-3 p-2 bg-gray-900/50 rounded-lg border border-gray-600">
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-400">Total:</span>
                        <span id="totalIntensity" class="text-purple-300 font-semibold">100%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-1 mt-1">
                        <div id="totalBar" class="bg-purple-500 h-1 rounded-full transition-all duration-300" style="width: 100%"></div>
                    </div>
                </div>
            `;
            
            slidersContainer.innerHTML = totalIndicatorHtml;
            
            appState.selectedGenres.forEach(genreId => {
                const genre = genres[genreId];
                const intensity = appState.genreIntensities[genreId] || Math.floor(100 / appState.selectedGenres.length);
                
                const sliderHtml = `
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center space-x-2 min-w-0 flex-1">
                            <span class="text-lg">${genre.icon}</span>
                            <span class="text-sm text-gray-300 truncate">${genre.name}</span>
                        </div>
                        <div class="flex items-center space-x-2 min-w-0 flex-1">
                            <input type="range" 
                                   id="intensity-${genreId}" 
                                   min="1" 
                                   max="98" 
                                   value="${intensity}"
                                   class="flex-1 accent-purple-500"
                                   oninput="updateGenreIntensity('${genreId}', this.value)">
                            <span id="intensity-value-${genreId}" class="text-xs text-purple-300 min-w-[3rem] text-right">
                                ${intensity}%
                            </span>
                        </div>
                    </div>
                `;
                
                slidersContainer.innerHTML += sliderHtml;
            });
            
            updateTotalIndicator();
        }
        
        // Inicializar intensidades para que sumen exactamente 100
        function initializeIntensitiesTo100() {
            const numGenres = appState.selectedGenres.length;
            if (numGenres === 0) return;
            
            // Distribuir equitativamente
            const baseValue = Math.floor(100 / numGenres);
            const remainder = 100 - (baseValue * numGenres);
            
            appState.selectedGenres.forEach((genreId, index) => {
                appState.genreIntensities[genreId] = baseValue + (index < remainder ? 1 : 0);
            });
        }
        
        // Actualizar indicador de total
        function updateTotalIndicator() {
            const total = appState.selectedGenres.reduce((sum, id) => sum + (appState.genreIntensities[id] || 0), 0);
            const totalSpan = document.getElementById('totalIntensity');
            const totalBar = document.getElementById('totalBar');
            
            if (totalSpan) {
                totalSpan.textContent = `${total}%`;
                totalSpan.className = total === 100 ? 'text-green-300 font-semibold' : 'text-yellow-300 font-semibold';
            }
            
            if (totalBar) {
                totalBar.style.width = `${Math.min(total, 100)}%`;
                totalBar.className = total === 100 ? 
                    'bg-green-500 h-1 rounded-full transition-all duration-300' : 
                    'bg-yellow-500 h-1 rounded-full transition-all duration-300';
            }
        }

        // Actualizar intensidad de g√©nero espec√≠fico manteniendo suma = 100
        window.updateGenreIntensity = function(genreId, value) {
            const newValue = parseInt(value);
            const oldValue = appState.genreIntensities[genreId] || 0;
            const difference = newValue - oldValue;
            
            // Actualizar el valor del g√©nero modificado
            appState.genreIntensities[genreId] = newValue;
            
            // Reajustar los otros g√©neros proporcionalmente
            const otherGenres = appState.selectedGenres.filter(id => id !== genreId);
            
            if (otherGenres.length > 0) {
                // Calcular el total actual de otros g√©neros
                let otherTotal = otherGenres.reduce((sum, id) => sum + (appState.genreIntensities[id] || 0), 0);
                
                // El resto debe ser 100 - valor actual
                const targetOtherTotal = 100 - newValue;
                
                if (targetOtherTotal > 0 && otherTotal > 0) {
                    // Reajustar proporcionalmente
                    const ratio = targetOtherTotal / otherTotal;
                    
                    otherGenres.forEach(id => {
                        const currentValue = appState.genreIntensities[id] || 0;
                        const adjustedValue = Math.max(1, Math.round(currentValue * ratio));
                        appState.genreIntensities[id] = adjustedValue;
                        
                        // Actualizar el slider y el texto
                        const slider = document.getElementById(`intensity-${id}`);
                        const valueSpan = document.getElementById(`intensity-value-${id}`);
                        if (slider) slider.value = adjustedValue;
                        if (valueSpan) valueSpan.textContent = `${adjustedValue}%`;
                    });
                } else if (targetOtherTotal > 0) {
                    // Distribuir equitativamente si no hay valores previos
                    const equalValue = Math.floor(targetOtherTotal / otherGenres.length);
                    let remainder = targetOtherTotal - (equalValue * otherGenres.length);
                    
                    otherGenres.forEach((id, index) => {
                        const adjustedValue = equalValue + (index < remainder ? 1 : 0);
                        appState.genreIntensities[id] = adjustedValue;
                        
                        const slider = document.getElementById(`intensity-${id}`);
                        const valueSpan = document.getElementById(`intensity-value-${id}`);
                        if (slider) slider.value = adjustedValue;
                        if (valueSpan) valueSpan.textContent = `${adjustedValue}%`;
                    });
                }
            }
            
            // Actualizar el valor del g√©nero actual
            const valueSpan = document.getElementById(`intensity-value-${genreId}`);
            if (valueSpan) {
                valueSpan.textContent = `${newValue}%`;
            }
            
            // Actualizar indicador de total
            updateTotalIndicator();
            
            // Mostrar total actual para debug
            const total = appState.selectedGenres.reduce((sum, id) => sum + (appState.genreIntensities[id] || 0), 0);
            console.log(`üìä Total intensidades: ${total}%`, appState.genreIntensities);
            
            updatePromptPreview();
        };

        // Actualizar contador de g√©neros
        function updateGenreCount() {
            const genreCount = document.getElementById('genreCount');
            genreCount.textContent = `${appState.selectedGenres.length}/3`;
        }

        // Generar narrativa √©pica con intensidades
        function generateNarrative() {
            const element1 = document.getElementById('element1').value.trim();
            const element2 = document.getElementById('element2').value.trim();
            const element3 = document.getElementById('element3').value.trim();
            
            if (!element1 && !element2 && !element3) {
                throw new Error('Ingresa al menos un elemento personalizado.');
            }
            
            if (appState.selectedGenres.length === 0) {
                throw new Error('Selecciona al menos un g√©nero.');
            }
            
            const elements = [element1, element2, element3].filter(Boolean);
            const genreNames = appState.selectedGenres.map(id => genres[id].name);
            
            // Generar narrativa √©pica con intensidades
            const dominantGenres = appState.selectedGenres
                .map(id => ({
                    id,
                    name: genreNames[appState.selectedGenres.indexOf(id)],
                    intensity: appState.genreIntensities[id] || 70
                }))
                .sort((a, b) => b.intensity - a.intensity);

            let narrativeStyle = '';
            if (dominantGenres[0]?.intensity > 85) {
                narrativeStyle = `Con una fuerte influencia de ${dominantGenres[0].name.toLowerCase()}, `;
            } else if (dominantGenres.length > 1 && dominantGenres[0]?.intensity > 70) {
                narrativeStyle = `Balanceando elementos de ${dominantGenres.map(g => g.name.toLowerCase()).join(' y ')}, `;
            }

            // Narrativas √©picas mejoradas
            const narratives = [
                `${narrativeStyle}en las profundidades de ${element2 || 'un lugar misterioso'}, donde ${element3 || 'objetos antiguos'} guardan secretos milenarios, ${element1 || 'nuestro protagonista'} descubre que su destino est√° entrelazado con fuerzas m√°s all√° de su comprensi√≥n.`,

                `${narrativeStyle}cuando ${element1 || 'el protagonista'} se encuentra frente a ${element2 || 'lo desconocido'}, la presencia de ${element3 || 'elementos m√≠sticos'} revela verdades que cambiar√°n el curso de esta historia donde ${genreNames.join(' y ').toLowerCase()} se entrelazan.`,

                `Los elementos se entrelazan en una danza c√≥smica: ${elements.join(', ')} se convierten en las piezas fundamentales de una narrativa que ${narrativeStyle}trasciende los g√©neros de ${genreNames.join(', ')}, creando algo completamente nuevo y extraordinario.`,

                `En este universo donde ${genreNames.join(' se fusiona con ')} en perfecta armon√≠a, ${narrativeStyle}cada elemento cobra vida propia. ${element1 || 'El protagonista'} debe navegar entre ${element2 || 'm√∫ltiples realidades'} mientras ${element3 || 'fuerzas ancestrales'} despiertan para revelar los secretos m√°s profundos de la existencia.`
            ];
            
            return narratives.join('\n\n');
        }

        // Analizar texto narrativo para imagen
        function analyzeNarrativeForImage(narrative) {
            const lowerText = narrative.toLowerCase();
            let sceneElements = [];
            let mood = 'epic';
            let setting = 'mysterious realm';
            
            // Detectar elementos de escena
            if (lowerText.includes('biblioteca')) sceneElements.push('ancient library');
            if (lowerText.includes('bosque')) sceneElements.push('mystical forest');
            if (lowerText.includes('castillo')) sceneElements.push('medieval castle');
            if (lowerText.includes('oc√©ano') || lowerText.includes('mar')) sceneElements.push('vast ocean');
            if (lowerText.includes('monta√±a')) sceneElements.push('towering mountains');
            if (lowerText.includes('ciudad')) sceneElements.push('grand cityscape');
            
            // Detectar mood
            if (lowerText.includes('oscur') || lowerText.includes('sombra')) mood = 'dark and mysterious';
            else if (lowerText.includes('m√°gic')) mood = 'magical and enchanting';
            else if (lowerText.includes('rom√°ntic')) mood = 'romantic and warm';
            else if (lowerText.includes('√©pic')) mood = 'epic and grandiose';
            
            return { sceneElements, mood, setting };
        }

        // Crear prompt para imagen IA
        function createImagePrompt(narrative, customElements) {
            console.log('üé® Creando prompt de imagen basado en narrativa...');
            
            const analysis = analyzeNarrativeForImage(narrative);
            const artStyleElement = document.getElementById('artStyle');
            const detailLevelElement = document.getElementById('detailLevel');
            const enhancePromptElement = document.getElementById('enhancePrompt');
            const compositionElement = document.getElementById('imageComposition');
            const structureElement = document.getElementById('sceneStructure');
            const lightingElement = document.getElementById('lighting');
            
            const artStyle = artStyleElement ? artStyleElement.value : 'auto';
            const detailLevel = detailLevelElement ? detailLevelElement.value : 'medium';
            const enhancePrompt = enhancePromptElement ? enhancePromptElement.checked : true;
            const composition = compositionElement ? compositionElement.value : 'auto';
            const structure = structureElement ? structureElement.value : 'auto';
            const lighting = lightingElement ? lightingElement.value : 'auto';
            
            let promptParts = [];
            
            // A√±adir elementos personalizados
            if (customElements.length > 0) {
                customElements.forEach((element, index) => {
                    if (index === 0) {
                        promptParts.push(`${translateElementToEnglish(element)} as main character`);
                    } else {
                        promptParts.push(`${translateElementToEnglish(element)} in scene`);
                    }
                });
            }
            
            // A√±adir an√°lisis de escena
            if (analysis.sceneElements.length > 0) {
                promptParts.push(`set in ${analysis.sceneElements.join(' and ')}`);
            }
            
            promptParts.push(`${analysis.mood} atmosphere`);
            
            // Aplicar composici√≥n espec√≠fica
            const compositionPrompts = {
                'centered': 'centered composition, main subject in center',
                'rule-of-thirds': 'rule of thirds composition, balanced layout',
                'close-up': 'close-up shot, detailed view',
                'medium-shot': 'medium shot, balanced framing',
                'wide-shot': 'wide shot, panoramic view',
                'bird-eye': 'bird\'s eye view, top-down perspective',
                'worm-eye': 'worm\'s eye view, low angle perspective',
                'diagonal': 'diagonal composition, dynamic lines',
                'symmetrical': 'symmetrical composition, perfect balance',
                'asymmetrical': 'asymmetrical composition, dynamic balance',
                'golden-ratio': 'golden ratio composition, classical proportions'
            };
            
            if (composition !== 'auto') {
                promptParts.push(compositionPrompts[composition]);
            }
            
            // Aplicar estructura de escena
            const structurePrompts = {
                'single-focus': 'single focal point, clear main subject',
                'multiple-elements': 'multiple elements, complex scene',
                'foreground-background': 'clear foreground and background, depth of field',
                'layered': 'layered composition, multiple depth levels',
                'environmental': 'environmental storytelling, setting as character',
                'character-focused': 'character-focused, portrait-style',
                'action-scene': 'dynamic action scene, movement and energy',
                'contemplative': 'contemplative mood, peaceful atmosphere',
                'dramatic': 'dramatic scene, high emotional tension',
                'minimalist': 'minimalist composition, essential elements only',
                'complex': 'complex detailed scene, rich in elements'
            };
            
            if (structure !== 'auto') {
                promptParts.push(structurePrompts[structure]);
            }
            
            // Aplicar iluminaci√≥n espec√≠fica
            const lightingPrompts = {
                'natural-daylight': 'natural daylight, bright clear lighting',
                'golden-hour': 'golden hour lighting, warm soft glow',
                'blue-hour': 'blue hour lighting, twilight atmosphere',
                'dramatic-shadows': 'dramatic shadows, high contrast lighting',
                'soft-lighting': 'soft lighting, gentle illumination',
                'backlighting': 'backlighting, rim lighting, silhouettes',
                'candle-fire': 'candlelight, firelight, warm flickering illumination',
                'moonlight': 'moonlight, nocturnal lighting, silver glow',
                'magical-glow': 'magical glow, mystical lighting, ethereal',
                'neon-cyberpunk': 'neon lighting, cyberpunk aesthetic, vibrant colors',
                'mysterious-fog': 'mysterious fog, atmospheric haze, enigmatic'
            };
            
            if (lighting !== 'auto') {
                promptParts.push(lightingPrompts[lighting]);
            }
            
            // Aplicar estilo art√≠stico
            const stylePrompts = {
                'photorealistic': 'photorealistic, highly detailed, professional photography',
                'digital-art': 'digital art, concept art style, highly detailed illustration',
                'oil-painting': 'oil painting, classical art style, rich textures',
                'watercolor': 'watercolor painting, soft colors, artistic brushstrokes',
                'pencil-sketch': 'pencil sketch, detailed drawing, artistic shading',
                'comic-book': 'comic book style, bold colors, dynamic composition',
                'anime': 'anime style, manga art, vibrant colors',
                'fantasy-art': 'fantasy art, magical realism, ethereal beauty',
                'sci-fi': 'science fiction art, futuristic, technology aesthetic',
                'gothic': 'gothic art style, dark atmosphere, dramatic shadows',
                'impressionist': 'impressionist painting style, soft light, artistic technique',
                'surreal': 'surreal art, dreamlike, impossible geometries',
                'mignola-style': 'Mike Mignola art style, dramatic shadows, bold contrasts, simplified forms',
                'frazetta-style': 'Frank Frazetta art style, heroic fantasy, powerful anatomy, dramatic lighting'
            };
            
            if (artStyle !== 'auto') {
                promptParts.push(stylePrompts[artStyle]);
            }
            
            // A√±adir nivel de detalle
            const detailPrompts = {
                'low': 'simple, clean',
                'medium': 'detailed, well composed',
                'high': 'highly detailed, intricate',
                'ultra': 'ultra detailed, masterpiece quality, perfect composition'
            };
            
            promptParts.push(detailPrompts[detailLevel]);
            
            // Mejorar prompt autom√°ticamente
            if (enhancePrompt) {
                promptParts.push('professional artwork, beautiful composition, dramatic lighting');
            }
            
            const finalPrompt = promptParts.join(', ');
            console.log('‚úÖ Prompt creado:', finalPrompt);
            
            return finalPrompt;
        }

        // Traducir elementos al ingl√©s (simple)
        function translateElementToEnglish(element) {
            const translations = {
                'pececillo de plata': 'silverfish creature',
                'biblioteca': 'library',
                'libro': 'book',
                'bosque': 'forest',
                'castillo': 'castle',
                'espada': 'sword',
                'drag√≥n': 'dragon',
                'mago': 'wizard',
                'princesa': 'princess',
                'caballero': 'knight'
            };
            
            const lowerElement = element.toLowerCase();
            return translations[lowerElement] || element;
        }

        // Generar imagen usando API simplificada m√°s compatible
        async function generatePerchanceImage(prompt) {
            console.log('üé® Generando imagen IA real...');
            
            const imageWidthElement = document.getElementById('imageWidth');
            const imageHeightElement = document.getElementById('imageHeight');
            const imageSeedElement = document.getElementById('imageSeed');
            
            const width = imageWidthElement ? imageWidthElement.value : '1024';
            const height = imageHeightElement ? imageHeightElement.value : '768';
            const seed = imageSeedElement ? (imageSeedElement.value || Math.floor(Math.random() * 1000000)) : Math.floor(Math.random() * 1000000);
            
            // APIs optimizadas para GitHub Pages
            const imageAPIs = [
                // API 1: Pollinations.ai (m√°s confiable)
                {
                    name: 'Pollinations',
                    generateUrl: () => {
                        const cleanPrompt = prompt.replace(/[^a-zA-Z0-9\s,.-]/g, ' ').trim();
                        return `https://image.pollinations.ai/prompt/${encodeURIComponent(cleanPrompt)}?width=${width}&height=${height}&seed=${seed}&nologo=true`;
                    }
                },
                // API 2: Imagen alternativa
                {
                    name: 'ImageAI',
                    generateUrl: () => {
                        const simplePrompt = prompt.split(',').slice(0, 3).join(' ').replace(/[^a-zA-Z0-9\s]/g, ' ').trim();
                        return `https://api.deepai.org/api/text2img?text=${encodeURIComponent(simplePrompt)}&width=${width}&height=${height}`;
                    }
                },
                // API 3: Fallback visual mejorado
                {
                    name: 'Visual_Fallback',
                    generateUrl: () => {
                        const imageId = Math.floor(Math.random() * 1000) + seed % 1000;
                        return `https://picsum.photos/${width}/${height}?random=${imageId}`;
                    }
                }
            ];
            
            // Intentar cada API con mayor tolerancia
            for (let i = 0; i < imageAPIs.length; i++) {
                const api = imageAPIs[i];
                console.log(`üîÑ Probando API ${i + 1}/${imageAPIs.length}: ${api.name}`);
                
                try {
                    const imageUrl = api.generateUrl();
                    console.log(`üîó URL generada (${api.name}):`, imageUrl);
                    
                    // Verificaci√≥n simplificada con mayor timeout
                    const result = await new Promise((resolve, reject) => {
                        const img = new Image();
                        
                        const timeout = setTimeout(() => {
                            reject(new Error(`Timeout en ${api.name} (15s)`));
                        }, 15000); // Mayor timeout
                        
                        img.onload = () => {
                            clearTimeout(timeout);
                            console.log(`‚úÖ ${api.name} exitoso!`);
                            resolve({
                                url: imageUrl,
                                prompt: prompt,
                                width: width,
                                height: height,
                                seed: seed,
                                api: api.name
                            });
                        };
                        
                        img.onerror = (error) => {
                            clearTimeout(timeout);
                            console.warn(`‚ùå ${api.name} fall√≥ en carga:`, error);
                            reject(new Error(`Error cargando imagen de ${api.name}`));
                        };
                        
                        // No usar crossOrigin para evitar problemas CORS
                        img.src = imageUrl;
                    });
                    
                    return result;
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è API ${api.name} fall√≥:`, error.message);
                    
                    if (i === imageAPIs.length - 1) {
                        // En lugar de fallar, crear una imagen de placeholder con informaci√≥n
                        console.log('üé® Creando imagen de informaci√≥n como √∫ltimo recurso...');
                        return {
                            url: createInfoImage(prompt, width, height),
                            prompt: prompt,
                            width: width,
                            height: height,
                            seed: seed,
                            api: 'Info_Placeholder'
                        };
                    }
                }
            }
        }

        // Crear imagen de informaci√≥n cuando fallan todas las APIs
        function createInfoImage(prompt, width, height) {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // Fondo degradado
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, '#4F46E5');
            gradient.addColorStop(1, '#7C3AED');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            // Texto
            ctx.fillStyle = 'white';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üé® Imagen IA', width/2, height/2 - 40);
            
            ctx.font = '16px Arial';
            ctx.fillText('Prompt: ' + prompt.substring(0, 50) + '...', width/2, height/2);
            
            ctx.font = '14px Arial';
            ctx.fillText(`${width}x${height}`, width/2, height/2 + 30);
            
            ctx.fillText('‚ö†Ô∏è APIs temporalmente no disponibles', width/2, height/2 + 60);
            
            return canvas.toDataURL();
        }

        // Generar hash simple para comparar prompts
        function generatePromptHash(prompt) {
            let hash = 0;
            for (let i = 0; i < prompt.length; i++) {
                const char = prompt.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return hash.toString();
        }

        // Mostrar imagen generada en la galer√≠a
        function displayImage(imageResult) {
            const placeholder = document.getElementById('imagePlaceholder');
            const gallery = document.getElementById('imageGallery');
            const controls = document.getElementById('imageControls');
            const status = document.getElementById('imageStatus');
            const clearBtn = document.getElementById('clearHistoryBtn');
            
            appState.currentImageUrl = imageResult.url;
            appState.currentImagePrompt = imageResult.prompt;
            
            // Generar hash del prompt para detectar cambios
            const promptHash = generatePromptHash(imageResult.prompt);
            
            // Verificar si el prompt ha cambiado
            const promptChanged = appState.currentPromptHash !== null && appState.currentPromptHash !== promptHash;
            
            if (promptChanged) {
                console.log('üîÑ Prompt cambi√≥, iniciando nueva l√≠nea de im√°genes');
                // Si el prompt cambi√≥, limpiar historial anterior
                appState.imageHistory = [];
            }
            
            appState.currentPromptHash = promptHash;
            
            // A√±adir imagen al historial
            const imageData = {
                ...imageResult,
                timestamp: Date.now(),
                id: `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
            };
            
            appState.imageHistory.push(imageData);
            
            // Ocultar placeholder y mostrar galer√≠a
            placeholder.classList.add('hidden');
            gallery.classList.remove('hidden');
            controls.classList.remove('hidden');
            clearBtn.classList.remove('hidden');
            
            // Renderizar galer√≠a completa
            renderImageGallery();
            
            status.innerHTML = `üé® Imagen ${appState.imageHistory.length} generada: ${imageResult.width}x${imageResult.height} | Seed: ${imageResult.seed} | API: ${imageResult.api}`;
            status.classList.remove('hidden');
        }

        // Renderizar galer√≠a de im√°genes
        function renderImageGallery() {
            const gallery = document.getElementById('imageGallery');
            
            if (appState.imageHistory.length === 0) {
                gallery.innerHTML = '';
                return;
            }
            
            // Agrupar im√°genes en filas de m√°ximo 3
            const imagesPerRow = 3;
            let galleryHTML = '';
            
            // Informaci√≥n del prompt actual
            const currentPrompt = appState.imageHistory[0]?.prompt || '';
            galleryHTML += `
                <div class="mb-4 p-3 bg-gray-900/50 rounded-lg border border-purple-500/30">
                    <h4 class="text-sm font-medium text-purple-300 mb-2">üìù Prompt actual (${appState.imageHistory.length} variaciones):</h4>
                    <p class="text-xs text-gray-300 font-mono leading-relaxed">${currentPrompt}</p>
                </div>
            `;
            
            // Generar filas de im√°genes
            for (let i = 0; i < appState.imageHistory.length; i += imagesPerRow) {
                const rowImages = appState.imageHistory.slice(i, i + imagesPerRow);
                
                galleryHTML += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-3">';
                
                rowImages.forEach((imageData, index) => {
                    const globalIndex = i + index;
                    galleryHTML += `
                        <div class="relative group">
                            <img src="${imageData.url}" 
                                 alt="Imagen IA ${globalIndex + 1}" 
                                 class="w-full h-32 object-cover rounded-lg border border-gray-600 transition-all duration-300 hover:border-purple-500 cursor-pointer"
                                 onclick="openImageModal('${imageData.id}')"
                                 onload="this.style.opacity='1'" 
                                 style="opacity:0;">
                            
                            <!-- Overlay con informaci√≥n -->
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/70 transition-all duration-300 rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100">
                                <div class="text-center text-white">
                                    <p class="text-xs font-medium">#${globalIndex + 1}</p>
                                    <p class="text-xs">API: ${imageData.api}</p>
                                    <p class="text-xs">Seed: ${imageData.seed}</p>
                                    <div class="flex gap-1 mt-2">
                                        <button onclick="previewImage('${imageData.id}')" class="px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-xs">
                                            üëÅÔ∏è
                                        </button>
                                        <button onclick="regenerateFromImage('${imageData.id}')" class="px-2 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs">
                                            üîÑ
                                        </button>
                                        <button onclick="removeImage('${imageData.id}')" class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">
                                            ‚ùå
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Indicador de n√∫mero -->
                            <div class="absolute top-2 left-2 bg-black/70 backdrop-blur-sm rounded px-2 py-1">
                                <p class="text-xs text-green-300">#${globalIndex + 1}</p>
                            </div>
                            
                            <!-- Indicador de API -->
                            <div class="absolute top-2 right-2 bg-black/70 backdrop-blur-sm rounded px-2 py-1">
                                <p class="text-xs text-blue-300">${imageData.api}</p>
                            </div>
                        </div>
                    `;
                });
                
                galleryHTML += '</div>';
            }
            
            gallery.innerHTML = galleryHTML;
        }

        // Actualizar vista previa del prompt
        function updatePromptPreview() {
            if (!appState.useImageAI) return;
            
            const narrative = appState.generatedNarrative;
            if (!narrative) return;
            
            const element1 = document.getElementById('element1');
            const element2 = document.getElementById('element2');
            const element3 = document.getElementById('element3');
            
            const customElements = [
                element1 ? element1.value.trim() : '',
                element2 ? element2.value.trim() : '',
                element3 ? element3.value.trim() : ''
            ].filter(Boolean);
            
            const prompt = createImagePrompt(narrative, customElements);
            const promptText = document.getElementById('promptText');
            const promptPreview = document.getElementById('promptPreview');
            
            if (promptText) {
                promptText.textContent = prompt;
            }
            
            if (promptPreview) {
                promptPreview.classList.remove('hidden');
            }
        }

        // Manejar generaci√≥n principal
        async function handleGeneration() {
            if (appState.isGenerating) return;
            
            const generateBtn = document.getElementById('generateBtn');
            const generateBtnText = document.getElementById('generateBtnText');
            const loadingNarrative = document.getElementById('loadingNarrative');
            const narrativePlaceholder = document.getElementById('narrativePlaceholder');
            const narrativeContent = document.getElementById('narrativeContent');
            const narrativeText = document.getElementById('narrativeText');
            
            try {
                appState.isGenerating = true;
                generateBtn.disabled = true;
                generateBtnText.textContent = 'üé≠ Generando...';
                loadingNarrative.classList.remove('hidden');
                narrativePlaceholder.classList.add('hidden');
                narrativeContent.classList.add('hidden');
                
                // Verificar estado actual del checkbox
                const imageAICheckbox = document.getElementById('useImageAI');
                appState.useImageAI = imageAICheckbox.checked;
                console.log('üé® Estado imagen IA al generar:', appState.useImageAI);
                
                // Actualizar mensaje del placeholder seg√∫n el estado actual
                const placeholderMessage = document.getElementById('placeholderMessage');
                const readyMessage = document.getElementById('readyMessage');
                
                if (appState.useImageAI) {
                    if (placeholderMessage) placeholderMessage.classList.add('hidden');
                    if (readyMessage) readyMessage.classList.remove('hidden');
                } else {
                    if (placeholderMessage) placeholderMessage.classList.remove('hidden');
                    if (readyMessage) readyMessage.classList.add('hidden');
                }
                
                // Generar narrativa
                const narrative = generateNarrative();
                appState.generatedNarrative = narrative;
                
                // Mostrar narrativa
                await new Promise(resolve => setTimeout(resolve, 1500));
                loadingNarrative.classList.add('hidden');
                narrativeText.innerHTML = narrative.replace(/\n/g, '<br><br>');
                narrativeContent.classList.remove('hidden');
                
                // Actualizar vista previa del prompt
                updatePromptPreview();
                
                // Generar imagen si est√° activada
                if (appState.useImageAI) {
                    console.log('‚úÖ Iniciando generaci√≥n de imagen...');
                    const loadingImage = document.getElementById('loadingImage');
                    const imagePlaceholder = document.getElementById('imagePlaceholder');
                    const gallery = document.getElementById('imageGallery');
                    
                    // Determinar si mostrar loading en placeholder o galer√≠a
                    const showInGallery = appState.imageHistory.length > 0;
                    
                    if (!showInGallery) {
                        imagePlaceholder.classList.add('hidden');
                    } else {
                        gallery.classList.remove('hidden');
                    }
                    
                    loadingImage.classList.remove('hidden');
                    
                    try {
                        const customElements = [
                            document.getElementById('element1')?.value?.trim() || '',
                            document.getElementById('element2')?.value?.trim() || '',
                            document.getElementById('element3')?.value?.trim() || ''
                        ].filter(Boolean);
                        
                        const imagePrompt = createImagePrompt(narrative, customElements);
                        const imageResult = await generatePerchanceImage(imagePrompt);
                        
                        loadingImage.classList.add('hidden');
                        displayImage(imageResult);
                        console.log('‚úÖ Imagen generada exitosamente con API:', imageResult.api);
                        
                    } catch (error) {
                        console.error('‚ùå Error generando imagen:', error);
                        loadingImage.classList.add('hidden');
                        
                        if (!showInGallery) {
                            imagePlaceholder.classList.remove('hidden');
                            const placeholder = document.getElementById('imagePlaceholder');
                            placeholder.innerHTML = `
                                <div class="flex items-center justify-center h-64 bg-red-900/20 rounded-lg border border-red-500/50">
                                    <div class="text-center text-red-300">
                                        <div class="text-4xl mb-2">‚ùå</div>
                                        <p class="text-sm">Error generando imagen IA</p>
                                        <p class="text-xs mt-1 opacity-75">${error.message}</p>
                                        <div class="mt-3 space-x-2">
                                            <button onclick="regenerateImage()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-sm">
                                                üîÑ Reintentar
                                            </button>
                                            <button onclick="showTroubleshooting()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                                                üõ†Ô∏è Ayuda
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            // Mostrar error en la galer√≠a existente
                            alert('Error generando imagen: ' + error.message);
                        }
                    }
                } else {
                    console.log('‚ÑπÔ∏è Imagen IA desactivada, solo generando narrativa');
                }
                
            } catch (error) {
                console.error('‚ùå Error en la generaci√≥n:', error);
                alert('Error: ' + error.message);
                loadingNarrative.classList.add('hidden');
                narrativePlaceholder.classList.remove('hidden');
            } finally {
                appState.isGenerating = false;
                generateBtn.disabled = false;
                generateBtnText.textContent = 'üé≠ Generar Narrativa √âpica';
            }
        }

        // Funciones globales para controles de imagen
        window.setAspectRatio = function(width, height) {
            document.getElementById('imageWidth').value = width;
            document.getElementById('imageHeight').value = height;
            updatePromptPreview();
        };

        window.randomizeSeed = function() {
            const randomSeed = Math.floor(Math.random() * 1000000);
            document.getElementById('imageSeed').value = randomSeed;
        };

        window.regenerateImage = async function() {
            if (!appState.generatedNarrative) {
                alert('Genera una narrativa primero.');
                return;
            }
            
            const loadingImage = document.getElementById('loadingImage');
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            const gallery = document.getElementById('imageGallery');
            
            // Mostrar loading
            const showInGallery = appState.imageHistory.length > 0;
            if (!showInGallery) {
                imagePlaceholder.classList.add('hidden');
            }
            loadingImage.classList.remove('hidden');
            
            try {
                let imagePrompt;
                
                // Si hay un prompt guardado, usarlo, sino crear uno nuevo
                if (appState.currentImagePrompt) {
                    imagePrompt = appState.currentImagePrompt;
                    console.log('üîÑ Usando prompt existente para variaci√≥n');
                } else {
                    const customElements = [
                        document.getElementById('element1')?.value?.trim() || '',
                        document.getElementById('element2')?.value?.trim() || '',
                        document.getElementById('element3')?.value?.trim() || ''
                    ].filter(Boolean);
                    
                    imagePrompt = createImagePrompt(appState.generatedNarrative, customElements);
                    console.log('üÜï Creando nuevo prompt');
                }
                
                const imageResult = await generatePerchanceImage(imagePrompt);
                
                loadingImage.classList.add('hidden');
                displayImage(imageResult);
                
                console.log(`‚úÖ Variaci√≥n generada. Total de im√°genes: ${appState.imageHistory.length}`);
                
            } catch (error) {
                console.error('‚ùå Error regenerando imagen:', error);
                loadingImage.classList.add('hidden');
                
                if (!showInGallery) {
                    imagePlaceholder.classList.remove('hidden');
                }
                
                alert('Error regenerando imagen: ' + error.message);
            }
        };

        // Funciones para gesti√≥n de galer√≠a de im√°genes
        window.clearImageHistory = function() {
            if (confirm('¬øSeguro que quieres limpiar toda la galer√≠a de im√°genes?')) {
                appState.imageHistory = [];
                appState.currentPromptHash = null;
                
                const gallery = document.getElementById('imageGallery');
                const placeholder = document.getElementById('imagePlaceholder');
                const controls = document.getElementById('imageControls');
                const clearBtn = document.getElementById('clearHistoryBtn');
                const status = document.getElementById('imageStatus');
                
                gallery.classList.add('hidden');
                placeholder.classList.remove('hidden');
                controls.classList.add('hidden');
                clearBtn.classList.add('hidden');
                status.classList.add('hidden');
                
                console.log('üóëÔ∏è Galer√≠a de im√°genes limpiada');
            }
        };

        window.openImageModal = function(imageId) {
            const imageData = appState.imageHistory.find(img => img.id === imageId);
            if (!imageData) return;
            
            // Crear modal simple
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            modal.onclick = () => document.body.removeChild(modal);
            
            modal.innerHTML = `
                <div class="max-w-4xl max-h-full bg-gray-800 rounded-lg overflow-hidden" onclick="event.stopPropagation()">
                    <div class="p-4 border-b border-gray-600">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-purple-400">üé® Imagen IA - Detalles</h3>
                            <button onclick="document.body.removeChild(document.querySelector('.fixed'))" class="text-gray-400 hover:text-white">‚úï</button>
                        </div>
                    </div>
                    <div class="p-4">
                        <img src="${imageData.url}" alt="Imagen IA" class="w-full rounded-lg mb-4">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-purple-300 font-medium">Dimensiones:</p>
                                <p class="text-gray-300">${imageData.width}x${imageData.height}</p>
                            </div>
                            <div>
                                <p class="text-purple-300 font-medium">API:</p>
                                <p class="text-gray-300">${imageData.api}</p>
                            </div>
                            <div>
                                <p class="text-purple-300 font-medium">Seed:</p>
                                <p class="text-gray-300">${imageData.seed}</p>
                            </div>
                            <div>
                                <p class="text-purple-300 font-medium">Generado:</p>
                                <p class="text-gray-300">${new Date(imageData.timestamp).toLocaleString('es-ES')}</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-purple-300 font-medium mb-2">Prompt:</p>
                            <p class="text-gray-300 text-xs font-mono bg-gray-900/50 p-3 rounded leading-relaxed">${imageData.prompt}</p>
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="regenerateFromImage('${imageData.id}')" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm">
                                üîÑ Crear Variaci√≥n
                            </button>
                            <button onclick="downloadCompleteProject()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-sm">
                                üì¶ Descargar Proyecto
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };

        window.downloadSingleImage = async function(imageId) {
            const imageData = appState.imageHistory.find(img => img.id === imageId);
            if (!imageData) return;
            
            try {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `narrativAI-imagen-${appState.imageHistory.indexOf(imageData) + 1}-${Date.now()}.jpg`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 'image/jpeg', 0.95);
                };
                
                img.onerror = function() {
                    const link = document.createElement('a');
                    link.href = imageData.url;
                    link.download = `narrativAI-imagen-${appState.imageHistory.indexOf(imageData) + 1}-${Date.now()}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                
                img.src = imageData.url;
                
            } catch (error) {
                console.error('Error descargando imagen:', error);
                const link = document.createElement('a');
                link.href = imageData.url;
                link.download = `narrativAI-imagen-${appState.imageHistory.indexOf(imageData) + 1}-${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        window.removeImage = function(imageId) {
            if (confirm('¬øEliminar esta imagen de la galer√≠a?')) {
                appState.imageHistory = appState.imageHistory.filter(img => img.id !== imageId);
                
                if (appState.imageHistory.length === 0) {
                    clearImageHistory();
                } else {
                    renderImageGallery();
                }
            }
        };

        window.regenerateFromImage = async function(imageId) {
            const imageData = appState.imageHistory.find(img => img.id === imageId);
            if (!imageData) return;
            
            // Usar el mismo prompt para regenerar
            appState.currentImagePrompt = imageData.prompt;
            
            // Cerrar modal si est√° abierto
            const modal = document.querySelector('.fixed');
            if (modal) document.body.removeChild(modal);
            
            // Regenerar imagen
            await regenerateImage();
        };

        // Funci√≥n para convertir imagen a blob JPG
        async function convertImageToJPG(imageUrl, filename) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        // Fondo blanco para JPG
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        
                        canvas.toBlob(function(blob) {
                            resolve({ blob, filename });
                        }, 'image/jpeg', 0.95);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                img.onerror = function() {
                    // Fallback: intentar fetch directo
                    fetch(imageUrl)
                        .then(response => response.blob())
                        .then(blob => resolve({ blob, filename }))
                        .catch(reject);
                };
                
                img.src = imageUrl;
            });
        }

        // Funci√≥n principal para descargar proyecto completo
        window.downloadCompleteProject = async function() {
            if (!appState.generatedNarrative) {
                alert('Genera una narrativa primero para descargar el proyecto.');
                return;
            }
            
            const downloadBtn = document.querySelector('[onclick="downloadCompleteProject()"]') || 
                               document.getElementById('downloadZipBtn');
            
            let originalText = 'üì¶ Descargar Proyecto (.zip)'; // Valor por defecto
            
            if (downloadBtn) {
                originalText = downloadBtn.textContent;
                downloadBtn.textContent = 'üì¶ Creando ZIP...';
                downloadBtn.disabled = true;
            }
            
            try {
                const zip = new JSZip();
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');
                
                // 1. Crear archivo Markdown con la narrativa y configuraci√≥n
                const markdownContent = generateMarkdownContent();
                zip.file('narrativa.md', markdownContent);
                
                // 2. A√±adir im√°genes si existen
                if (appState.imageHistory.length > 0) {
                    console.log('üì∏ A√±adiendo ' + appState.imageHistory.length + ' im√°genes al ZIP...');
                    
                    const imagePromises = appState.imageHistory.map(async (imageData, index) => {
                        try {
                            const filename = 'imagen-' + String(index + 1).padStart(2, '0') + '.jpg';
                            const result = await convertImageToJPG(imageData.url, filename);
                            zip.file(filename, result.blob);
                            console.log('‚úÖ Imagen ' + (index + 1) + ' a√±adida: ' + filename);
                            return true;
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Error a√±adiendo imagen ' + (index + 1) + ':', error);
                            return false;
                        }
                    });
                    
                    await Promise.all(imagePromises);
                }
                
                // 3. A√±adir archivo README con informaci√≥n del proyecto
                const readmeContent = generateReadmeContent();
                zip.file('README.txt', readmeContent);
                
                // 4. Generar y descargar ZIP
                console.log('üì¶ Generando archivo ZIP...');
                const zipBlob = await zip.generateAsync({ 
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });
                
                // Descargar ZIP
                const url = URL.createObjectURL(zipBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'narrativAI-proyecto-' + timestamp + '.zip';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ Proyecto descargado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error creando proyecto ZIP:', error);
                alert('Error creando el archivo ZIP: ' + error.message);
            } finally {
                if (downloadBtn) {
                    downloadBtn.textContent = originalText;
                    downloadBtn.disabled = false;
                }
            }
        };

        // Generar contenido Markdown
        function generateMarkdownContent() {
            const element1 = document.getElementById('element1');
            const element2 = document.getElementById('element2');
            const element3 = document.getElementById('element3');
            
            const customElements = [
                element1 ? element1.value || 'No especificado' : 'No especificado',
                element2 ? element2.value || 'No especificado' : 'No especificado',
                element3 ? element3.value || 'No especificado' : 'No especificado'
            ];
            
            const artStyleElement = document.getElementById('artStyle');
            const imageWidthElement = document.getElementById('imageWidth');
            const imageHeightElement = document.getElementById('imageHeight');
            const aiModelElement = document.getElementById('aiModel');
            const detailLevelElement = document.getElementById('detailLevel');
            const compositionElement = document.getElementById('imageComposition');
            const structureElement = document.getElementById('sceneStructure');
            const lightingElement = document.getElementById('lighting');
            
            var markdownContent = '# üé≠ Narrativa √âpica - narrativAI\n\n';
            markdownContent += '**Proyecto generado el:** ' + new Date().toLocaleString('es-ES') + '\n\n';
            markdownContent += '## üìñ Tu Historia √âpica\n\n';
            markdownContent += appState.generatedNarrative + '\n\n';
            markdownContent += '## ‚öñÔ∏è Configuraci√≥n de G√©neros\n\n';
            markdownContent += '**G√©neros seleccionados:** ' + appState.selectedGenres.map(id => genres[id].icon + ' ' + genres[id].name + ' (' + (appState.genreIntensities[id] || 70) + '%)').join(', ') + '\n\n';
            markdownContent += '## üéØ Elementos Personalizados\n\n';
            markdownContent += '- **üéØ Principal:** ' + customElements[0] + '\n';
            markdownContent += '- **üî∏ Secundario:** ' + customElements[1] + '\n';
            markdownContent += '- **üèõÔ∏è Contexto:** ' + customElements[2] + '\n\n';
            
            if (appState.currentImagePrompt) {
                markdownContent += '## üé® Configuraci√≥n de Imagen IA\n\n';
                markdownContent += '**Total de im√°genes generadas:** ' + appState.imageHistory.length + '\n\n';
                markdownContent += '**Prompt utilizado:**\n```\n' + appState.currentImagePrompt + '\n```\n\n';
                markdownContent += '**Configuraci√≥n t√©cnica:**\n';
                markdownContent += '- Estilo art√≠stico: ' + (artStyleElement && artStyleElement.selectedOptions[0] ? artStyleElement.selectedOptions[0].text : 'Autom√°tico') + '\n';
                markdownContent += '- Dimensiones: ' + (imageWidthElement ? imageWidthElement.value : '1024') + 'x' + (imageHeightElement ? imageHeightElement.value : '768') + '\n';
                markdownContent += '- Modelo IA: ' + (aiModelElement && aiModelElement.selectedOptions[0] ? aiModelElement.selectedOptions[0].text : 'Standard') + '\n';
                markdownContent += '- Nivel de detalle: ' + (detailLevelElement && detailLevelElement.selectedOptions[0] ? detailLevelElement.selectedOptions[0].text : 'Medio') + '\n';
                markdownContent += '- Composici√≥n: ' + (compositionElement && compositionElement.selectedOptions[0] ? compositionElement.selectedOptions[0].text : 'Autom√°tica') + '\n';
                markdownContent += '- Estructura: ' + (structureElement && structureElement.selectedOptions[0] ? structureElement.selectedOptions[0].text : 'Autom√°tica') + '\n';
                markdownContent += '- Iluminaci√≥n: ' + (lightingElement && lightingElement.selectedOptions[0] ? lightingElement.selectedOptions[0].text : 'Autom√°tica') + '\n\n';
                markdownContent += '**Im√°genes incluidas:**\n';
                markdownContent += appState.imageHistory.map((img, index) => '- imagen-' + String(index + 1).padStart(2, '0') + '.jpg (' + img.width + 'x' + img.height + ', API: ' + img.api + ', Seed: ' + img.seed + ')').join('\n');
            } else {
                markdownContent += '## üé® Configuraci√≥n de Imagen IA\n\nNo se generaron im√°genes para este proyecto.';
            }
            
            markdownContent += '\n\n---\n\n*Generado con ‚ù§Ô∏è por **narrativAI*** üé≠‚ú®  \n*Sistema de narrativas √©picas con IA - Versi√≥n GitHub Pages*  \n*Proyecto completo exportado con todas las im√°genes y configuraciones*\n';
            
            return markdownContent;
        }

        // Generar contenido README
        function generateReadmeContent() {
            var readmeContent = 'üì¶ PROYECTO NARRATIVAI - INFORMACI√ìN\n';
            readmeContent += '=====================================\n\n';
            readmeContent += 'üé≠ Contenido del proyecto:\n';
            readmeContent += '- narrativa.md: Historia √©pica generada con configuraci√≥n completa\n';
            readmeContent += appState.imageHistory.length > 0 ? '- imagen-01.jpg a imagen-' + String(appState.imageHistory.length).padStart(2, '0') + '.jpg: Im√°genes IA generadas\n' : '- No se incluyeron im√°genes\n';
            readmeContent += '- README.txt: Este archivo con informaci√≥n del proyecto\n\n';
            readmeContent += 'üìä Estad√≠sticas:\n';
            readmeContent += '- Narrativa: ' + (appState.generatedNarrative ? 'Incluida' : 'No generada') + '\n';
            readmeContent += '- G√©neros: ' + appState.selectedGenres.length + '/3 seleccionados\n';
            readmeContent += '- Elementos personalizados: 3 configurados\n';
            readmeContent += '- Im√°genes IA: ' + appState.imageHistory.length + ' generadas\n';
            readmeContent += '- Fecha de creaci√≥n: ' + new Date().toLocaleString('es-ES') + '\n\n';
            readmeContent += 'üîß Configuraci√≥n utilizada:\n';
            readmeContent += '- G√©neros: ' + appState.selectedGenres.map(id => genres[id].name).join(', ') + '\n';
            readmeContent += '- Imagen IA: ' + (appState.useImageAI ? 'Activada' : 'Desactivada') + '\n';
            if (appState.currentImagePrompt) {
                readmeContent += '- Prompt de imagen: "' + appState.currentImagePrompt.substring(0, 100) + '..."\n';
            }
            readmeContent += '\nüé® Herramienta: narrativAI (GitHub Pages Edition)\n';
            readmeContent += 'üîó Sistema de narrativas √©picas con IA integrada\n';
            readmeContent += '‚ú® Proyecto exportado autom√°ticamente\n\n';
            readmeContent += '¬°Gracias por usar narrativAI! üé≠\n';
            
            return readmeContent;
        }

        window.previewImage = function(imageId) {
            openImageModal(imageId);
        };



        window.showTroubleshooting = function() {
            const troubleshootingText = `üõ†Ô∏è Soluci√≥n de problemas - Imagen IA

‚ùå **Problema**: APIs de imagen no responden desde GitHub Pages

‚úÖ **SOLUCIONES MEJORADAS**:

1. üîÑ **Reintentar** (15s timeout): Sistema con 3 APIs de respaldo
2. üìê **Dimensiones menores**: Prueba 512x512 (m√°s r√°pido)
3. üé® **Prompt simple**: Reduce palabras complejas
4. üé≤ **Nueva semilla**: Bot√≥n aleatorio para cambiar par√°metros
5. ‚è±Ô∏è **Esperar**: A veces las APIs tardan en responder

üîß **APIs optimizadas**:
- ‚úÖ Pollinations.ai (principal - m√°s estable)
- ‚úÖ ImageAI (respaldo alternativo)  
- ‚úÖ Placeholder visual (siempre funciona)

üöÄ **GitHub Pages**: Sistema optimizado para funcionar sin backend

üí° **Nota**: Si todas las APIs fallan, se crear√° una imagen informativa con tu prompt`;
            
            alert(troubleshootingText);
        };



        // Funci√≥n para configurar event listeners de forma segura
        function setupEventListeners() {
            // Event listener para imagen IA
            const useImageAICheckbox = document.getElementById('useImageAI');
            if (useImageAICheckbox) {
                useImageAICheckbox.addEventListener('change', (e) => {
                    appState.useImageAI = e.target.checked;
                    const info = document.getElementById('imageAIInfo');
                    const controlsSection = document.getElementById('imageControlsSection');
                    const promptPreview = document.getElementById('promptPreview');
                    const placeholderMessage = document.getElementById('placeholderMessage');
                    const readyMessage = document.getElementById('readyMessage');
                    
                    console.log('üé® Imagen IA activada:', appState.useImageAI);
                    
                    if (appState.useImageAI) {
                        if (info) info.classList.remove('hidden');
                        if (controlsSection) controlsSection.classList.remove('hidden');
                        
                        // Actualizar mensaje del placeholder
                        if (placeholderMessage) placeholderMessage.classList.add('hidden');
                        if (readyMessage) readyMessage.classList.remove('hidden');
                        
                        // Si ya hay narrativa, actualizar preview inmediatamente
                        if (appState.generatedNarrative) {
                            updatePromptPreview();
                        }
                    } else {
                        if (info) info.classList.add('hidden');
                        if (controlsSection) controlsSection.classList.add('hidden');
                        if (promptPreview) promptPreview.classList.add('hidden');
                        
                        // Restaurar mensaje original del placeholder
                        if (placeholderMessage) placeholderMessage.classList.remove('hidden');
                        if (readyMessage) readyMessage.classList.add('hidden');
                    }
                });
            }

            // Event listeners para actualizar preview
            ['artStyle', 'detailLevel', 'promptStrength', 'enhancePrompt', 'imageWidth', 'imageHeight', 'imageComposition', 'sceneStructure', 'lighting'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updatePromptPreview);
                    element.addEventListener('input', updatePromptPreview);
                }
            });

            // Event listeners para botones principales
            const generateBtn = document.getElementById('generateBtn');
            const downloadZipBtn = document.getElementById('downloadZipBtn');
            const regenerateBtn = document.getElementById('regenerateBtn');
            
            if (generateBtn) {
                generateBtn.addEventListener('click', handleGeneration);
            }
            
            if (downloadZipBtn) {
                downloadZipBtn.addEventListener('click', downloadCompleteProject);
            }
            
            if (regenerateBtn) {
                regenerateBtn.addEventListener('click', handleGeneration);
            }
        }

        // Inicializaci√≥n
        function initializeApp() {
            try {
                createGenreElements();
                updateGenreCount();
                
                // Configurar event listeners
                setupEventListeners();
                
                // Verificar estado inicial del checkbox
                const useImageAICheckbox = document.getElementById('useImageAI');
                if (useImageAICheckbox) {
                    const initialImageAIState = useImageAICheckbox.checked;
                    appState.useImageAI = initialImageAIState;
                    
                    if (initialImageAIState) {
                        const imageAIInfo = document.getElementById('imageAIInfo');
                        const imageControlsSection = document.getElementById('imageControlsSection');
                        const placeholderMessage = document.getElementById('placeholderMessage');
                        const readyMessage = document.getElementById('readyMessage');
                        
                        if (imageAIInfo) imageAIInfo.classList.remove('hidden');
                        if (imageControlsSection) imageControlsSection.classList.remove('hidden');
                        if (placeholderMessage) placeholderMessage.classList.add('hidden');
                        if (readyMessage) readyMessage.classList.remove('hidden');
                    }
                }
                
                console.log('üé≠ narrativAI con APIs optimizadas inicializado correctamente');
                console.log('‚úÖ Sistema 100% compatible con GitHub Pages');
                console.log('üé® Estado inicial imagen IA:', appState.useImageAI);
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
            }
        }

        // Inicializar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
