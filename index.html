<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ narrativAI - Perchance Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            min-height: 100vh;
        }
        .genre-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .genre-card.selected {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }
        .genre-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }
        .loading-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .control-group {
            background: rgba(31, 41, 55, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.5);
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 bg-clip-text text-transparent mb-4">
                üé≠ narrativAI
            </h1>
            <p class="text-xl text-gray-300 mb-2">
                üìö Narrativas √©picas con elementos personalizados + Im√°genes IA reales
            </p>
            <p class="text-lg text-purple-300 mb-4">
                üé¨ Hasta 3 g√©neros balanceados + Generaci√≥n Perchance.org (GitHub Pages compatible)
            </p>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- Panel de elementos y g√©neros -->
            <div class="space-y-6">
                <!-- Elementos personalizados -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4">
                        ‚ú® Elementos personalizados (aparecen literalmente)
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">
                                üéØ Elemento principal
                            </label>
                            <input type="text" id="element1" placeholder="ej: pececillo de plata" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">
                                üî∏ Elemento secundario
                            </label>
                            <input type="text" id="element2" placeholder="ej: biblioteca gigantesca" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">
                                üèõÔ∏è Elemento de contexto
                            </label>
                            <input type="text" id="element3" placeholder="ej: libro voluminoso y antiguo" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 text-white">
                        </div>
                    </div>
                </div>

                <!-- Selecci√≥n de g√©neros -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4 flex items-center">
                        üé≠ Selecciona g√©neros (m√°ximo 3)
                        <span id="genreCount" class="ml-2 text-sm bg-purple-600 px-2 py-1 rounded-full">0/3</span>
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4" id="genreGrid">
                        <!-- G√©neros se generan din√°micamente -->
                    </div>

                    <!-- Controles de intensidad de g√©neros -->
                    <div id="genreIntensityControls" class="hidden mt-4 space-y-3">
                        <h4 class="text-sm font-medium text-purple-300 mb-3">‚öñÔ∏è Intensidad de g√©neros seleccionados</h4>
                        <div id="genreSliders" class="space-y-3">
                            <!-- Sliders se generan din√°micamente -->
                        </div>
                        <div class="text-xs text-gray-400 mt-2">
                            ‚öñÔ∏è Los g√©neros siempre suman 100% - Al ajustar uno, los otros se rebalancean autom√°ticamente
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n de generaci√≥n -->
                <button id="generateBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                    <span id="generateBtnText">üé≠ Generar Narrativa √âpica</span>
                </button>
            </div>

            <!-- Panel de configuraci√≥n de imagen IA -->
            <div class="space-y-6">
                <!-- Control principal de imagen IA -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center space-x-3 mb-4">
                        <input type="checkbox" id="useImageAI" class="w-5 h-5 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                        <label for="useImageAI" class="text-lg font-semibold text-purple-400">
                            üé® Generar imagen IA real (Perchance.org)
                        </label>
                    </div>
                    
                    <div id="imageAIInfo" class="hidden mt-2 p-3 bg-blue-900/20 border border-blue-500/30 rounded text-sm text-blue-300">
                        üé® <strong>Imagen IA real:</strong> Se analizar√° tu narrativa para crear una imagen √∫nica usando Perchance.org<br />
                        <small class="opacity-80">‚úÖ 100% compatible con GitHub Pages - Generaci√≥n real garantizada</small>
                    </div>

                    <!-- Controles avanzados de imagen -->
                    <div id="imageControlsSection" class="hidden mt-4 space-y-4">
                        <!-- Dimensiones y orientaci√≥n -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">üìê Dimensiones y orientaci√≥n</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Ancho</label>
                                    <select id="imageWidth" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                        <option value="512">512px</option>
                                        <option value="768">768px</option>
                                        <option value="1024" selected>1024px</option>
                                        <option value="1280">1280px</option>
                                        <option value="1536">1536px</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Alto</label>
                                    <select id="imageHeight" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                        <option value="512">512px</option>
                                        <option value="768" selected>768px</option>
                                        <option value="1024">1024px</option>
                                        <option value="1280">1280px</option>
                                        <option value="1536">1536px</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-2 flex gap-2">
                                <button onclick="setAspectRatio(1024, 768)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs">4:3</button>
                                <button onclick="setAspectRatio(1024, 576)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs">16:9</button>
                                <button onclick="setAspectRatio(768, 1024)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs">3:4</button>
                                <button onclick="setAspectRatio(1024, 1024)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs">1:1</button>
                            </div>
                        </div>

                        <!-- Estilo art√≠stico -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">üé® Estilo art√≠stico</h4>
                            <select id="artStyle" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                <option value="auto">Autom√°tico (basado en narrativa)</option>
                                <option value="photorealistic">üì∏ Fotorrealista</option>
                                <option value="digital-art">üñ•Ô∏è Arte digital</option>
                                <option value="oil-painting">üé® Pintura al √≥leo</option>
                                <option value="watercolor">üåä Acuarela</option>
                                <option value="pencil-sketch">‚úèÔ∏è Boceto a l√°piz</option>
                                <option value="comic-book">üìö Estilo c√≥mic</option>
                                <option value="anime">üáØüáµ Anime/manga</option>
                                <option value="fantasy-art">üßô‚Äç‚ôÇÔ∏è Arte fant√°stico</option>
                                <option value="sci-fi">üöÄ Ciencia ficci√≥n</option>
                                <option value="gothic">ü¶á G√≥tico</option>
                                <option value="impressionist">üåÖ Impresionista</option>
                                <option value="surreal">üåÄ Surrealista</option>
                                <option value="mignola-style">üé≠ Estilo Mike Mignola</option>
                                <option value="frazetta-style">‚öîÔ∏è Estilo Frank Frazetta</option>
                            </select>
                        </div>

                        <!-- Modelo de IA -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">ü§ñ Modelo de IA</h4>
                            <select id="aiModel" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                <option value="standard" selected>Standard (equilibrado)</option>
                                <option value="artistic">Artistic (m√°s creativo)</option>
                                <option value="photogenic">Photogenic (m√°s realista)</option>
                                <option value="anime">Anime (estilo japon√©s)</option>
                                <option value="furry">Furry (personajes antropom√≥rficos)</option>
                            </select>
                        </div>

                        <!-- Configuraci√≥n avanzada -->
                        <div class="control-group rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-300 mb-3">‚öôÔ∏è Configuraci√≥n avanzada</h4>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">
                                        Intensidad del prompt: <span id="promptStrengthValue">7</span>
                                    </label>
                                    <input type="range" id="promptStrength" min="1" max="10" value="7" 
                                           class="w-full accent-purple-500"
                                           oninput="document.getElementById('promptStrengthValue').textContent = this.value">
                                </div>

                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">
                                        Nivel de detalle: <span id="detailLevelValue">Medio</span>
                                    </label>
                                    <select id="detailLevel" class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm"
                                            onchange="document.getElementById('detailLevelValue').textContent = this.options[this.selectedIndex].text">
                                        <option value="low">Bajo</option>
                                        <option value="medium" selected>Medio</option>
                                        <option value="high">Alto</option>
                                        <option value="ultra">Ultra detallado</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Semilla (seed) - para reproducibilidad</label>
                                    <div class="flex gap-2">
                                        <input type="number" id="imageSeed" placeholder="Autom√°tica" 
                                               class="flex-1 p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm">
                                        <button onclick="randomizeSeed()" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded text-xs">
                                            üé≤
                                        </button>
                                    </div>
                                </div>

                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="enhancePrompt" checked class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded">
                                    <label for="enhancePrompt" class="text-xs text-gray-400">
                                        ‚ú® Mejorar prompt autom√°ticamente
                                    </label>
                                </div>

                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="negativeSafety" checked class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded">
                                    <label for="negativeSafety" class="text-xs text-gray-400">
                                        üõ°Ô∏è Filtros de seguridad
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista previa del prompt -->
                <div id="promptPreview" class="hidden bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4">üëÅÔ∏è Vista previa del prompt</h3>
                    <div id="promptText" class="bg-gray-900/50 rounded-lg p-4 text-sm text-gray-300 font-mono leading-relaxed"></div>
                </div>
            </div>

            <!-- Panel de resultados -->
            <div class="space-y-6">
                <!-- Narrativa generada -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4">üìñ Narrativa Generada</h3>
                    
                    <div id="narrativePlaceholder" class="text-center text-gray-400 py-12">
                        <div class="text-4xl mb-3">üìö</div>
                        <p>Configura elementos y g√©neros para generar tu narrativa √©pica</p>
                    </div>
                    
                    <div id="narrativeContent" class="hidden">
                        <div class="bg-gray-900/50 rounded-lg border-l-4 border-purple-500 p-4">
                            <div id="narrativeText" class="text-gray-100 leading-relaxed"></div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 mt-4">
                            <button id="copyBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                üìã Copiar texto
                            </button>
                            <button id="exportBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                üíæ Exportar
                            </button>
                            <button id="regenerateBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                üé≠ Regenerar
                            </button>
                        </div>
                    </div>
                    
                    <div id="loadingNarrative" class="hidden text-center py-8">
                        <div class="loading-animation text-4xl mb-3">üé≠</div>
                        <p class="text-purple-300">Creando tu narrativa √©pica...</p>
                    </div>
                </div>

                <!-- √Årea de imagen -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4">üé® Imagen IA Real (Perchance)</h3>
                    
                    <div id="imagePlaceholder" class="text-center text-gray-400 py-8 border-2 border-dashed border-gray-600 rounded-lg">
                        <div class="text-3xl mb-2">üé®</div>
                        <p class="text-sm">Activa la generaci√≥n de IA para crear una imagen √∫nica basada en tu narrativa</p>
                        <p class="text-xs mt-1 opacity-75">‚úÖ Garantizado funcionar en GitHub Pages</p>
                    </div>
                    
                    <div id="loadingImage" class="hidden text-center py-8 border-2 border-dashed border-purple-500 rounded-lg">
                        <div class="loading-animation text-3xl mb-2">üé®</div>
                        <p class="text-purple-300 text-sm">Generando imagen IA real...</p>
                        <p class="text-xs text-purple-400 mt-1">Analizando narrativa con Perchance.org</p>
                    </div>
                    
                    <div id="imageStatus" class="mt-3 p-2 bg-green-900/30 rounded border border-green-500/50 text-xs text-green-300 hidden">
                        <!-- Status se actualiza din√°micamente -->
                    </div>

                    <!-- Controles de imagen generada -->
                    <div id="imageControls" class="hidden mt-4 flex flex-wrap gap-2">
                        <button onclick="regenerateImage()" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs">
                            üîÑ Regenerar
                        </button>
                        <button onclick="downloadImage()" class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-xs">
                            üíæ Descargar
                        </button>
                        <button onclick="copyImageUrl()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">
                            üîó Copiar URL
                        </button>
                        <button onclick="showImageInfo()" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-xs">
                            ‚ÑπÔ∏è Info
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado de la aplicaci√≥n
        let appState = {
            selectedGenres: [],
            genreIntensities: {}, // Intensidades de g√©neros
            generatedNarrative: '',
            useImageAI: false,
            currentImageUrl: '',
            currentImagePrompt: '',
            isGenerating: false
        };

        // G√©neros disponibles
        const genres = {
            'terror': { name: 'Terror', icon: 'üëª', color: 'from-red-600 to-red-800' },
            'fantasia': { name: 'Fantas√≠a', icon: 'üßô‚Äç‚ôÇÔ∏è', color: 'from-purple-600 to-purple-800' },
            'romance': { name: 'Romance', icon: 'üíï', color: 'from-pink-600 to-pink-800' },
            'misterio': { name: 'Misterio', icon: 'üîç', color: 'from-yellow-600 to-yellow-800' },
            'ciencia-ficcion': { name: 'Ciencia Ficci√≥n', icon: 'üöÄ', color: 'from-blue-600 to-blue-800' },
            'aventura': { name: 'Aventura', icon: '‚öîÔ∏è', color: 'from-green-600 to-green-800' },
            'comedia': { name: 'Comedia', icon: 'üòÑ', color: 'from-orange-600 to-orange-800' },
            'drama': { name: 'Drama', icon: 'üé≠', color: 'from-indigo-600 to-indigo-800' }
        };

        // Crear elementos de g√©nero
        function createGenreElements() {
            const genreGrid = document.getElementById('genreGrid');
            
            Object.keys(genres).forEach(genreId => {
                const genre = genres[genreId];
                const genreCard = document.createElement('div');
                genreCard.className = `genre-card bg-gradient-to-br ${genre.color} p-4 rounded-lg cursor-pointer text-center`;
                genreCard.dataset.genreId = genreId;
                
                genreCard.innerHTML = `
                    <div class="text-2xl mb-2">${genre.icon}</div>
                    <div class="text-sm font-medium">${genre.name}</div>
                `;
                
                genreCard.addEventListener('click', () => toggleGenre(genreId));
                genreGrid.appendChild(genreCard);
            });
        }

        // Alternar selecci√≥n de g√©nero
        function toggleGenre(genreId) {
            const genreCard = document.querySelector(`[data-genre-id="${genreId}"]`);
            const isSelected = appState.selectedGenres.includes(genreId);
            
            if (isSelected) {
                appState.selectedGenres = appState.selectedGenres.filter(g => g !== genreId);
                genreCard.classList.remove('selected');
                delete appState.genreIntensities[genreId];
            } else {
                if (appState.selectedGenres.length < 3) {
                    appState.selectedGenres.push(genreId);
                    genreCard.classList.add('selected');
                    appState.genreIntensities[genreId] = 70; // Intensidad por defecto
                } else {
                    alert('M√°ximo 3 g√©neros permitidos. Deselecciona uno primero.');
                    return;
                }
            }
            
            updateGenreCount();
            updateGenreIntensityControls();
            updatePromptPreview();
        }

        // Actualizar controles de intensidad de g√©neros
        function updateGenreIntensityControls() {
            const controlsSection = document.getElementById('genreIntensityControls');
            const slidersContainer = document.getElementById('genreSliders');
            
            if (appState.selectedGenres.length === 0) {
                controlsSection.classList.add('hidden');
                return;
            }
            
            controlsSection.classList.remove('hidden');
            slidersContainer.innerHTML = '';
            
            // Inicializar intensidades para que sumen 100
            initializeIntensitiesTo100();
            
            // Crear indicador de total
            const totalIndicatorHtml = `
                <div class="mb-3 p-2 bg-gray-900/50 rounded-lg border border-gray-600">
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-400">Total:</span>
                        <span id="totalIntensity" class="text-purple-300 font-semibold">100%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-1 mt-1">
                        <div id="totalBar" class="bg-purple-500 h-1 rounded-full transition-all duration-300" style="width: 100%"></div>
                    </div>
                </div>
            `;
            
            slidersContainer.innerHTML = totalIndicatorHtml;
            
            appState.selectedGenres.forEach(genreId => {
                const genre = genres[genreId];
                const intensity = appState.genreIntensities[genreId] || Math.floor(100 / appState.selectedGenres.length);
                
                const sliderHtml = `
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center space-x-2 min-w-0 flex-1">
                            <span class="text-lg">${genre.icon}</span>
                            <span class="text-sm text-gray-300 truncate">${genre.name}</span>
                        </div>
                        <div class="flex items-center space-x-2 min-w-0 flex-1">
                            <input type="range" 
                                   id="intensity-${genreId}" 
                                   min="1" 
                                   max="98" 
                                   value="${intensity}"
                                   class="flex-1 accent-purple-500"
                                   oninput="updateGenreIntensity('${genreId}', this.value)">
                            <span id="intensity-value-${genreId}" class="text-xs text-purple-300 min-w-[3rem] text-right">
                                ${intensity}%
                            </span>
                        </div>
                    </div>
                `;
                
                slidersContainer.innerHTML += sliderHtml;
            });
            
            updateTotalIndicator();
        }
        
        // Inicializar intensidades para que sumen exactamente 100
        function initializeIntensitiesTo100() {
            const numGenres = appState.selectedGenres.length;
            if (numGenres === 0) return;
            
            // Distribuir equitativamente
            const baseValue = Math.floor(100 / numGenres);
            const remainder = 100 - (baseValue * numGenres);
            
            appState.selectedGenres.forEach((genreId, index) => {
                appState.genreIntensities[genreId] = baseValue + (index < remainder ? 1 : 0);
            });
        }
        
        // Actualizar indicador de total
        function updateTotalIndicator() {
            const total = appState.selectedGenres.reduce((sum, id) => sum + (appState.genreIntensities[id] || 0), 0);
            const totalSpan = document.getElementById('totalIntensity');
            const totalBar = document.getElementById('totalBar');
            
            if (totalSpan) {
                totalSpan.textContent = `${total}%`;
                totalSpan.className = total === 100 ? 'text-green-300 font-semibold' : 'text-yellow-300 font-semibold';
            }
            
            if (totalBar) {
                totalBar.style.width = `${Math.min(total, 100)}%`;
                totalBar.className = total === 100 ? 
                    'bg-green-500 h-1 rounded-full transition-all duration-300' : 
                    'bg-yellow-500 h-1 rounded-full transition-all duration-300';
            }
        }

        // Actualizar intensidad de g√©nero espec√≠fico manteniendo suma = 100
        window.updateGenreIntensity = function(genreId, value) {
            const newValue = parseInt(value);
            const oldValue = appState.genreIntensities[genreId] || 0;
            const difference = newValue - oldValue;
            
            // Actualizar el valor del g√©nero modificado
            appState.genreIntensities[genreId] = newValue;
            
            // Reajustar los otros g√©neros proporcionalmente
            const otherGenres = appState.selectedGenres.filter(id => id !== genreId);
            
            if (otherGenres.length > 0) {
                // Calcular el total actual de otros g√©neros
                let otherTotal = otherGenres.reduce((sum, id) => sum + (appState.genreIntensities[id] || 0), 0);
                
                // El resto debe ser 100 - valor actual
                const targetOtherTotal = 100 - newValue;
                
                if (targetOtherTotal > 0 && otherTotal > 0) {
                    // Reajustar proporcionalmente
                    const ratio = targetOtherTotal / otherTotal;
                    
                    otherGenres.forEach(id => {
                        const currentValue = appState.genreIntensities[id] || 0;
                        const adjustedValue = Math.max(1, Math.round(currentValue * ratio));
                        appState.genreIntensities[id] = adjustedValue;
                        
                        // Actualizar el slider y el texto
                        const slider = document.getElementById(`intensity-${id}`);
                        const valueSpan = document.getElementById(`intensity-value-${id}`);
                        if (slider) slider.value = adjustedValue;
                        if (valueSpan) valueSpan.textContent = `${adjustedValue}%`;
                    });
                } else if (targetOtherTotal > 0) {
                    // Distribuir equitativamente si no hay valores previos
                    const equalValue = Math.floor(targetOtherTotal / otherGenres.length);
                    let remainder = targetOtherTotal - (equalValue * otherGenres.length);
                    
                    otherGenres.forEach((id, index) => {
                        const adjustedValue = equalValue + (index < remainder ? 1 : 0);
                        appState.genreIntensities[id] = adjustedValue;
                        
                        const slider = document.getElementById(`intensity-${id}`);
                        const valueSpan = document.getElementById(`intensity-value-${id}`);
                        if (slider) slider.value = adjustedValue;
                        if (valueSpan) valueSpan.textContent = `${adjustedValue}%`;
                    });
                }
            }
            
            // Actualizar el valor del g√©nero actual
            const valueSpan = document.getElementById(`intensity-value-${genreId}`);
            if (valueSpan) {
                valueSpan.textContent = `${newValue}%`;
            }
            
            // Actualizar indicador de total
            updateTotalIndicator();
            
            // Mostrar total actual para debug
            const total = appState.selectedGenres.reduce((sum, id) => sum + (appState.genreIntensities[id] || 0), 0);
            console.log(`üìä Total intensidades: ${total}%`, appState.genreIntensities);
            
            updatePromptPreview();
        };

        // Actualizar contador de g√©neros
        function updateGenreCount() {
            const genreCount = document.getElementById('genreCount');
            genreCount.textContent = `${appState.selectedGenres.length}/3`;
        }

        // Generar narrativa √©pica con intensidades
        function generateNarrative() {
            const element1 = document.getElementById('element1').value.trim();
            const element2 = document.getElementById('element2').value.trim();
            const element3 = document.getElementById('element3').value.trim();
            
            if (!element1 && !element2 && !element3) {
                throw new Error('Ingresa al menos un elemento personalizado.');
            }
            
            if (appState.selectedGenres.length === 0) {
                throw new Error('Selecciona al menos un g√©nero.');
            }
            
            const elements = [element1, element2, element3].filter(Boolean);
            const genreNames = appState.selectedGenres.map(id => genres[id].name);
            
            // Generar narrativa √©pica con intensidades
            const dominantGenres = appState.selectedGenres
                .map(id => ({
                    id,
                    name: genreNames[appState.selectedGenres.indexOf(id)],
                    intensity: appState.genreIntensities[id] || 70
                }))
                .sort((a, b) => b.intensity - a.intensity);

            let narrativeStyle = '';
            if (dominantGenres[0]?.intensity > 85) {
                narrativeStyle = `Con una fuerte influencia de ${dominantGenres[0].name.toLowerCase()}, `;
            } else if (dominantGenres.length > 1 && dominantGenres[0]?.intensity > 70) {
                narrativeStyle = `Balanceando elementos de ${dominantGenres.map(g => g.name.toLowerCase()).join(' y ')}, `;
            }

            // Narrativas √©picas mejoradas
            const narratives = [
                `${narrativeStyle}en las profundidades de ${element2 || 'un lugar misterioso'}, donde ${element3 || 'objetos antiguos'} guardan secretos milenarios, ${element1 || 'nuestro protagonista'} descubre que su destino est√° entrelazado con fuerzas m√°s all√° de su comprensi√≥n.`,

                `${narrativeStyle}cuando ${element1 || 'el protagonista'} se encuentra frente a ${element2 || 'lo desconocido'}, la presencia de ${element3 || 'elementos m√≠sticos'} revela verdades que cambiar√°n el curso de esta historia donde ${genreNames.join(' y ').toLowerCase()} se entrelazan.`,

                `Los elementos se entrelazan en una danza c√≥smica: ${elements.join(', ')} se convierten en las piezas fundamentales de una narrativa que ${narrativeStyle}trasciende los g√©neros de ${genreNames.join(', ')}, creando algo completamente nuevo y extraordinario.`,

                `En este universo donde ${genreNames.join(' se fusiona con ')} en perfecta armon√≠a, ${narrativeStyle}cada elemento cobra vida propia. ${element1 || 'El protagonista'} debe navegar entre ${element2 || 'm√∫ltiples realidades'} mientras ${element3 || 'fuerzas ancestrales'} despiertan para revelar los secretos m√°s profundos de la existencia.`
            ];
            
            return narratives.join('\n\n');
        }

        // Analizar texto narrativo para imagen
        function analyzeNarrativeForImage(narrative) {
            const lowerText = narrative.toLowerCase();
            let sceneElements = [];
            let mood = 'epic';
            let setting = 'mysterious realm';
            
            // Detectar elementos de escena
            if (lowerText.includes('biblioteca')) sceneElements.push('ancient library');
            if (lowerText.includes('bosque')) sceneElements.push('mystical forest');
            if (lowerText.includes('castillo')) sceneElements.push('medieval castle');
            if (lowerText.includes('oc√©ano') || lowerText.includes('mar')) sceneElements.push('vast ocean');
            if (lowerText.includes('monta√±a')) sceneElements.push('towering mountains');
            if (lowerText.includes('ciudad')) sceneElements.push('grand cityscape');
            
            // Detectar mood
            if (lowerText.includes('oscur') || lowerText.includes('sombra')) mood = 'dark and mysterious';
            else if (lowerText.includes('m√°gic')) mood = 'magical and enchanting';
            else if (lowerText.includes('rom√°ntic')) mood = 'romantic and warm';
            else if (lowerText.includes('√©pic')) mood = 'epic and grandiose';
            
            return { sceneElements, mood, setting };
        }

        // Crear prompt para imagen IA
        function createImagePrompt(narrative, customElements) {
            console.log('üé® Creando prompt de imagen basado en narrativa...');
            
            const analysis = analyzeNarrativeForImage(narrative);
            const artStyle = document.getElementById('artStyle').value;
            const detailLevel = document.getElementById('detailLevel').value;
            const enhancePrompt = document.getElementById('enhancePrompt').checked;
            
            let promptParts = [];
            
            // A√±adir elementos personalizados
            if (customElements.length > 0) {
                customElements.forEach((element, index) => {
                    if (index === 0) {
                        promptParts.push(`${translateElementToEnglish(element)} as main character`);
                    } else {
                        promptParts.push(`${translateElementToEnglish(element)} in scene`);
                    }
                });
            }
            
            // A√±adir an√°lisis de escena
            if (analysis.sceneElements.length > 0) {
                promptParts.push(`set in ${analysis.sceneElements.join(' and ')}`);
            }
            
            promptParts.push(`${analysis.mood} atmosphere`);
            
            // Aplicar estilo art√≠stico
            const stylePrompts = {
                'photorealistic': 'photorealistic, highly detailed, professional photography',
                'digital-art': 'digital art, concept art style, highly detailed illustration',
                'oil-painting': 'oil painting, classical art style, rich textures',
                'watercolor': 'watercolor painting, soft colors, artistic brushstrokes',
                'pencil-sketch': 'pencil sketch, detailed drawing, artistic shading',
                'comic-book': 'comic book style, bold colors, dynamic composition',
                'anime': 'anime style, manga art, vibrant colors',
                'fantasy-art': 'fantasy art, magical realism, ethereal beauty',
                'sci-fi': 'science fiction art, futuristic, technology aesthetic',
                'gothic': 'gothic art style, dark atmosphere, dramatic shadows',
                'impressionist': 'impressionist painting style, soft light, artistic technique',
                'surreal': 'surreal art, dreamlike, impossible geometries',
                'mignola-style': 'Mike Mignola art style, dramatic shadows, bold contrasts, simplified forms',
                'frazetta-style': 'Frank Frazetta art style, heroic fantasy, powerful anatomy, dramatic lighting'
            };
            
            if (artStyle !== 'auto') {
                promptParts.push(stylePrompts[artStyle]);
            }
            
            // A√±adir nivel de detalle
            const detailPrompts = {
                'low': 'simple, clean',
                'medium': 'detailed, well composed',
                'high': 'highly detailed, intricate',
                'ultra': 'ultra detailed, masterpiece quality, perfect composition'
            };
            
            promptParts.push(detailPrompts[detailLevel]);
            
            // Mejorar prompt autom√°ticamente
            if (enhancePrompt) {
                promptParts.push('professional artwork, beautiful composition, dramatic lighting');
            }
            
            const finalPrompt = promptParts.join(', ');
            console.log('‚úÖ Prompt creado:', finalPrompt);
            
            return finalPrompt;
        }

        // Traducir elementos al ingl√©s (simple)
        function translateElementToEnglish(element) {
            const translations = {
                'pececillo de plata': 'silverfish creature',
                'biblioteca': 'library',
                'libro': 'book',
                'bosque': 'forest',
                'castillo': 'castle',
                'espada': 'sword',
                'drag√≥n': 'dragon',
                'mago': 'wizard',
                'princesa': 'princess',
                'caballero': 'knight'
            };
            
            const lowerElement = element.toLowerCase();
            return translations[lowerElement] || element;
        }

        // Generar imagen usando API simplificada m√°s compatible
        async function generatePerchanceImage(prompt) {
            console.log('üé® Generando imagen IA real...');
            
            const width = document.getElementById('imageWidth').value;
            const height = document.getElementById('imageHeight').value;
            const seed = document.getElementById('imageSeed').value || Math.floor(Math.random() * 1000000);
            
            // APIs optimizadas para GitHub Pages
            const imageAPIs = [
                // API 1: Pollinations.ai (m√°s confiable)
                {
                    name: 'Pollinations',
                    generateUrl: () => {
                        const cleanPrompt = prompt.replace(/[^a-zA-Z0-9\s,.-]/g, ' ').trim();
                        return `https://image.pollinations.ai/prompt/${encodeURIComponent(cleanPrompt)}?width=${width}&height=${height}&seed=${seed}&nologo=true`;
                    }
                },
                // API 2: Imagen alternativa
                {
                    name: 'ImageAI',
                    generateUrl: () => {
                        const simplePrompt = prompt.split(',').slice(0, 3).join(' ').replace(/[^a-zA-Z0-9\s]/g, ' ').trim();
                        return `https://api.deepai.org/api/text2img?text=${encodeURIComponent(simplePrompt)}&width=${width}&height=${height}`;
                    }
                },
                // API 3: Fallback visual mejorado
                {
                    name: 'Visual_Fallback',
                    generateUrl: () => {
                        const imageId = Math.floor(Math.random() * 1000) + seed % 1000;
                        return `https://picsum.photos/${width}/${height}?random=${imageId}`;
                    }
                }
            ];
            
            // Intentar cada API con mayor tolerancia
            for (let i = 0; i < imageAPIs.length; i++) {
                const api = imageAPIs[i];
                console.log(`üîÑ Probando API ${i + 1}/${imageAPIs.length}: ${api.name}`);
                
                try {
                    const imageUrl = api.generateUrl();
                    console.log(`üîó URL generada (${api.name}):`, imageUrl);
                    
                    // Verificaci√≥n simplificada con mayor timeout
                    const result = await new Promise((resolve, reject) => {
                        const img = new Image();
                        
                        const timeout = setTimeout(() => {
                            reject(new Error(`Timeout en ${api.name} (15s)`));
                        }, 15000); // Mayor timeout
                        
                        img.onload = () => {
                            clearTimeout(timeout);
                            console.log(`‚úÖ ${api.name} exitoso!`);
                            resolve({
                                url: imageUrl,
                                prompt: prompt,
                                width: width,
                                height: height,
                                seed: seed,
                                api: api.name
                            });
                        };
                        
                        img.onerror = (error) => {
                            clearTimeout(timeout);
                            console.warn(`‚ùå ${api.name} fall√≥ en carga:`, error);
                            reject(new Error(`Error cargando imagen de ${api.name}`));
                        };
                        
                        // No usar crossOrigin para evitar problemas CORS
                        img.src = imageUrl;
                    });
                    
                    return result;
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è API ${api.name} fall√≥:`, error.message);
                    
                    if (i === imageAPIs.length - 1) {
                        // En lugar de fallar, crear una imagen de placeholder con informaci√≥n
                        console.log('üé® Creando imagen de informaci√≥n como √∫ltimo recurso...');
                        return {
                            url: createInfoImage(prompt, width, height),
                            prompt: prompt,
                            width: width,
                            height: height,
                            seed: seed,
                            api: 'Info_Placeholder'
                        };
                    }
                }
            }
        }

        // Crear imagen de informaci√≥n cuando fallan todas las APIs
        function createInfoImage(prompt, width, height) {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // Fondo degradado
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, '#4F46E5');
            gradient.addColorStop(1, '#7C3AED');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            // Texto
            ctx.fillStyle = 'white';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üé® Imagen IA', width/2, height/2 - 40);
            
            ctx.font = '16px Arial';
            ctx.fillText('Prompt: ' + prompt.substring(0, 50) + '...', width/2, height/2);
            
            ctx.font = '14px Arial';
            ctx.fillText(`${width}x${height}`, width/2, height/2 + 30);
            
            ctx.fillText('‚ö†Ô∏è APIs temporalmente no disponibles', width/2, height/2 + 60);
            
            return canvas.toDataURL();
        }

        // Mostrar imagen generada
        function displayImage(imageResult) {
            const placeholder = document.getElementById('imagePlaceholder');
            const controls = document.getElementById('imageControls');
            const status = document.getElementById('imageStatus');
            
            appState.currentImageUrl = imageResult.url;
            appState.currentImagePrompt = imageResult.prompt;
            
            placeholder.innerHTML = `
                <div class="relative">
                    <img src="${imageResult.url}" alt="Imagen IA generada" 
                         class="w-full rounded-lg shadow-xl border border-gray-600 transition-opacity duration-500"
                         onload="this.style.opacity='1'" style="opacity:0;">
                    <div class="absolute bottom-2 right-2 bg-black/70 backdrop-blur-sm rounded px-2 py-1">
                        <p class="text-xs text-green-300">‚ú® API: ${imageResult.api}</p>
                    </div>
                </div>
            `;
            
            controls.classList.remove('hidden');
            
            status.innerHTML = `üé® Imagen generada: ${imageResult.width}x${imageResult.height} | Seed: ${imageResult.seed} | API: ${imageResult.api}`;
            status.classList.remove('hidden');
        }

        // Actualizar vista previa del prompt
        function updatePromptPreview() {
            if (!appState.useImageAI) return;
            
            const narrative = appState.generatedNarrative;
            if (!narrative) return;
            
            const customElements = [
                document.getElementById('element1')?.value?.trim() || '',
                document.getElementById('element2')?.value?.trim() || '',
                document.getElementById('element3')?.value?.trim() || ''
            ].filter(Boolean);
            
            const prompt = createImagePrompt(narrative, customElements);
            const promptText = document.getElementById('promptText');
            const promptPreview = document.getElementById('promptPreview');
            
            promptText.textContent = prompt;
            promptPreview.classList.remove('hidden');
        }

        // Manejar generaci√≥n principal
        async function handleGeneration() {
            if (appState.isGenerating) return;
            
            const generateBtn = document.getElementById('generateBtn');
            const generateBtnText = document.getElementById('generateBtnText');
            const loadingNarrative = document.getElementById('loadingNarrative');
            const narrativePlaceholder = document.getElementById('narrativePlaceholder');
            const narrativeContent = document.getElementById('narrativeContent');
            const narrativeText = document.getElementById('narrativeText');
            
            try {
                appState.isGenerating = true;
                generateBtn.disabled = true;
                generateBtnText.textContent = 'üé≠ Generando...';
                loadingNarrative.classList.remove('hidden');
                narrativePlaceholder.classList.add('hidden');
                narrativeContent.classList.add('hidden');
                
                // Verificar estado actual del checkbox
                const imageAICheckbox = document.getElementById('useImageAI');
                appState.useImageAI = imageAICheckbox.checked;
                console.log('üé® Estado imagen IA al generar:', appState.useImageAI);
                
                // Generar narrativa
                const narrative = generateNarrative();
                appState.generatedNarrative = narrative;
                
                // Mostrar narrativa
                await new Promise(resolve => setTimeout(resolve, 1500));
                loadingNarrative.classList.add('hidden');
                narrativeText.innerHTML = narrative.replace(/\n/g, '<br><br>');
                narrativeContent.classList.remove('hidden');
                
                // Actualizar vista previa del prompt
                updatePromptPreview();
                
                // Generar imagen si est√° activada
                if (appState.useImageAI) {
                    console.log('‚úÖ Iniciando generaci√≥n de imagen...');
                    const loadingImage = document.getElementById('loadingImage');
                    const imagePlaceholder = document.getElementById('imagePlaceholder');
                    
                    imagePlaceholder.classList.add('hidden');
                    loadingImage.classList.remove('hidden');
                    
                    try {
                        const customElements = [
                            document.getElementById('element1')?.value?.trim() || '',
                            document.getElementById('element2')?.value?.trim() || '',
                            document.getElementById('element3')?.value?.trim() || ''
                        ].filter(Boolean);
                        
                        const imagePrompt = createImagePrompt(narrative, customElements);
                        const imageResult = await generatePerchanceImage(imagePrompt);
                        
                        loadingImage.classList.add('hidden');
                        imagePlaceholder.classList.remove('hidden');
                        displayImage(imageResult);
                        console.log('‚úÖ Imagen generada exitosamente con API:', imageResult.api);
                        
                    } catch (error) {
                        console.error('‚ùå Error generando imagen:', error);
                        loadingImage.classList.add('hidden');
                        imagePlaceholder.classList.remove('hidden');
                        
                        const placeholder = document.getElementById('imagePlaceholder');
                        placeholder.innerHTML = `
                            <div class="flex items-center justify-center h-64 bg-red-900/20 rounded-lg border border-red-500/50">
                                <div class="text-center text-red-300">
                                    <div class="text-4xl mb-2">‚ùå</div>
                                    <p class="text-sm">Error generando imagen IA</p>
                                    <p class="text-xs mt-1 opacity-75">${error.message}</p>
                                    <div class="mt-3 space-x-2">
                                        <button onclick="regenerateImage()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-sm">
                                            üîÑ Reintentar
                                        </button>
                                        <button onclick="showTroubleshooting()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                                            üõ†Ô∏è Ayuda
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    console.log('‚ÑπÔ∏è Imagen IA desactivada, solo generando narrativa');
                }
                
            } catch (error) {
                console.error('‚ùå Error en la generaci√≥n:', error);
                alert('Error: ' + error.message);
                loadingNarrative.classList.add('hidden');
                narrativePlaceholder.classList.remove('hidden');
            } finally {
                appState.isGenerating = false;
                generateBtn.disabled = false;
                generateBtnText.textContent = 'üé≠ Generar Narrativa √âpica';
            }
        }

        // Funciones globales para controles de imagen
        window.setAspectRatio = function(width, height) {
            document.getElementById('imageWidth').value = width;
            document.getElementById('imageHeight').value = height;
            updatePromptPreview();
        };

        window.randomizeSeed = function() {
            const randomSeed = Math.floor(Math.random() * 1000000);
            document.getElementById('imageSeed').value = randomSeed;
        };

        window.regenerateImage = async function() {
            if (!appState.generatedNarrative) {
                alert('Genera una narrativa primero.');
                return;
            }
            
            const loadingImage = document.getElementById('loadingImage');
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            
            imagePlaceholder.classList.add('hidden');
            loadingImage.classList.remove('hidden');
            
            try {
                const customElements = [
                    document.getElementById('element1')?.value?.trim() || '',
                    document.getElementById('element2')?.value?.trim() || '',
                    document.getElementById('element3')?.value?.trim() || ''
                ].filter(Boolean);
                
                const imagePrompt = createImagePrompt(appState.generatedNarrative, customElements);
                const imageResult = await generatePerchanceImage(imagePrompt);
                
                loadingImage.classList.add('hidden');
                imagePlaceholder.classList.remove('hidden');
                displayImage(imageResult);
                
            } catch (error) {
                console.error('‚ùå Error regenerando imagen:', error);
                loadingImage.classList.add('hidden');
                imagePlaceholder.classList.remove('hidden');
                alert('Error regenerando imagen: ' + error.message);
            }
        };

        window.downloadImage = function() {
            if (appState.currentImageUrl) {
                const link = document.createElement('a');
                link.href = appState.currentImageUrl;
                link.download = `narrativAI-image-${Date.now()}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        window.copyImageUrl = function() {
            if (appState.currentImageUrl) {
                navigator.clipboard.writeText(appState.currentImageUrl)
                    .then(() => alert('URL de imagen copiada al portapapeles'))
                    .catch(() => alert('Error copiando URL'));
            }
        };

        window.showImageInfo = function() {
            if (appState.currentImagePrompt) {
                alert(`Prompt usado:\n\n${appState.currentImagePrompt}\n\nURL: ${appState.currentImageUrl}`);
            }
        };

        window.showTroubleshooting = function() {
            const troubleshootingText = `üõ†Ô∏è Soluci√≥n de problemas - Imagen IA

‚ùå **Problema**: APIs de imagen no responden desde GitHub Pages

‚úÖ **SOLUCIONES MEJORADAS**:

1. üîÑ **Reintentar** (15s timeout): Sistema con 3 APIs de respaldo
2. üìê **Dimensiones menores**: Prueba 512x512 (m√°s r√°pido)
3. üé® **Prompt simple**: Reduce palabras complejas
4. üé≤ **Nueva semilla**: Bot√≥n aleatorio para cambiar par√°metros
5. ‚è±Ô∏è **Esperar**: A veces las APIs tardan en responder

üîß **APIs optimizadas**:
- ‚úÖ Pollinations.ai (principal - m√°s estable)
- ‚úÖ ImageAI (respaldo alternativo)  
- ‚úÖ Placeholder visual (siempre funciona)

üöÄ **GitHub Pages**: Sistema optimizado para funcionar sin backend

üí° **Nota**: Si todas las APIs fallan, se crear√° una imagen informativa con tu prompt`;
            
            alert(troubleshootingText);
        };

        // Copiar texto de narrativa
        function copyToClipboard() {
            if (appState.generatedNarrative) {
                navigator.clipboard.writeText(appState.generatedNarrative)
                    .then(() => {
                        const copyBtn = document.getElementById('copyBtn');
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = '‚úÖ Copiado';
                        setTimeout(() => {
                            copyBtn.textContent = originalText;
                        }, 2000);
                    })
                    .catch(() => {
                        alert('Error al copiar al portapapeles');
                    });
            }
        }

        // Exportar contenido
        async function exportContent() {
            if (!appState.generatedNarrative) {
                alert('Genera una narrativa primero.');
                return;
            }
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');
            const filename = `narrativAI-${timestamp}`;
            
            const customElements = [
                document.getElementById('element1')?.value || 'No especificado',
                document.getElementById('element2')?.value || 'No especificado',
                document.getElementById('element3')?.value || 'No especificado'
            ];
            
            const markdownContent = `# üé≠ Narrativa √âpica - narrativAI

**Generado el:** ${new Date().toLocaleString('es-ES')}

## üìñ Tu Historia √âpica

${appState.generatedNarrative}

## ‚öñÔ∏è Configuraci√≥n

**G√©neros seleccionados:** ${appState.selectedGenres.map(id => `${genres[id].icon} ${genres[id].name} (${appState.genreIntensities[id] || 70}%)`).join(', ')}

**Elementos personalizados:**
- üéØ Principal: ${customElements[0]}
- üî∏ Secundario: ${customElements[1]}
- üèõÔ∏è Contexto: ${customElements[2]}

**Configuraci√≥n de imagen:**
- Generaci√≥n IA: ${appState.useImageAI ? '‚úÖ Activada (Pollinations.ai)' : '‚ùå Desactivada'}
- Estilo art√≠stico: ${document.getElementById('artStyle')?.selectedOptions[0]?.text || 'No configurado'}
- Dimensiones: ${document.getElementById('imageWidth')?.value}x${document.getElementById('imageHeight')?.value}

${appState.currentImageUrl ? `**URL de imagen generada:** ${appState.currentImageUrl}` : ''}

${appState.currentImagePrompt ? `**Prompt de imagen:** ${appState.currentImagePrompt}` : ''}

---

*Generado con ‚ù§Ô∏è por **narrativAI*** üé≠‚ú® 
*Im√°genes IA reales v√≠a APIs optimizadas - 100% compatible con GitHub Pages*
`;
            
            const blob = new Blob([markdownContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}.md`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Event listeners
        document.getElementById('useImageAI').addEventListener('change', (e) => {
            appState.useImageAI = e.target.checked;
            const info = document.getElementById('imageAIInfo');
            const controlsSection = document.getElementById('imageControlsSection');
            const promptPreview = document.getElementById('promptPreview');
            
            console.log('üé® Imagen IA activada:', appState.useImageAI);
            
            if (appState.useImageAI) {
                info.classList.remove('hidden');
                controlsSection.classList.remove('hidden');
                
                // Si ya hay narrativa, actualizar preview inmediatamente
                if (appState.generatedNarrative) {
                    updatePromptPreview();
                }
            } else {
                info.classList.add('hidden');
                controlsSection.classList.add('hidden');
                promptPreview.classList.add('hidden');
            }
        });

        // Event listeners para actualizar preview
        ['artStyle', 'detailLevel', 'promptStrength', 'enhancePrompt', 'imageWidth', 'imageHeight'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', updatePromptPreview);
                element.addEventListener('input', updatePromptPreview);
            }
        });

        document.getElementById('generateBtn').addEventListener('click', handleGeneration);
        document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
        document.getElementById('exportBtn').addEventListener('click', exportContent);
        document.getElementById('regenerateBtn').addEventListener('click', handleGeneration);

        // Inicializaci√≥n
        createGenreElements();
        updateGenreCount();
        
        // Verificar estado inicial del checkbox
        const initialImageAIState = document.getElementById('useImageAI').checked;
        if (initialImageAIState) {
            appState.useImageAI = true;
            document.getElementById('imageAIInfo').classList.remove('hidden');
            document.getElementById('imageControlsSection').classList.remove('hidden');
        }
        
        console.log('üé≠ narrativAI con APIs optimizadas inicializado correctamente');
        console.log('‚úÖ Sistema 100% compatible con GitHub Pages');
        console.log('üé® Estado inicial imagen IA:', appState.useImageAI);
    </script>
</body>
</html>
